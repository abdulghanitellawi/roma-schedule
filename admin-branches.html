<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Roma Schedule - Branches</title>
  <link rel="icon" href="./assets/logo.webp">
  <style>
    :root{--bg:#0b1220;--panel:rgba(255,255,255,.06);--line:rgba(255,255,255,.14);--txt:#e5e7eb;--muted:#9ca3af;--accent:#d4a019;--shadow:0 18px 60px rgba(0,0,0,.35);--ok:#16a34a;--bad:#ef4444;}
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;background:radial-gradient(1200px 600px at 10% 10%, rgba(212,160,25,.16), transparent 55%),radial-gradient(900px 500px at 90% 20%, rgba(59,130,246,.14), transparent 55%),var(--bg);color:var(--txt);font-family:system-ui,"Noto Sans Arabic",Tahoma,Arial,sans-serif}
    .top{position:sticky;top:0;z-index:10;backdrop-filter:blur(10px);background:rgba(10,16,28,.55);border-bottom:1px solid var(--line)}
    .topin{max-width:1200px;margin:0 auto;padding:14px;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:10px;align-items:center}
    .brand img{width:34px;height:34px;object-fit:contain;border-radius:12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12)}
    .nav{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center}
    a.btn,button.btn{cursor:pointer;border:1px solid var(--line);background:rgba(255,255,255,.06);color:var(--txt);padding:10px 12px;border-radius:12px;font-weight:900;display:inline-flex;align-items:center;justify-content:center;gap:8px;text-decoration:none}
    .btn:hover{background:rgba(255,255,255,.09)}
    .btn.primary{border-color:rgba(212,160,25,.45);background:rgba(212,160,25,.14)}
    .btn.primary:hover{background:rgba(212,160,25,.20)}
    .btn.danger{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.12)}
    .btn.danger:hover{background:rgba(239,68,68,.16)}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px}

    .wrap{max-width:1200px;margin:0 auto;padding:14px}
    .card{border:1px solid var(--line);background:var(--panel);border-radius:18px;padding:12px;box-shadow:var(--shadow);margin-bottom:12px}
    h2{margin:0 0 10px;font-size:18px}
    .mini{color:var(--muted);font-size:12px;line-height:1.7}
    label{display:block;margin:10px 0 6px;color:var(--muted);font-size:13px}
    input,select{width:100%;padding:11px 12px;border-radius:12px;border:1px solid var(--line);background:rgba(0,0,0,.16);color:var(--txt);outline:none}
    input:focus,select:focus{border-color:rgba(212,160,25,.65);box-shadow:0 0 0 4px rgba(212,160,25,.14)}
    input[readonly]{opacity:.75; cursor:not-allowed}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1}
    .twoCol{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:900px){.twoCol{grid-template-columns:1fr}}
    table{width:100%;border-collapse:collapse;overflow:hidden;border-radius:14px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:right;font-size:13px;vertical-align:top}
    th{color:var(--muted);font-weight:900;background:rgba(255,255,255,.04)}
    .badge{display:inline-block;padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px}
    .msg{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);display:none}
    .msg.ok{display:block;border-color:rgba(22,163,74,.35);background:rgba(22,163,74,.12)}
    .msg.bad{display:block;border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.12)}

    /* ===== Modal (edit/add) ===== */
    .modalOverlay{position:fixed; inset:0; z-index:999; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; padding:14px;}
    .modalOverlay.show{display:flex}
    .modal{width:min(980px, 100%); max-height:92vh; overflow:auto; border:1px solid rgba(255,255,255,.14); background:rgba(12,18,32,.92); backdrop-filter: blur(10px); border-radius:18px; box-shadow: 0 24px 80px rgba(0,0,0,.55);}
    .modalHead{position:sticky; top:0; background:rgba(12,18,32,.95); border-bottom:1px solid rgba(255,255,255,.10); padding:12px; display:flex; align-items:center; justify-content:space-between; gap:10px; z-index:2;}
    .modalBody{padding:12px}
    .xbtn{border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); color:var(--txt); border-radius:12px; padding:10px 12px; font-weight:900; cursor:pointer}
    .xbtn:hover{background:rgba(255,255,255,.10)}
    .modalTitle{display:flex; flex-direction:column; gap:2px}

    /* ===== Days cards ===== */
    .daysGrid{display:grid;grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));gap:10px;margin-top:8px;}
    .dayCard{min-width:0;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.05);border-radius:14px;padding:10px;}
    .dayTop{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .dayName{font-weight:900;font-size:13px}
    .dayToggle{display:flex;align-items:center;gap:6px;color:var(--muted);font-size:12px;user-select:none}
    .dayToggle input{width:auto;padding:0;margin:0;accent-color:var(--accent);transform:scale(1.05)}
    .dayTimes{margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .dayTimes input[type="time"]{width:130px;max-width:100%;padding:8px 10px;border-radius:12px;font-size:12px;}
    .arrow{color:var(--muted);font-size:12px}

    .shiftHeadRow{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:10px}
    .shiftButtons{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .shiftHidden{display:none !important;}

    /* ===== Preview Modals ===== */
    .previewGrid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap:10px;
    }
    .pDay{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      border-radius:14px;
      padding:10px;
      min-width:0;
    }
    .pTop{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .pName{font-weight:900;font-size:13px}
    .pHours{color:var(--muted);font-size:12px}
    .pItem{
      margin-top:8px;
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.16);
      border-radius:12px;
      font-size:12px;
      line-height:1.6;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .pItem b{font-size:12px}
    .mut{color:var(--muted)}
    .hr{height:1px;background:rgba(255,255,255,.08);margin:10px 0}
    .miniBtnRow{display:flex;gap:8px;flex-wrap:wrap}
    .tiny{font-size:12px;padding:8px 10px;border-radius:12px}

    /* ===== GPS UI additions ===== */
    .gpsCard{
      margin-top:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      border-radius:14px;
      padding:10px;
    }
    .gpsRow{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .gpsRow > *{flex:1; min-width:180px}
    .gpsBadgeOk{border-color:rgba(22,163,74,.35);background:rgba(22,163,74,.12);color:#d1fae5}
    .gpsBadgeBad{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.12);color:#fee2e2}
  </style>
</head>
<body>
  <div class="top">
    <div class="topin">
      <div class="brand">
        <img src="./assets/logo.webp" alt="Roma">
        <div>
          <b>Roma Schedule</b>
          <div class="pill" id="mePill">...</div>
        </div>
      </div>
      <div class="nav">
        <a class="btn" href="./admin-dashboard.html">Dashboard</a>
        <a class="btn" href="./admin-branches.html">Ø§Ù„ÙØ±ÙˆØ¹ + Ø§Ù„Ø¯ÙˆØ§Ù…</a>
        <a class="btn" href="./admin-employees.html">Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</a>
        <a class="btn" href="./admin-leaves.html">Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª</a>
        <a class="btn" href="./admin-schedule.html">ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„</a>
        <a class="btn" href="./admin-saved-shifts.html">Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¬Ø§Ù‡Ø²Ø©</a>
        <button class="btn danger" id="btnOut">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="row" style="align-items:center">
        <div style="flex:2">
          <h2 style="margin:0">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ±ÙˆØ¹</h2>
          <div class="mini">Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„ + Ø§Ù„Ø´ÙØªØ§Øª ØµØ§Ø±ÙˆØ§ Ø¨Ø²Ø± ÙˆØ§Ø­Ø¯ ÙŠÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ âœ…</div>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button class="btn primary" id="btnAdd">Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¹</button>
          <button class="btn" id="btnReload">ØªØ­Ø¯ÙŠØ«</button>
        </div>
      </div>

      <div style="overflow:auto;margin-top:10px">
        <table>
          <thead><tr><th>Ø§Ù„ÙØ±Ø¹</th><th>Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„</th><th>Ø§Ù„Ø´ÙØªØ§Øª</th><th>GPS</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
          <tbody id="tb"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===== Modal (add/edit) ===== -->
  <div class="modalOverlay" id="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modalHead">
        <div class="modalTitle">
          <b id="modalTitle">Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¹</b>
          <div class="mini" id="modalSub">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ù… Ø§Ø­ÙØ¸</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn primary" id="btnSave">Ø­ÙØ¸</button>
          <button class="xbtn" id="btnClose">Ø¥ØºÙ„Ø§Ù‚ âœ•</button>
        </div>
      </div>

      <div class="modalBody">
        <div class="mini">
          â€¢ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø´ÙØªØ§Øª Ø­Ø³Ø¨ ÙƒÙ„ ÙŠÙˆÙ… âœ…<br>
          â€¢ Ø¥Ø°Ø§ Ø´ÙØª ÙˆØ§Ø­Ø¯ â†’ Full Day (ÙØªØ­â†’ØªØ³ÙƒÙŠØ±)<br>
          â€¢ Ø¥Ø°Ø§ Ø´ÙØªÙŠÙ† â†’ Ø´ÙØª1 (ÙØªØ­â†’ÙØªØ­+8) Ùˆ Ø´ÙØª2 (ØªØ³ÙƒÙŠØ±-8â†’ØªØ³ÙƒÙŠØ±)
        </div>

        <div class="row">
          <div>
            <label>Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹</label>
            <input id="bName" placeholder="Ù…Ø«Ø§Ù„: ÙØ±Ø¹ Ø­Ù…Øµ - Ø§Ù„Ø¯Ø¨Ù„Ø§Ù†">
          </div>
        </div>

        <!-- âœ… GPS Card -->
        <div class="gpsCard">
          <div class="row" style="align-items:center">
            <div style="flex:2">
              <b style="font-size:13px">GPS Ù„Ù„ÙØ±Ø¹</b>
              <div class="mini">Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ÙØ±Ø¹ (Lat/Lng) + Ù†ØµÙ Ù‚Ø·Ø± Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù…ØªØ±</div>
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap">
              <button class="btn" id="btnGetGps">ğŸ“ Ø£Ø®Ø° Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø¢Ù†</button>
              <button class="btn" id="btnOpenMap">ğŸ—ºï¸ ÙØªØ­ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
              <button class="btn" id="btnManualGps">âœï¸ Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ</button>
              <button class="btn danger" id="btnClearGps">Ù…Ø³Ø­ GPS</button>
            </div>
          </div>

          <div class="gpsRow" style="margin-top:10px">
            <div>
              <label>Latitude</label>
              <input id="bLat" readonly placeholder="â€”">
            </div>
            <div>
              <label>Longitude</label>
              <input id="bLng" readonly placeholder="â€”">
            </div>
            <div>
              <label>Radius (Ù…ØªØ±)</label>
              <input id="bRadius" type="number" min="10" step="10" value="150">
            </div>
          </div>

          <div class="mini" style="margin-top:8px">
            Ø§Ù„Ø­Ø§Ù„Ø©: <span class="badge" id="gpsStatus">ØºÙŠØ± Ù…Ø¶Ø¨ÙˆØ·</span>
          </div>
        </div>

        <label style="margin-top:6px">Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ÙØªØ­/Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø­Ø³Ø¨ Ø§Ù„ÙŠÙˆÙ…</label>
        <div class="daysGrid" id="daysGrid"></div>

        <div class="shiftHeadRow">
          <div>
            <b style="font-size:13px">Ø§Ù„Ø´ÙØªØ§Øª</b>
            <div class="mini">Ø´ÙØª 1 + Ø´ÙØª 2 (Ø³Ù…Ø§Ø±Øª). ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø´ÙØª 3 ÙŠØ¯ÙˆÙŠÙ‹Ø§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</div>
          </div>
          <div class="shiftButtons">
            <button class="btn" id="btnAddShift">Ø¥Ø¶Ø§ÙØ© Ø´ÙØª 3</button>
            <button class="btn danger" id="btnRemoveShift" style="display:none">Ø¥Ø²Ø§Ù„Ø© Ø´ÙØª 3</button>
          </div>
        </div>

        <div class="twoCol" style="margin-top:10px">
          <div class="card" style="margin:0">
            <h2 style="font-size:14px;margin:0 0 8px">Ø´ÙØª 1</h2>
            <label>Ø§Ù„Ù…ÙˆØ¸Ù</label>
            <select id="emp1"><option value="">â€” Ø§Ø®ØªØ± Ù…ÙˆØ¸Ù â€”</option></select>
            <label>minStaff</label>
            <input id="bm1" type="number" min="0" value="0">
            <div class="mini">Ù…Ø¹Ø§ÙŠÙ†Ø© (Ø£ÙˆÙ„ ÙŠÙˆÙ… Ù…ÙØªÙˆØ­): <span class="badge" id="p1">--:--</span></div>
          </div>

          <div class="card" style="margin:0">
            <h2 style="font-size:14px;margin:0 0 8px">Ø´ÙØª 2</h2>
            <label>Ø§Ù„Ù…ÙˆØ¸Ù</label>
            <select id="emp2"><option value="">â€” Ø§Ø®ØªØ± Ù…ÙˆØ¸Ù â€”</option></select>
            <label>minStaff</label>
            <input id="bm2" type="number" min="0" value="0">
            <div class="mini">Ù…Ø¹Ø§ÙŠÙ†Ø© (Ø£ÙˆÙ„ ÙŠÙˆÙ… Ù…ÙØªÙˆØ­): <span class="badge" id="p2">--:--</span></div>
          </div>

          <div class="card shiftHidden" id="shift3Card" style="margin:0">
            <h2 style="font-size:14px;margin:0 0 8px">Ø´ÙØª 3 (ÙŠØ¯ÙˆÙŠ)</h2>
            <label>Ø§Ù„Ù…ÙˆØ¸Ù</label>
            <select id="emp3"><option value="">â€” Ø§Ø®ØªØ± Ù…ÙˆØ¸Ù â€”</option></select>
            <label>Ø¨Ø¯Ø§ÙŠØ©</label>
            <input id="bs3" type="time" step="60" value="00:00">
            <label>minStaff</label>
            <input id="bm3" type="number" min="0" value="0">
            <div class="mini">Ø§Ù„Ù†Ù‡Ø§ÙŠØ©: <span class="badge" id="p3">--:--</span></div>
          </div>

          <div class="card" style="margin:0">
            <h2 style="font-size:14px;margin:0 0 8px">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h2>
            <div class="mini">â€¢ minStaff=0 ÙŠØ¹Ù†ÙŠ Ø§Ù„Ø´ÙØª ØºÙŠØ± Ù…ÙØ¹Ù„</div>
            <div class="mini" id="empHint" style="margin-top:8px"></div>
          </div>
        </div>

        <div id="msg" class="msg"></div>
      </div>
    </div>
  </div>

  <!-- ===== Preview Modal: Shifts ===== -->
  <div class="modalOverlay" id="previewShiftOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="previewShiftTitle">
      <div class="modalHead">
        <div class="modalTitle">
          <b id="previewShiftTitle">Ø¹Ø±Ø¶ Ø§Ù„Ø´ÙØªØ§Øª</b>
          <div class="mini" id="previewShiftSub">â€”</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="xbtn" id="previewShiftClose">Ø¥ØºÙ„Ø§Ù‚ âœ•</button>
        </div>
      </div>
      <div class="modalBody">
        <div class="miniBtnRow" style="margin-bottom:10px">
          <span class="badge" id="previewShiftId">ID: â€”</span>
          <span class="badge" id="previewShiftCount">Shifts: â€”</span>
        </div>
        <div class="previewGrid" id="previewShiftGrid"></div>
      </div>
    </div>
  </div>

  <!-- ===== Preview Modal: Hours (NEW) ===== -->
  <div class="modalOverlay" id="previewHoursOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="previewHoursTitle">
      <div class="modalHead">
        <div class="modalTitle">
          <b id="previewHoursTitle">Ø¹Ø±Ø¶ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„</b>
          <div class="mini" id="previewHoursSub">â€”</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="xbtn" id="previewHoursClose">Ø¥ØºÙ„Ø§Ù‚ âœ•</button>
        </div>
      </div>
      <div class="modalBody">
        <div class="miniBtnRow" style="margin-bottom:10px">
          <span class="badge" id="previewHoursId">ID: â€”</span>
          <span class="badge" id="previewHoursCount">Days: â€”</span>
        </div>
        <div class="previewGrid" id="previewHoursGrid"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, getDocs, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN88FY9CJU8T8cm5lLYjcI-I8VmD46o40",
      authDomain: "roma-schedule.firebaseapp.com",
      projectId: "roma-schedule",
      storageBucket: "roma-schedule.firebasestorage.app",
      messagingSenderId: "685810932602",
      appId: "1:685810932602:web:f1ec506ea6ff5e919d94c3",
      measurementId: "G-5FY5S5TZLJ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id)=>document.getElementById(id);
    const escapeHtml = (s)=> String(s ?? "").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
    const setMsg = (text, type="ok")=>{
      const el = $("msg");
      el.className = "msg " + (type==="bad"?"bad":"ok");
      el.textContent = text;
      el.style.display = "block";
    };
    const hideMsg = ()=>{ $("msg").style.display="none"; };

    async function requireAdmin(user){
      const snap = await getDoc(doc(db,"employees",user.uid));
      return snap.exists() && snap.data()?.role === "admin";
    }

    // ===== time helpers =====
    function timeToMin(t){
      if(!t) return null;
      const m = String(t).trim().match(/^(\d{1,2}):(\d{2})$/);
      if(!m) return null;
      const hh = Math.max(0, Math.min(23, parseInt(m[1],10)));
      const mm = Math.max(0, Math.min(59, parseInt(m[2],10)));
      return hh*60 + mm;
    }
    function minToTime(min){
      const m = ((min % 1440) + 1440) % 1440;
      const hh = String(Math.floor(m/60)).padStart(2,"0");
      const mm = String(m%60).padStart(2,"0");
      return `${hh}:${mm}`;
    }
    function minutesBetween(open, close){
      const a = timeToMin(open), b = timeToMin(close);
      if(a===null || b===null) return null;
      return ((b - a) + 1440) % 1440;
    }

    // ===== GPS helpers (NEW) =====
    function setGpsStatus(has){
      const badge = $("gpsStatus");
      badge.className = "badge " + (has ? "gpsBadgeOk" : "gpsBadgeBad");
      badge.textContent = has ? "Ù…Ø¶Ø¨ÙˆØ· âœ…" : "ØºÙŠØ± Ù…Ø¶Ø¨ÙˆØ·";
    }
    function getGpsFromForm(){
      const lat = parseFloat(($("bLat").value||"").trim());
      const lng = parseFloat(($("bLng").value||"").trim());
      const radiusM = parseInt(($("bRadius").value||"150"), 10) || 150;

      if(Number.isFinite(lat) && Number.isFinite(lng)){
        return { lat, lng, radiusM: Math.max(10, radiusM) };
      }
      return null;
    }
    function setGpsToForm(geo){
      if(geo && Number.isFinite(geo.lat) && Number.isFinite(geo.lng)){
        $("bLat").value = String(geo.lat);
        $("bLng").value = String(geo.lng);
        $("bRadius").value = String(geo.radiusM || 150);
        setGpsStatus(true);
      }else{
        $("bLat").value = "";
        $("bLng").value = "";
        $("bRadius").value = "150";
        setGpsStatus(false);
      }
    }
    function ensureGeolocation(){
      if(!("geolocation" in navigator)){
        throw new Error("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS.");
      }
    }
    async function getCurrentPositionOnce(options={}){
      ensureGeolocation();
      return await new Promise((resolve, reject)=>{
        navigator.geolocation.getCurrentPosition(resolve, reject, {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 0,
          ...options
        });
      });
    }
    function openGoogleMaps(lat, lng){
      const url = `https://www.google.com/maps?q=${encodeURIComponent(lat + "," + lng)}`;
      window.open(url, "_blank");
    }

    // âœ… Manual GPS toggle (NEW)
    let manualGpsEnabled = false;
    function setManualGps(enabled){
      manualGpsEnabled = !!enabled;

      // Ù„Ø§ Ù†Ø­Ø°Ù readonly Ù…Ù† HTMLØŒ ÙÙ‚Ø· Ù†ØºÙŠØ± Ø§Ù„Ø®Ø§ØµÙŠØ© Ø¨Ø§Ù„Ù€ JS
      $("bLat").readOnly = !manualGpsEnabled;
      $("bLng").readOnly = !manualGpsEnabled;

      // ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨ØµØ±ÙŠØ§Ù‹
      $("bLat").style.cursor = manualGpsEnabled ? "text" : "not-allowed";
      $("bLng").style.cursor = manualGpsEnabled ? "text" : "not-allowed";
      $("bLat").style.opacity = manualGpsEnabled ? "1" : ".75";
      $("bLng").style.opacity = manualGpsEnabled ? "1" : ".75";

      $("btnManualGps").textContent = manualGpsEnabled ? "ğŸ”’ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ" : "âœï¸ Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ";
    }

    // ======= days =======
    const DAYS = [
      { key:"sun", label:"Ø§Ù„Ø£Ø­Ø¯" },
      { key:"mon", label:"Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†" },
      { key:"tue", label:"Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡" },
      { key:"wed", label:"Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡" },
      { key:"thu", label:"Ø§Ù„Ø®Ù…ÙŠØ³" },
      { key:"fri", label:"Ø§Ù„Ø¬Ù…Ø¹Ø©" },
      { key:"sat", label:"Ø§Ù„Ø³Ø¨Øª" },
    ];
    const DAY_LABEL = Object.fromEntries(DAYS.map(d=>[d.key,d.label]));

    function renderDaysCards(){
      const wrap = $("daysGrid");
      wrap.innerHTML = "";
      for(const d of DAYS){
        const card = document.createElement("div");
        card.className = "dayCard";
        card.innerHTML = `
          <div class="dayTop">
            <div class="dayName">${d.label}</div>
            <label class="dayToggle">
              <input type="checkbox" id="cl_${d.key}">
              Ù…ØºÙ„Ù‚
            </label>
          </div>
          <div class="dayTimes">
            <input type="time" step="60" id="op_${d.key}" value="08:00">
            <span class="arrow">â†’</span>
            <input type="time" step="60" id="co_${d.key}" value="00:00">
          </div>
        `;
        wrap.appendChild(card);

        const chk = document.getElementById(`cl_${d.key}`);
        const op = document.getElementById(`op_${d.key}`);
        const co = document.getElementById(`co_${d.key}`);

        const apply = ()=>{
          const closed = chk.checked;
          op.disabled = closed;
          co.disabled = closed;
          op.style.opacity = closed ? .55 : 1;
          co.style.opacity = closed ? .55 : 1;
          recomputePreviewTimes();
        };
        chk.addEventListener("change", apply);
        op.addEventListener("input", recomputePreviewTimes);
        co.addEventListener("input", recomputePreviewTimes);
        apply();
      }
    }

    function getHoursByDay(){
      const hours = {};
      for(const d of DAYS){
        const closed = document.getElementById(`cl_${d.key}`).checked;
        const open = document.getElementById(`op_${d.key}`).value;
        const close = document.getElementById(`co_${d.key}`).value;

        if(!closed){
          if(timeToMin(open) === null) throw new Error(`Ø§Ø®ØªØ± ÙˆÙ‚Øª ÙØªØ­ ØµØ­ÙŠØ­ Ù„ÙŠÙˆÙ… ${d.label}`);
          if(timeToMin(close) === null) throw new Error(`Ø§Ø®ØªØ± ÙˆÙ‚Øª Ø¥ØºÙ„Ø§Ù‚ ØµØ­ÙŠØ­ Ù„ÙŠÙˆÙ… ${d.label}`);
        }
        hours[d.key] = { closed, openTime: open, closeTime: close };
      }
      return hours;
    }

    function setHoursByDay(hours){
      const def = { closed:false, openTime:"08:00", closeTime:"00:00" };
      for(const d of DAYS){
        const v = (hours && hours[d.key]) ? hours[d.key] : def;
        document.getElementById(`cl_${d.key}`).checked = !!v.closed;
        document.getElementById(`op_${d.key}`).value = v.openTime || "08:00";
        document.getElementById(`co_${d.key}`).value = v.closeTime || "00:00";
        document.getElementById(`cl_${d.key}`).dispatchEvent(new Event("change"));
      }
      recomputePreviewTimes();
    }

    function getFirstOpenDay(hoursByDay){
      for(const d of DAYS){
        const v = hoursByDay[d.key];
        if(v && !v.closed) return { dayKey:d.key, open:v.openTime, close:v.closeTime };
      }
      return null;
    }

    function recomputePreviewTimes(){
      let hours;
      try{ hours = getHoursByDay(); }catch{ return; }
      const ref = getFirstOpenDay(hours);
      const ms1 = Number($("bm1").value||0);
      const ms2 = Number($("bm2").value||0);
      const oneShiftOnly = ms1>0 && ms2<=0;

      // preview shift3
      const bs3 = $("bs3").value;
      const m3 = timeToMin(bs3);
      $("p3").textContent = (m3===null) ? "--:--" : minToTime(m3+480);

      if(!ref){
        $("p1").textContent="--:--";
        $("p2").textContent="--:--";
        return;
      }
      const open = ref.open, close=ref.close;
      const s1End = oneShiftOnly ? close : minToTime(timeToMin(open)+480);
      const s2Start = minToTime(timeToMin(close)-480);

      $("p1").textContent = `${open} â†’ ${s1End}`;
      $("p2").textContent = oneShiftOnly ? "â€”" : `${s2Start} â†’ ${close}`;
    }

    // ===== Employees dropdown =====
    let cachedEmployees = [];

    function employeeLabel(emp){
      const name = emp.name || emp.fullName || emp.displayName || emp.username || "";
      const email = emp.email || "";
      return (name && email) ? `${name} â€” ${email}` : (name || email || emp.id);
    }

    function fillEmployeeSelect(selectEl, selectedId=""){
      const prev = selectedId || "";
      const opts = [`<option value="">â€” Ø§Ø®ØªØ± Ù…ÙˆØ¸Ù â€”</option>`];

      if(cachedEmployees.length){
        for(const e of cachedEmployees){
          const tag = e.source === "employees" ? "Ø­Ø³Ø§Ø¨" : "Ø¥ÙŠÙ…ÙŠÙ„";
          opts.push(`<option value="${escapeHtml(e.id)}">${escapeHtml(employeeLabel(e))} (${tag})</option>`);
        }
      }else{
        opts.push(`<option value="" disabled>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† Ø¶Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„ÙØ±Ø¹</option>`);
      }

      selectEl.innerHTML = opts.join("");
      selectEl.value = prev;
    }

    function matchesBranch(emp, branchId){
      const bid = emp.branchId || emp.branch || emp.fixedBranchId || (emp.branchRef && emp.branchRef.id) || "";
      return String(bid) === String(branchId);
    }

    async function loadEmployeesForBranch(branchId){
      cachedEmployees = [];

      if(!branchId){
        $("empHint").textContent = "Ù„Ø¥Ø¸Ù‡Ø§Ø± Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„ÙØ±Ø¹: Ø§Ø­ÙØ¸ Ø§Ù„ÙØ±Ø¹ Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ø±Ø¨Ø· Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø¨Ù‡.";
        fillEmployeeSelect($("emp1"), "");
        fillEmployeeSelect($("emp2"), "");
        fillEmployeeSelect($("emp3"), "");
        return;
      }

      const empSnap = await getDocs(collection(db,"employees"));
      const emps = [];
      empSnap.forEach(d=>{
        const data = d.data() || {};
        if(matchesBranch(data, branchId) && data.active !== false){
          emps.push({ id:d.id, source:"employees", ...data });
        }
      });

      const presetSnap = await getDocs(collection(db,"employees_email"));
      const presets = [];
      presetSnap.forEach(d=>{
        const data = d.data() || {};
        if(String(data.branchId||"") === String(branchId) && data.active !== false){
          presets.push({ id:"preset:"+d.id, source:"employees_email", ...data });
        }
      });

      cachedEmployees = [...emps, ...presets].sort((a,b)=> employeeLabel(a).localeCompare(employeeLabel(b)));

      $("empHint").textContent = cachedEmployees.length
        ? `Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø¶Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„ÙØ±Ø¹: ${cachedEmployees.length}`
        : "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ø±ØªØ¨Ø·ÙŠÙ† Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙØ±Ø¹ Ø¨Ø¹Ø¯ (employees / employees_email).";

      fillEmployeeSelect($("emp1"), $("emp1").value);
      fillEmployeeSelect($("emp2"), $("emp2").value);
      fillEmployeeSelect($("emp3"), $("emp3").value);
    }

    function getSelectedEmployee(empId){
      return cachedEmployees.find(e=>e.id === empId) || null;
    }

    // ===== Shift3 toggle =====
    let shift3Enabled = false;
    function setShift3(enabled){
      shift3Enabled = !!enabled;
      $("shift3Card").classList.toggle("shiftHidden", !shift3Enabled);
      $("btnRemoveShift").style.display = shift3Enabled ? "inline-flex" : "none";
      $("btnAddShift").style.display = shift3Enabled ? "none" : "inline-flex";
      if(!shift3Enabled){
        $("bm3").value = 0;
        $("emp3").value = "";
      }
      recomputePreviewTimes();
    }

    // ===== Shift config + build per day =====
    function packShiftConfig(){
      return {
        mode: "smart_by_day",
        shift1: { minStaff: Number($("bm1").value||0), assignedEmployeeId: ($("emp1").value||"").trim() || null },
        shift2: { minStaff: Number($("bm2").value||0), assignedEmployeeId: ($("emp2").value||"").trim() || null },
        shift3: {
          enabled: !!shift3Enabled,
          start: $("bs3").value || "00:00",
          minStaff: Number($("bm3").value||0),
          assignedEmployeeId: ($("emp3").value||"").trim() || null
        }
      };
    }

    function buildDayShifts(open, close, cfg){
      const out = [];
      const ms1 = Number(cfg.shift1?.minStaff||0);
      const ms2 = Number(cfg.shift2?.minStaff||0);
      const oneShiftOnly = ms1>0 && ms2<=0;

      const fullMin = minutesBetween(open, close);
      if(fullMin === null) return out;

      const add = (label, start, end, minStaff, empSelId, durationHours)=>{
        if(Number(minStaff||0) <= 0) return;
        const sel = (empSelId || "").trim();
        const emp = sel ? getSelectedEmployee(sel) : null;

        out.push({
          key: label,
          name: label,
          start,
          end,
          minStaff: Number(minStaff||0),
          durationHours,
          assignedEmployeeId: sel || null,
          assignedEmployeeSource: emp?.source || null,
          assignedEmployeeName: emp ? (emp.name || emp.fullName || emp.displayName || emp.email || emp.id) : null,
          assignedEmployeeEmail: emp?.email || null
        });
      };

      const s1Start = open;
      const s1End = oneShiftOnly ? close : minToTime(timeToMin(open) + 480);
      const dur1 = oneShiftOnly ? +(fullMin/60).toFixed(2) : 8;
      add("Shift 1", s1Start, s1End, ms1, cfg.shift1?.assignedEmployeeId, dur1);

      if(!oneShiftOnly){
        const s2Start = minToTime(timeToMin(close) - 480);
        add("Shift 2", s2Start, close, ms2, cfg.shift2?.assignedEmployeeId, 8);
      }

      if(cfg.shift3?.enabled){
        const ms3 = Number(cfg.shift3?.minStaff||0);
        if(ms3>0){
          const st = cfg.shift3?.start || "00:00";
          add("Shift 3", st, minToTime(timeToMin(st)+480), ms3, cfg.shift3?.assignedEmployeeId, 8);
        }
      }

      return out;
    }

    function packShiftsByDay(hoursByDay, cfg){
      const map = {};
      for(const d of DAYS){
        const v = hoursByDay[d.key];
        if(!v || v.closed){ map[d.key]=[]; continue; }
        map[d.key] = buildDayShifts(v.openTime, v.closeTime, cfg);
      }
      return map;
    }

    // ===== add/edit modal =====
    const overlay = $("modalOverlay");
    function openModal(mode){
      overlay.classList.add("show");
      overlay.setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";
      hideMsg();
      recomputePreviewTimes();

      if(mode==="edit"){
        $("modalTitle").textContent = "ØªØ¹Ø¯ÙŠÙ„ ÙØ±Ø¹";
        $("modalSub").textContent = "Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ù… Ø§Ø­ÙØ¸";
      }else{
        $("modalTitle").textContent = "Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¹";
        $("modalSub").textContent = "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ù… Ø§Ø­ÙØ¸";
      }
      setTimeout(()=> $("bName").focus(), 50);
    }
    function closeModal(){
      overlay.classList.remove("show");
      overlay.setAttribute("aria-hidden","true");
      document.body.style.overflow = "";
      hideMsg();
    }
    overlay.addEventListener("click", (e)=>{ if(e.target === overlay) closeModal(); });
    document.addEventListener("keydown", (e)=>{ if(e.key === "Escape" && overlay.classList.contains("show")) closeModal(); });

    // ===== Preview Shifts Modal =====
    const shiftOv = $("previewShiftOverlay");
    function openShiftsModal(branch){
      $("previewShiftTitle").textContent = `Ø§Ù„Ø´ÙØªØ§Øª â€” ${branch.name || "-"}`;
      $("previewShiftSub").textContent = "Ø¹Ø±Ø¶ Ø­Ø³Ø¨ ÙƒÙ„ ÙŠÙˆÙ…";
      $("previewShiftId").textContent = `ID: ${branch.id}`;

      const shiftsByDay = branch.shiftsByDay || null;
      const hoursByDay = branch.hoursByDay || null;

      let cnt = 0;
      if(shiftsByDay){
        for(const d of DAYS){
          const arr = Array.isArray(shiftsByDay[d.key]) ? shiftsByDay[d.key] : [];
          cnt += arr.length;
        }
      } else if(Array.isArray(branch.shifts)) {
        cnt = branch.shifts.length;
      }
      $("previewShiftCount").textContent = `Shifts: ${cnt}`;

      const grid = $("previewShiftGrid");
      grid.innerHTML = "";

      for(const d of DAYS){
        const key = d.key;
        const hv = hoursByDay?.[key];
        const closed = hv ? !!hv.closed : false;
        const hoursText = hv ? (closed ? "Ù…ØºÙ„Ù‚" : `${hv.openTime} â†’ ${hv.closeTime}`) : "â€”";

        const arr = shiftsByDay ? (Array.isArray(shiftsByDay[key]) ? shiftsByDay[key] : []) : [];

        const card = document.createElement("div");
        card.className = "pDay";
        card.innerHTML = `
          <div class="pTop">
            <div class="pName">${d.label}</div>
            <div class="pHours">${escapeHtml(hoursText)}</div>
          </div>
          <div class="hr"></div>
          <div class="pBody"></div>
        `;
        grid.appendChild(card);

        const body = card.querySelector(".pBody");

        if(!hoursByDay){ body.innerHTML = `<div class="mut">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø§Ø¹Ø§Øª Ø¯ÙˆØ§Ù…</div>`; continue; }
        if(closed){ body.innerHTML = `<div class="mut">Ù…ØºÙ„Ù‚</div>`; continue; }
        if(!arr.length){ body.innerHTML = `<div class="mut">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´ÙØªØ§Øª (minStaff=0)</div>`; continue; }

        for(const s of arr){
          const emp = s.assignedEmployeeName ? s.assignedEmployeeName : (s.assignedEmployeeEmail || "");
          const empLine = emp ? `<span class="mut">${escapeHtml(emp)}</span>` : `<span class="mut">â€” Ø¨Ø¯ÙˆÙ† Ù…ÙˆØ¸Ù</span>`;
          const item = document.createElement("div");
          item.className = "pItem";
          item.innerHTML = `
            <b>${escapeHtml(s.name || s.key || "Shift")}</b>
            <div>${escapeHtml(s.start)} â†’ ${escapeHtml(s.end)} <span class="mut">(min=${Number(s.minStaff||0)})</span></div>
            <div>${empLine}</div>
          `;
          body.appendChild(item);
        }
      }

      shiftOv.classList.add("show");
      shiftOv.setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";
    }
    function closeShiftsModal(){
      shiftOv.classList.remove("show");
      shiftOv.setAttribute("aria-hidden","true");
      document.body.style.overflow = "";
    }
    $("previewShiftClose").addEventListener("click", closeShiftsModal);
    shiftOv.addEventListener("click", (e)=>{ if(e.target === shiftOv) closeShiftsModal(); });

    // ===== Preview Hours Modal (NEW) =====
    const hoursOv = $("previewHoursOverlay");
    function openHoursModal(branch){
      $("previewHoursTitle").textContent = `Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„ â€” ${branch.name || "-"}`;
      $("previewHoursSub").textContent = "Ø¹Ø±Ø¶ Ø­Ø³Ø¨ ÙƒÙ„ ÙŠÙˆÙ…";
      $("previewHoursId").textContent = `ID: ${branch.id}`;

      const hoursByDay = branch.hoursByDay || null;
      let openDays = 0;
      if(hoursByDay){
        for(const d of DAYS){
          const v = hoursByDay[d.key];
          if(v && !v.closed) openDays++;
        }
      }
      $("previewHoursCount").textContent = `Days: ${hoursByDay ? openDays + "/7" : "â€”"}`;

      const grid = $("previewHoursGrid");
      grid.innerHTML = "";

      for(const d of DAYS){
        const v = hoursByDay?.[d.key] || null;
        const closed = v ? !!v.closed : false;
        const hoursText = v ? (closed ? "Ù…ØºÙ„Ù‚" : `${v.openTime} â†’ ${v.closeTime}`) : "â€”";

        const card = document.createElement("div");
        card.className = "pDay";
        card.innerHTML = `
          <div class="pTop">
            <div class="pName">${d.label}</div>
            <div class="pHours">${escapeHtml(hoursText)}</div>
          </div>
          <div class="hr"></div>
          <div class="pBody">
            ${v ? (closed ? `<div class="mut">Ù…ØºÙ„Ù‚</div>` : `<div class="pItem"><b>Ø§Ù„Ø¯ÙˆØ§Ù…</b><div>${escapeHtml(v.openTime)} â†’ ${escapeHtml(v.closeTime)}</div></div>`) : `<div class="mut">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</div>`}
          </div>
        `;
        grid.appendChild(card);
      }

      hoursOv.classList.add("show");
      hoursOv.setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";
    }
    function closeHoursModal(){
      hoursOv.classList.remove("show");
      hoursOv.setAttribute("aria-hidden","true");
      document.body.style.overflow = "";
    }
    $("previewHoursClose").addEventListener("click", closeHoursModal);
    hoursOv.addEventListener("click", (e)=>{ if(e.target === hoursOv) closeHoursModal(); });

    // ESC closes whichever modal is open
    document.addEventListener("keydown", (e)=>{
      if(e.key!=="Escape") return;
      if(overlay.classList.contains("show")) closeModal();
      if(shiftOv.classList.contains("show")) closeShiftsModal();
      if(hoursOv.classList.contains("show")) closeHoursModal();
    });

    // ===== Branch state =====
    let editingId = null;
    const branchesCache = new Map();

    function resetForm(){
      editingId = null;
      $("bName").value = "";
      setHoursByDay(null);

      // GPS reset
      setGpsToForm(null);
      setManualGps(false);

      $("bm1").value=0;
      $("bm2").value=0;

      $("bs3").value="00:00";
      $("bm3").value=0;
      setShift3(false);

      $("emp1").value = "";
      $("emp2").value = "";
      $("emp3").value = "";

      cachedEmployees = [];
      fillEmployeeSelect($("emp1"), "");
      fillEmployeeSelect($("emp2"), "");
      fillEmployeeSelect($("emp3"), "");

      hideMsg();
      $("empHint").textContent = "Ù„Ø¥Ø¸Ù‡Ø§Ø± Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„ÙØ±Ø¹: Ø§Ø­ÙØ¸ Ø§Ù„ÙØ±Ø¹ Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ø±Ø¨Ø· Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø¨Ù‡.";
      recomputePreviewTimes();
    }

    function countShiftsFast(branch){
      if(branch.shiftsByDay){
        let c=0;
        for(const d of DAYS){
          const arr = Array.isArray(branch.shiftsByDay[d.key]) ? branch.shiftsByDay[d.key] : [];
          c += arr.length;
        }
        return c;
      }
      return Array.isArray(branch.shifts) ? branch.shifts.length : 0;
    }

    function countOpenDays(branch){
      const h = branch.hoursByDay || null;
      if(!h) return 0;
      let c=0;
      for(const d of DAYS){
        const v = h[d.key];
        if(v && !v.closed) c++;
      }
      return c;
    }

    function summarizeHoursTiny(branch){
      const c = countOpenDays(branch);
      return `${c}/7`;
    }

    // GPS tiny summary for table
    function summarizeGpsTiny(branch){
      const g = branch.geo || null;
      const ok = g && Number.isFinite(g.lat) && Number.isFinite(g.lng);
      return ok ? `âœ… ${Number(g.radiusM||150)}m` : "â€”";
    }

    async function load(){
      branchesCache.clear();

      const snap = await getDocs(collection(db,"branches"));
      const rows=[];
      snap.forEach(d=>{
        const obj = {id:d.id, ...d.data()};
        rows.push(obj);
        branchesCache.set(d.id, obj);
      });
      rows.sort((a,b)=> (a.name||"").localeCompare(b.name||""));

      const tb = $("tb");
      tb.innerHTML="";

      for(const r of rows){
        const hoursBtn = `
          <button class="btn tiny" data-hours="${escapeHtml(r.id)}">Ø¹Ø±Ø¶ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„</button>
          <span class="badge">${summarizeHoursTiny(r)}</span>
        `;

        const shiftCount = countShiftsFast(r);
        const shiftBtn = `
          <button class="btn tiny" data-shifts="${escapeHtml(r.id)}">Ø¹Ø±Ø¶ Ø§Ù„Ø´ÙØªØ§Øª</button>
          <span class="badge">${shiftCount}</span>
        `;

        const gpsOk = r.geo && Number.isFinite(r.geo.lat) && Number.isFinite(r.geo.lng);
        const gpsBadge = `<span class="badge ${gpsOk ? "gpsBadgeOk" : "gpsBadgeBad"}">${escapeHtml(summarizeGpsTiny(r))}</span>`;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>
            <b>${escapeHtml(r.name||"-")}</b>
            <div class="mini">ID: <span class="badge">${escapeHtml(r.id)}</span></div>
          </td>
          <td>${hoursBtn}</td>
          <td>${shiftBtn}</td>
          <td>${gpsBadge}</td>
          <td>
            <button class="btn" data-ed="${escapeHtml(r.id)}">ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="btn danger" data-del="${escapeHtml(r.id)}">Ø­Ø°Ù</button>
          </td>
        `;
        tb.appendChild(tr);
      }

      tb.querySelectorAll("[data-hours]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id = b.getAttribute("data-hours");
          const br = branchesCache.get(id);
          if(br) openHoursModal(br);
        });
      });

      tb.querySelectorAll("[data-shifts]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id = b.getAttribute("data-shifts");
          const br = branchesCache.get(id);
          if(br) openShiftsModal(br);
        });
      });

      tb.querySelectorAll("[data-ed]").forEach(b=>{
        b.addEventListener("click", async ()=>{
          const id = b.getAttribute("data-ed");
          const s = await getDoc(doc(db,"branches",id));
          if(!s.exists()) return;
          const d = s.data();

          editingId = id;
          $("bName").value = d.name || "";
          setHoursByDay(d.hoursByDay || null);

          // âœ… load GPS from branch
          setGpsToForm(d.geo || null);
          setManualGps(false);

          await loadEmployeesForBranch(editingId);

          const cfg = d.shiftConfig || null;
          if(cfg){
            $("bm1").value = cfg.shift1?.minStaff || 0;
            $("emp1").value = cfg.shift1?.assignedEmployeeId || "";

            $("bm2").value = cfg.shift2?.minStaff || 0;
            $("emp2").value = cfg.shift2?.assignedEmployeeId || "";

            if(cfg.shift3?.enabled){
              setShift3(true);
              $("bs3").value = cfg.shift3?.start || "00:00";
              $("bm3").value = cfg.shift3?.minStaff || 0;
              $("emp3").value = cfg.shift3?.assignedEmployeeId || "";
            }else{
              $("bs3").value = "00:00"; $("bm3").value = 0;
              $("emp3").value = "";
              setShift3(false);
            }
          }else{
            const shifts = Array.isArray(d.shifts)? d.shifts: [];
            const pick = (label)=> shifts.find(x=>x.name===label);
            const s1=pick("Shift 1"), s2=pick("Shift 2"), s3=pick("Shift 3");

            $("bm1").value = s1?.minStaff || 0;
            $("emp1").value = s1?.assignedEmployeeId || "";

            $("bm2").value = s2?.minStaff || 0;
            $("emp2").value = s2?.assignedEmployeeId || "";

            if(s3 && Number(s3.minStaff||0) > 0){
              setShift3(true);
              $("bs3").value = s3?.start || "00:00";
              $("bm3").value = s3?.minStaff || 0;
              $("emp3").value = s3?.assignedEmployeeId || "";
            }else{
              $("bs3").value = "00:00"; $("bm3").value = 0;
              $("emp3").value = "";
              setShift3(false);
            }
          }

          fillEmployeeSelect($("emp1"), $("emp1").value);
          fillEmployeeSelect($("emp2"), $("emp2").value);
          fillEmployeeSelect($("emp3"), $("emp3").value);

          recomputePreviewTimes();
          openModal("edit");
        });
      });

      tb.querySelectorAll("[data-del]").forEach(b=>{
        b.addEventListener("click", async ()=>{
          const id = b.getAttribute("data-del");
          if(!confirm("Ø­Ø°Ù Ø§Ù„ÙØ±Ø¹ØŸ")) return;
          await deleteDoc(doc(db,"branches",id));
          await load();
        });
      });
    }

    async function save(){
      const name = $("bName").value.trim();
      if(!name) return setMsg("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹","bad");

      let hoursByDay;
      try{ hoursByDay = getHoursByDay(); }
      catch(err){ return setMsg(err?.message || "ØªØ£ÙƒØ¯ Ù…Ù† Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ÙØªØ­/Ø§Ù„Ø¥ØºÙ„Ø§Ù‚","bad"); }

      const shiftConfig = packShiftConfig();
      const shiftsByDay = packShiftsByDay(hoursByDay, shiftConfig);

      const anyActive = DAYS.some(d => (shiftsByDay[d.key]||[]).length > 0);
      if(!anyActive) return setMsg("ÙØ¹Ù‘Ù„ Ø´ÙØª ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ (minStaff > 0)","bad");

      const ref = getFirstOpenDay(hoursByDay);
      const shiftsSample = ref ? buildDayShifts(ref.open, ref.close, shiftConfig) : [];

      // âœ… GPS pack
      const gps = getGpsFromForm();
      const geo = gps ? { ...gps, updatedAt: serverTimestamp() } : null;

      const payload = {
        name,
        hoursByDay,
        shiftConfig,
        shiftsByDay,
        shifts: shiftsSample,
        geo: geo,                 // âœ… saved here
        updatedAt: serverTimestamp()
      };

      if(editingId){
        await updateDoc(doc(db,"branches",editingId), payload);
        setMsg("ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ±Ø¹ âœ…","ok");
      }else{
        const id = "br_" + crypto.randomUUID().slice(0,10);
        await setDoc(doc(db,"branches",id), { ...payload, createdAt: serverTimestamp() });
        setMsg("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ±Ø¹ âœ…","ok");
      }

      await load();
      closeModal();
      resetForm();
    }

    // ===== events =====
    $("bm1").addEventListener("input", recomputePreviewTimes);
    $("bm2").addEventListener("input", recomputePreviewTimes);
    $("bs3").addEventListener("input", recomputePreviewTimes);

    $("btnSave").addEventListener("click", save);
    $("btnClose").addEventListener("click", closeModal);
    $("btnOut").addEventListener("click", async ()=>{ await signOut(auth); location.href="./login.html"; });

    $("btnAdd").addEventListener("click", async ()=>{
      resetForm();
      openModal("add");
      await loadEmployeesForBranch(null);
    });

    $("btnReload").addEventListener("click", load);

    $("btnAddShift").addEventListener("click", ()=>{
      setShift3(true);
      setTimeout(()=> $("bs3").focus(), 50);
    });
    $("btnRemoveShift").addEventListener("click", ()=> setShift3(false));

    // âœ… GPS buttons (NEW)
    $("btnGetGps").addEventListener("click", async ()=>{
      try{
        hideMsg();
        $("gpsStatus").textContent = "Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...";
        const pos = await getCurrentPositionOnce();
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        $("bLat").value = String(lat);
        $("bLng").value = String(lng);
        if(!$("bRadius").value) $("bRadius").value = "150";
        setGpsStatus(true);
        setManualGps(false);
        setMsg("ØªÙ… Ø£Ø®Ø° Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­ âœ…","ok");
      }catch(err){
        console.warn(err);
        setGpsStatus(false);
        const code = err?.code;
        let msg = "ÙØ´Ù„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.";
        if(code === 1) msg = "ØªÙ… Ø±ÙØ¶ Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹. ÙØ¹Ù‘Ù„ Location Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­ Ø«Ù… Ø¬Ø±Ù‘Ø¨.";
        if(code === 2) msg = "Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø­Ø§Ù„ÙŠØ§Ù‹ (GPS/Network). Ø¬Ø±Ù‘Ø¨ Ù„Ø§Ø­Ù‚Ø§Ù‹.";
        if(code === 3) msg = "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ù‡Ù„Ø© (Timeout). Ø¬Ø±Ù‘Ø¨ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.";
        setMsg(msg,"bad");
      }
    });

    $("btnOpenMap").addEventListener("click", ()=>{
      const g = getGpsFromForm();
      if(!g) return setMsg("Ù„Ø§ ÙŠÙˆØ¬Ø¯ GPS Ù…Ø¶Ø¨ÙˆØ· Ù„Ù„ÙØªØ­ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©.","bad");
      openGoogleMaps(g.lat, g.lng);
    });

    $("btnClearGps").addEventListener("click", ()=>{
      setGpsToForm(null);
      setManualGps(false);
      setMsg("ØªÙ… Ù…Ø³Ø­ GPS Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ (Ù„Ø§ ÙŠÙ†Ø¹ÙƒØ³ Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸).","ok");
    });

    // âœ… Manual button
    $("btnManualGps").addEventListener("click", ()=>{
      setManualGps(!manualGpsEnabled);
      if(manualGpsEnabled) setTimeout(()=> $("bLat").focus(), 50);
    });

    // radius change updates status if lat/lng exists
    $("bRadius").addEventListener("input", ()=>{
      const g = getGpsFromForm();
      setGpsStatus(!!g);
    });

    // typing lat/lng updates status (manual)
    $("bLat").addEventListener("input", ()=> setGpsStatus(!!getGpsFromForm()));
    $("bLng").addEventListener("input", ()=> setGpsStatus(!!getGpsFromForm()));

    renderDaysCards();
    resetForm();

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href="./login.html"; return; }
      $("mePill").textContent = user.email || user.uid;

      const ok = await requireAdmin(user);
      if(!ok){
        const admins = await getDocs(query(collection(db,"employees"), where("role","==","admin")));
        if(admins.size>0){ location.href="./staff.html"; return; }
      }

      await load();
    });
  </script>
</body>
</html>
