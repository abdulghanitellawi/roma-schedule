<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Roma Schedule - Staff</title>
  <link rel="icon" href="./assets/logo.webp">
  <style>
    :root{
      --bg:#0b1220; --panel:rgba(255,255,255,.06); --line:rgba(255,255,255,.14);
      --txt:#e5e7eb; --muted:#9ca3af; --accent:#d4a019; --shadow: 0 18px 60px rgba(0,0,0,.35);
      --ok:#16a34a; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; background:
        radial-gradient(1200px 600px at 10% 10%, rgba(212,160,25,.16), transparent 55%),
        radial-gradient(900px 500px at 90% 20%, rgba(59,130,246,.14), transparent 55%),
        var(--bg);
      color:var(--txt);
      font-family: system-ui, "Noto Sans Arabic", Tahoma, Arial, sans-serif;
    }
    .top{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(10,16,28,.55);
      border-bottom:1px solid var(--line);
    }
    .topin{max-width:1100px; margin:0 auto; padding:14px; display:flex; gap:10px; align-items:center; justify-content:space-between}
    .brand{display:flex; align-items:center; gap:10px}
    .brand img{width:30px;height:30px;object-fit:contain;border-radius:12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12)}
    .btn{
      cursor:pointer; border:1px solid var(--line); background:rgba(255,255,255,.06);
      color:var(--txt); padding:10px 12px; border-radius:12px; font-weight:900;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      text-decoration:none;
    }
    .btn:hover{background:rgba(255,255,255,.09)}
    .btn.primary{border-color:rgba(212,160,25,.45); background:rgba(212,160,25,.14)}
    .btn.primary:hover{background:rgba(212,160,25,.20)}
    .btn.danger{border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.12)}
    .btn.danger:hover{background:rgba(239,68,68,.16)}
    .wrap{max-width:1100px; margin:0 auto; padding:14px}
    .grid{display:grid; grid-template-columns: 360px 1fr; gap:14px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }
    .card{border:1px solid var(--line); background:var(--panel); border-radius:18px; padding:12px; box-shadow:var(--shadow)}
    h2{margin:0 0 10px; font-size:18px}
    label{display:block; margin:10px 0 6px; color:var(--muted); font-size:13px}
    input{
      width:100%; padding:11px 12px; border-radius:12px;
      border:1px solid var(--line); background:rgba(0,0,0,.16);
      color:var(--txt); outline:none;
    }
    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px}
    th,td{padding:10px; border-bottom:1px solid rgba(255,255,255,.08); text-align:right; font-size:13px}
    th{color:var(--muted); font-weight:900; background:rgba(255,255,255,.04)}
    .msg{margin-top:10px; padding:10px 12px; border-radius:12px; border:1px solid var(--line); display:none}
    .msg.ok{display:block; border-color:rgba(22,163,74,.35); background:rgba(22,163,74,.12)}
    .msg.bad{display:block; border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.12)}
    .badge{display:inline-block; padding:6px 10px; border:1px solid var(--line); border-radius:999px; color:var(--muted); font-size:12px}
  </style>
</head>
<body>
  <div class="top">
    <div class="topin">
      <div class="brand">
        <img src="./assets/logo.webp" alt="Roma">
        <div>
          <b>Roma Schedule</b>
          <div class="badge" id="mePill">...</div>
        </div>
      </div>
      <div style="display:flex; gap:10px; align-items:center">
        <a class="btn" href="./admin.html" id="goAdmin" style="display:none">لوحة الأدمن</a>
        <button class="btn danger" id="btnOut">تسجيل خروج</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <div class="card">
        <h2>طلب إجازة</h2>
        <label>من تاريخ</label>
        <input id="lFrom" type="date">
        <label>إلى تاريخ</label>
        <input id="lTo" type="date">
        <button class="btn primary" id="btnLeave" style="margin-top:12px; width:100%">إرسال الطلب</button>
        <div id="msgLeave" class="msg"></div>

        <hr style="border:none;border-top:1px solid rgba(255,255,255,.12); margin:14px 0">

        <h2>طلباتي</h2>
        <div style="overflow:auto; margin-top:10px">
          <table>
            <thead><tr><th>من</th><th>إلى</th><th>الحالة</th></tr></thead>
            <tbody id="myLeavesTbody"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2>جدولي</h2>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn" id="btnThisWeek">هذا الأسبوع</button>
          <button class="btn" id="btnNextWeek">الأسبوع القادم</button>
        </div>

        <div style="overflow:auto; margin-top:10px">
          <table>
            <thead><tr><th>التاريخ</th><th>الفرع</th><th>الشفت</th><th>الوقت</th><th>ملاحظة</th></tr></thead>
            <tbody id="mySchedTbody"></tbody>
          </table>
        </div>
        <div id="msgSched" class="msg"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc,
      collection, addDoc, getDocs,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN88FY9CJU8T8cm5lLYjcI-I8VmD46o40",
      authDomain: "roma-schedule.firebaseapp.com",
      projectId: "roma-schedule",
      storageBucket: "roma-schedule.firebasestorage.app",
      messagingSenderId: "685810932602",
      appId: "1:685810932602:web:f1ec506ea6ff5e919d94c3",
      measurementId: "G-5FY5S5TZLJ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id)=>document.getElementById(id);
    const setMsg = (id, text, type="ok")=>{
      const el = $(id);
      el.className = "msg " + (type==="bad"?"bad":"ok");
      el.textContent = text;
    };

    function ymd(d){
      const dt = new Date(d);
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,"0");
      const da = String(dt.getDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    }
    function startOfWeek(d){
      const x = new Date(d);
      x.setHours(0,0,0,0);
      const day = x.getDay(); // 0 Sun .. 6 Sat
      const diff = (day===0 ? -6 : 1-day); // Monday
      x.setDate(x.getDate()+diff);
      return x;
    }

    const safeEmailDocId = (email)=> email.trim().toLowerCase().replace(/\./g,"(dot)");

    async function readPresetByEmail(email){
      const ref = doc(db, "employees_email", safeEmailDocId(email));
      const snap = await getDoc(ref);
      return snap.exists() ? snap.data() : null;
    }

    async function ensureEmployeeDoc(user){
      const ref = doc(db, "employees", user.uid);
      const snap = await getDoc(ref);
      if(snap.exists()) return;

      const preset = await readPresetByEmail(user.email || "");
      const base = {
        name: (user.email||"user").split("@")[0],
        email: user.email || "",
        role: "staff",
        type: "regular",
        department: "General",
        branchId: "",
        fixedBranch: true,
        coverAllBranches: false,
        coverBranchIds: [],
        canCover: true,
        active: true,
        createdAt: serverTimestamp()
      };
      const data = preset ? { ...base, ...preset } : base;
      await setDoc(ref, data, { merge:true });
    }

    async function getMyRole(uid){
      const snap = await getDoc(doc(db,"employees",uid));
      return snap.exists() ? (snap.data()?.role || "staff") : "staff";
    }

    let me = null;

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href="./login.html"; return; }
      me = user;
      $("mePill").textContent = user.email || user.uid;

      await ensureEmployeeDoc(user);
      const role = await getMyRole(user.uid);
      if(role==="admin") $("goAdmin").style.display="inline-flex";

      const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate()+1);
      const after = new Date(tomorrow); after.setDate(after.getDate()+1);
      $("lFrom").value = ymd(tomorrow);
      $("lTo").value = ymd(after);

      await loadMyLeaves();
      await loadMyScheduleThisWeek();
    });

    $("btnOut").addEventListener("click", async ()=>{ await signOut(auth); location.href="./login.html"; });

    $("btnLeave").addEventListener("click", async ()=>{
      const from = $("lFrom").value;
      const to = $("lTo").value;
      if(!from || !to) return setMsg("msgLeave","اختر من/إلى","bad");
      if(from > to) return setMsg("msgLeave","التاريخ (من) يجب أن يكون قبل (إلى)","bad");

      await addDoc(collection(db,"leaves"), {
        employeeId: me.uid,
        from, to,
        status: "pending",
        createdAt: serverTimestamp()
      });
      setMsg("msgLeave","تم إرسال الطلب ✅","ok");
      await loadMyLeaves();
    });

    async function loadMyLeaves(){
      const snap = await getDocs(collection(db,"leaves"));
      const rows = [];
      snap.forEach(d=>{
        const x=d.data();
        if(x.employeeId===me.uid) rows.push(x);
      });
      rows.sort((a,b)=> (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
      const tb = $("myLeavesTbody");
      tb.innerHTML = "";
      for(const r of rows){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.from||"-"}</td>
          <td>${r.to||"-"}</td>
          <td><span class="badge">${r.status||"pending"}</span></td>
        `;
        tb.appendChild(tr);
      }
    }

    async function loadMySchedule(from, to){
      try{
        const daysSet = new Set();
        const a = new Date(from), b = new Date(to);
        a.setHours(0,0,0,0); b.setHours(0,0,0,0);
        for(let d=new Date(a); d<=b; d.setDate(d.getDate()+1)) daysSet.add(ymd(d));

        const snap = await getDocs(collection(db, "employees", me.uid, "schedules"));
        const rows = [];
        snap.forEach(d=>{
          const x=d.data();
          if(daysSet.has(x.date)) rows.push(x);
        });
        rows.sort((a,b)=> (a.date||"").localeCompare(b.date||"") || (a.shiftName||"").localeCompare(b.shiftName||""));

        const tb = $("mySchedTbody");
        tb.innerHTML = "";
        for(const r of rows){
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${r.date||"-"}</td>
            <td>${r.branchName||r.branchId||"-"}</td>
            <td>${r.shiftName||"-"}</td>
            <td>${(r.start||"") && (r.end||"") ? `${r.start} - ${r.end}` : "-"}</td>
            <td>${r.note ? `<span class="badge">${r.note}</span>` : ""}</td>
          `;
          tb.appendChild(tr);
        }
        setMsg("msgSched",`تم تحميل الجدول من ${from} إلى ${to} ✅`,"ok");
      }catch(e){
        setMsg("msgSched", e?.message || "خطأ بتحميل الجدول", "bad");
      }
    }

    async function loadMyScheduleThisWeek(){
      const start = startOfWeek(new Date());
      const end = new Date(start); end.setDate(end.getDate()+6);
      await loadMySchedule(ymd(start), ymd(end));
    }
    async function loadMyScheduleNextWeek(){
      const start = startOfWeek(new Date());
      start.setDate(start.getDate()+7);
      const end = new Date(start); end.setDate(end.getDate()+6);
      await loadMySchedule(ymd(start), ymd(end));
    }

    $("btnThisWeek").addEventListener("click", loadMyScheduleThisWeek);
    $("btnNextWeek").addEventListener("click", loadMyScheduleNextWeek);
  </script>
</body>
</html>
