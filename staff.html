<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Roma Schedule - Staff</title>
  <link rel="icon" href="./assets/logo.webp">
  <style>
    :root{
      --bg:#0b1220; --panel:rgba(255,255,255,.06); --line:rgba(255,255,255,.14);
      --txt:#e5e7eb; --muted:#9ca3af; --accent:#d4a019; --shadow: 0 18px 60px rgba(0,0,0,.35);
      --ok:#16a34a; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; background:
        radial-gradient(1200px 600px at 10% 10%, rgba(212,160,25,.16), transparent 55%),
        radial-gradient(900px 500px at 90% 20%, rgba(59,130,246,.14), transparent 55%),
        var(--bg);
      color:var(--txt);
      font-family: system-ui, "Noto Sans Arabic", Tahoma, Arial, sans-serif;
    }
    .top{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(10,16,28,.55);
      border-bottom:1px solid var(--line);
    }
    .topin{max-width:1100px; margin:0 auto; padding:14px; display:flex; gap:10px; align-items:center; justify-content:space-between}
    .brand{display:flex; align-items:center; gap:10px}
    .brand img{width:30px;height:30px;object-fit:contain;border-radius:12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12)}
    .btn{
      cursor:pointer; border:1px solid var(--line); background:rgba(255,255,255,.06);
      color:var(--txt); padding:10px 12px; border-radius:12px; font-weight:900;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      text-decoration:none;
    }
    .btn:hover{background:rgba(255,255,255,.09)}
    .btn.primary{border-color:rgba(212,160,25,.45); background:rgba(212,160,25,.14)}
    .btn.primary:hover{background:rgba(212,160,25,.20)}
    .btn.danger{border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.12)}
    .btn.danger:hover{background:rgba(239,68,68,.16)}
    .wrap{max-width:1100px; margin:0 auto; padding:14px}
    .grid{display:grid; grid-template-columns: 360px 1fr; gap:14px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }
    .card{border:1px solid var(--line); background:var(--panel); border-radius:18px; padding:12px; box-shadow:var(--shadow)}
    h2{margin:0 0 10px; font-size:18px}
    .mini{color:var(--muted); font-size:12px; line-height:1.7}
    label{display:block; margin:10px 0 6px; color:var(--muted); font-size:13px}
    input,select{
      width:100%; padding:11px 12px; border-radius:12px;
      border:1px solid var(--line); background:rgba(0,0,0,.16);
      color:var(--txt); outline:none;
    }
    input:focus,select:focus{border-color:rgba(212,160,25,.65);box-shadow:0 0 0 4px rgba(212,160,25,.14)}
    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px}
    th,td{padding:10px; border-bottom:1px solid rgba(255,255,255,.08); text-align:right; font-size:13px; vertical-align:top}
    th{color:var(--muted); font-weight:900; background:rgba(255,255,255,.04)}
    .msg{margin-top:10px; padding:10px 12px; border-radius:12px; border:1px solid var(--line); display:none; white-space:pre-line}
    .msg.ok{display:block; border-color:rgba(22,163,74,.35); background:rgba(22,163,74,.12)}
    .msg.bad{display:block; border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.12)}
    .badge{display:inline-block; padding:6px 10px; border:1px solid var(--line); border-radius:999px; color:var(--muted); font-size:12px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:7px 10px;border:1px solid rgba(255,255,255,.14);border-radius:999px;background:rgba(255,255,255,.05)}
    .timeCell{direction:ltr; unicode-bidi:embed; text-align:left;}
  </style>
</head>
<body>
  <div class="top">
    <div class="topin">
      <div class="brand">
        <img src="./assets/logo.webp" alt="Roma">
        <div>
          <b>Roma Schedule</b>
          <div class="badge" id="mePill">...</div>
        </div>
      </div>
      <div style="display:flex; gap:10px; align-items:center">
        <a class="btn" href="./admin-dashboard.html" id="goAdmin" style="display:none">لوحة الأدمن</a>
        <button class="btn danger" id="btnOut">تسجيل خروج</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <div class="card">
        <h2>طلب إجازة</h2>
        <label>من تاريخ</label>
        <input id="lFrom" type="date">
        <label>إلى تاريخ</label>
        <input id="lTo" type="date">
        <button class="btn primary" id="btnLeave" style="margin-top:12px; width:100%">إرسال الطلب</button>
        <div id="msgLeave" class="msg"></div>

        <hr style="border:none;border-top:1px solid rgba(255,255,255,.12); margin:14px 0">

        <h2>طلباتي</h2>
        <div style="overflow:auto; margin-top:10px">
          <table>
            <thead><tr><th>من</th><th>إلى</th><th>الحالة</th></tr></thead>
            <tbody id="myLeavesTbody"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
          <div>
            <h2 style="margin:0">جدولي</h2>
            <div class="mini">مصدر العرض: collection <b>shifts</b> (employeeId = preset:email)</div>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
            <button class="btn" id="btnThisWeek">هذا الأسبوع</button>
            <button class="btn" id="btnNextWeek">الأسبوع القادم</button>
          </div>
        </div>

        <div style="overflow:auto; margin-top:10px">
          <table>
            <thead><tr><th>التاريخ</th><th>الفرع</th><th>الشفت</th><th class="timeCell">الوقت</th><th>ملاحظة</th></tr></thead>
            <tbody id="mySchedTbody"></tbody>
          </table>
        </div>
        <div id="msgSched" class="msg"></div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div>
          <h2 style="margin:0">الحضور اليوم (GPS)</h2>
          <div class="mini">
            • لا يمكن عمل Check-in / Check-out إلا داخل نطاق الفرع (Geofence).<br>
            • (اختياري) ربط الحساب بجهاز واحد — يظهر بالأدمن إذا تم الحظر.
          </div>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap">
          <span class="pill">جهازي: <span class="badge" id="devPill">...</span></span>
          <button class="btn" id="btnAttReload">تحديث</button>
        </div>
      </div>

      <div id="msgAtt" class="msg"></div>

      <div style="overflow:auto;margin-top:10px">
        <table>
          <thead>
            <tr>
              <th>الفرع</th>
              <th>الشفت</th>
              <th class="timeCell">الوقت</th>
              <th>الحالة</th>
              <th>الإجراء</th>
            </tr>
          </thead>
          <tbody id="attTodayTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc,
      collection, addDoc, getDocs, query, where,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN88FY9CJU8T8cm5lLYjcI-I8VmD46o40",
      authDomain: "roma-schedule.firebaseapp.com",
      projectId: "roma-schedule",
      storageBucket: "roma-schedule.firebasestorage.app",
      messagingSenderId: "685810932602",
      appId: "1:685810932602:web:f1ec506ea6ff5e919d94c3",
      measurementId: "G-5FY5S5TZLJ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id)=>document.getElementById(id);
    const setMsg = (id, text, type="ok")=>{
      const el = $(id);
      el.className = "msg " + (type==="bad"?"bad":"ok");
      el.textContent = text;
      el.style.display = "block";
    };
    const hideMsg = (id)=>{ const el=$(id); el.style.display="none"; };

    const safeEmailDocId = (email)=> String(email||"").trim().toLowerCase().replace(/\./g,"(dot)");
    const presetIdFromEmail = (email)=>{
      const e = String(email||"").trim().toLowerCase();
      if(!e) return null;
      return "preset:" + safeEmailDocId(e);
    };

    function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m])); }

    function ymd(d){
      const dt = new Date(d);
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,"0");
      const da = String(dt.getDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    }
    function startOfWeek(d){
      const x = new Date(d);
      const day = (x.getDay()+6)%7; // Mon=0
      x.setDate(x.getDate()-day);
      x.setHours(0,0,0,0);
      return x;
    }
    function endOfWeek(d){
      const s = startOfWeek(d);
      const e = new Date(s);
      e.setDate(e.getDate()+6);
      e.setHours(0,0,0,0);
      return e;
    }
    function dateRange(from, to){
      const a = new Date(from), b = new Date(to);
      a.setHours(0,0,0,0); b.setHours(0,0,0,0);
      const out=[];
      for(let d=new Date(a); d<=b; d.setDate(d.getDate()+1)) out.push(ymd(d));
      return out;
    }

    // ========= ensure employee doc (optional) =========
    async function readPresetByEmail(email){
      const ref = doc(db, "employees_email", safeEmailDocId(email));
      const snap = await getDoc(ref);
      return snap.exists() ? snap.data() : null;
    }
    async function ensureEmployeeDoc(user){
      const ref = doc(db, "employees", user.uid);
      const snap = await getDoc(ref);
      if(snap.exists()) return;

      const preset = await readPresetByEmail(user.email || "");
      const base = {
        name: (user.email||"user").split("@")[0],
        email: user.email || "",
        role: "staff",
        type: "regular",
        department: "General",
        branchId: "",
        fixedBranch: true,
        coverAllBranches: false,
        coverBranchIds: [],
        canCover: true,
        active: true,
        createdAt: serverTimestamp()
      };
      const data = preset ? { ...base, ...preset } : base;
      await setDoc(ref, data, { merge:true });
    }
    async function getMyRole(uid){
      const snap = await getDoc(doc(db,"employees",uid));
      return snap.exists() ? (snap.data()?.role || "staff") : "staff";
    }

    // =========================
    // GPS Geofence helpers
    // =========================
    function haversineMeters(lat1,lng1,lat2,lng2){
      const toRad = (x)=> (x*Math.PI)/180;
      const R = 6371000;
      const dLat = toRad(lat2-lat1);
      const dLng = toRad(lng2-lng1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
      return 2*R*Math.asin(Math.sqrt(a));
    }
    function getGeo(){
      return new Promise((resolve,reject)=>{
        if(!("geolocation" in navigator)) return reject(new Error("الجهاز لا يدعم GPS"));
        navigator.geolocation.getCurrentPosition(
          (pos)=> resolve(pos),
          (err)=> reject(new Error(err?.message || "فشل الحصول على موقعك")),
          { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
        );
      });
    }
    function pickBranchGeo(branchData){
      const d = branchData || {};
      const lat = d.geoLat ?? d.lat ?? d.latitude ?? d.location?.lat ?? null;
      const lng = d.geoLng ?? d.lng ?? d.longitude ?? d.location?.lng ?? null;
      const radiusM = Number(d.geoRadiusM ?? d.radiusM ?? d.radius ?? 150);
      if(lat==null || lng==null) return null;
      return { lat:Number(lat), lng:Number(lng), radiusM: isFinite(radiusM)?radiusM:150 };
    }

    // =========================
    // Device binding (خفيف)
    // =========================
    function getOrCreateDeviceId(){
      let id = localStorage.getItem("roma_device_id");
      if(!id){
        id = "dev_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
        localStorage.setItem("roma_device_id", id);
      }
      return id;
    }
    const deviceId = getOrCreateDeviceId();
    $("devPill").textContent = deviceId;

    async function enforceDeviceBinding(presetId){
      // يمكن تعطيله لو ما بدك: فقط خليه يرجع true دائماً
      const ref = doc(db, "attendance_devices", presetId);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        await setDoc(ref, { deviceId, createdAt: serverTimestamp(), updatedAt: serverTimestamp() }, { merge:true });
        return { ok:true, bound:true };
      }
      const saved = snap.data()?.deviceId || null;
      if(!saved || saved===deviceId){
        await setDoc(ref, { deviceId, updatedAt: serverTimestamp() }, { merge:true });
        return { ok:true, bound:false };
      }
      return { ok:false, savedDeviceId:saved };
    }

    // =========================
    // Schedule: read from shifts
    // =========================
    async function loadMySchedule(from, to){
      hideMsg("msgSched");
      const presetId = presetIdFromEmail(me?.email || "");
      if(!presetId){
        $("mySchedTbody").innerHTML = `<tr><td colspan="5" class="badge">لا يوجد Email بالحساب</td></tr>`;
        return;
      }

      const days = new Set(dateRange(from,to));

      // لتجنب index مركّب: نجيب شفتات الموظف فقط ثم نفلتر محلياً على الفترة
      const snap = await getDocs(query(collection(db,"shifts"), where("employeeId","==", presetId)));
      const rows=[];
      snap.forEach(d=>{
        const x=d.data()||{};
        if(!x.date || !days.has(x.date)) return;
        rows.push({ id:d.id, ...x });
      });

      rows.sort((a,b)=> (a.date||"").localeCompare(b.date||"") || (a.start||"").localeCompare(b.start||""));

      const tb = $("mySchedTbody");
      tb.innerHTML="";
      if(!rows.length){
        tb.innerHTML = `<tr><td colspan="5" class="badge">لا يوجد شفتات ضمن الفترة المختارة</td></tr>`;
        return;
      }
      for(const r of rows){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(r.date||"-")}</td>
          <td>${esc(r.branchName||r.branchId||"-")}</td>
          <td>${esc(r.shiftName||"-")}${r.shiftSlot>1?` <span class="badge">#${esc(r.shiftSlot)}</span>`:""}</td>
          <td class="timeCell">${esc(r.start||"")} → ${esc(r.end||"")}</td>
          <td>${r.note ? `<span class="badge">${esc(r.note)}</span>` : ""}</td>
        `;
        tb.appendChild(tr);
      }
    }

    async function loadMyScheduleThisWeek(){
      const s = startOfWeek(new Date());
      const e = endOfWeek(new Date());
      await loadMySchedule(ymd(s), ymd(e));
    }
    async function loadMyScheduleNextWeek(){
      const s = startOfWeek(new Date());
      s.setDate(s.getDate()+7);
      const e = new Date(s); e.setDate(e.getDate()+6);
      await loadMySchedule(ymd(s), ymd(e));
    }

    $("btnThisWeek").addEventListener("click", loadMyScheduleThisWeek);
    $("btnNextWeek").addEventListener("click", loadMyScheduleNextWeek);

    // =========================
    // Attendance (today) from shifts + attendance records
    // =========================
    async function loadTodayAttendance(){
      hideMsg("msgAtt");
      const today = ymd(new Date());
      const presetId = presetIdFromEmail(me?.email || "");
      if(!presetId){
        $("attTodayTbody").innerHTML = `<tr><td colspan="5" class="badge">لا يوجد Email بالحساب</td></tr>`;
        return;
      }

      const shSnap = await getDocs(query(collection(db,"shifts"), where("date","==", today)));
      const shifts=[];
      shSnap.forEach(d=>{
        const x=d.data()||{};
        if(String(x.employeeId||"") === String(presetId)) shifts.push({ id:d.id, ...x });
      });
      shifts.sort((a,b)=> (a.start||"").localeCompare(b.start||""));

      const atSnap = await getDocs(query(collection(db,"attendance"), where("date","==", today)));
      const attByShift = new Map();
      atSnap.forEach(d=>{
        const x=d.data()||{};
        if(String(x.employeeId||"") !== String(presetId)) return;
        if(x.shiftId) attByShift.set(String(x.shiftId), { id:d.id, ...x });
      });

      const tb = $("attTodayTbody");
      tb.innerHTML = "";
      if(!shifts.length){
        tb.innerHTML = `<tr><td colspan="5" class="badge">لا يوجد شفتات لك اليوم</td></tr>`;
        return;
      }

      for(const sh of shifts){
        const rec = attByShift.get(String(sh.id)) || null;
        const hasIn = !!rec?.checkInAt;
        const hasOut = !!rec?.checkOutAt;
        const blocked = rec?.blocked===true || rec?.status==="blocked";
        const state = blocked ? "blocked" : (hasIn && hasOut ? "out" : hasIn ? "in" : "-");

        let actionHtml = "";
        if(blocked){
          actionHtml = `<button class="btn" data-act="in" data-shift="${esc(sh.id)}">إعادة محاولة</button>`;
        }else if(!hasIn){
          actionHtml = `<button class="btn primary" data-act="in" data-shift="${esc(sh.id)}">Check-in</button>`;
        }else if(hasIn && !hasOut){
          actionHtml = `<button class="btn danger" data-act="out" data-shift="${esc(sh.id)}">Check-out</button>`;
        }else{
          actionHtml = `<span class="badge">تم ✅</span>`;
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(sh.branchName||sh.branchId||"-")}</td>
          <td>${esc(sh.shiftName||"-")}${sh.shiftSlot>1?` <span class="badge">#${esc(sh.shiftSlot)}</span>`:""}</td>
          <td class="timeCell">${esc(sh.start||"")} → ${esc(sh.end||"")}</td>
          <td><span class="badge">${esc(state)}</span></td>
          <td>${actionHtml}</td>
        `;
        tb.appendChild(tr);
      }

      tb.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const act = btn.getAttribute("data-act");
          const shiftId = btn.getAttribute("data-shift");
          const sh = shifts.find(x=> String(x.id)===String(shiftId));
          if(!sh) return;
          await doAttendanceAction(act, sh);
          await loadTodayAttendance();
        });
      });
    }

    async function doAttendanceAction(action, sh){
      const today = ymd(new Date());
      const presetId = presetIdFromEmail(me?.email || "");
      if(!presetId) return setMsg("msgAtt","لا يوجد Email بالحساب","bad");

      // GPS على المتصفح يحتاج HTTPS/localhost
      if(location.protocol !== "https:" && location.hostname !== "localhost" && location.hostname !== "127.0.0.1"){
        return setMsg("msgAtt","الـ GPS يحتاج HTTPS. ارفع الموقع على Hosting أو افتحه عبر HTTPS.","bad");
      }

      // device binding
      const bind = await enforceDeviceBinding(presetId);
      if(!bind.ok){
        // سجّل blocked للادمن
        const docId = `${today}__${presetId}__${sh.id}`;
        await setDoc(doc(db,"attendance", docId), {
          date: today,
          shiftId: sh.id,
          branchId: sh.branchId || "",
          branchName: sh.branchName || "",
          shiftName: sh.shiftName || "",
          employeeId: presetId,
          employeeUid: me.uid,
          employeeEmail: me.email || "",
          status: "blocked",
          blocked: true,
          blockedReason: "device_mismatch",
          deviceId,
          expectedDeviceId: bind.savedDeviceId || null,
          blockedAction: action,
          blockedAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge:true });
        return setMsg("msgAtt","❌ هذا الحساب مربوط بجهاز آخر. اطلب من الأدمن يعمل Reset Device.","bad");
      }

      setMsg("msgAtt","جاري تحديد موقعك...","ok");

      // اقرأ GPS الفرع
      const brSnap = await getDoc(doc(db,"branches", sh.branchId));
      const brData = brSnap.exists() ? brSnap.data() : null;
      const geo = pickBranchGeo(brData);
      if(!geo){
        return setMsg("msgAtt","هذا الفرع ليس لديه GPS (lat/lng) بعد. اطلب من الأدمن يحددها ضمن الفروع.","bad");
      }

      const pos = await getGeo();
      const curLat = pos.coords.latitude;
      const curLng = pos.coords.longitude;
      const accuracyM = pos.coords.accuracy ?? null;

      const distM = haversineMeters(curLat,curLng, geo.lat, geo.lng);
      const allow = distM <= (geo.radiusM + Math.max(0, Number(accuracyM||0)));

      const docId = `${today}__${presetId}__${sh.id}`;
      const ref = doc(db,"attendance", docId);

      const base = {
        date: today,
        shiftId: sh.id,
        shiftName: sh.shiftName || "",
        branchId: sh.branchId || "",
        branchName: sh.branchName || "",
        employeeId: presetId,
        employeeUid: me.uid,
        employeeEmail: me.email || "",
        employeeName: (me.email||"").split("@")[0],
        deviceId,
        gps: {
          lat: curLat,
          lng: curLng,
          accuracyM: accuracyM,
          distanceM: distM,
          radiusM: geo.radiusM,
          within: allow
        },
        updatedAt: serverTimestamp()
      };

      if(!allow){
        await setDoc(ref, {
          ...base,
          blocked: true,
          status: "blocked",
          blockedReason: "outside_geofence",
          blockedAction: action,
          blockedAt: serverTimestamp()
        }, { merge:true });
        return setMsg("msgAtt",`❌ خارج نطاق الفرع: تبعد تقريباً ${Math.round(distM)}m (المسموح ${Math.round(geo.radiusM)}m)`,"bad");
      }

      if(action === "in"){
        await setDoc(ref, { ...base, blocked:false, status:"in", checkInAt: serverTimestamp() }, { merge:true });
        return setMsg("msgAtt","✅ تم Check-in بنجاح","ok");
      }

      if(action === "out"){
        await setDoc(ref, { ...base, blocked:false, status:"out", checkOutAt: serverTimestamp() }, { merge:true });
        return setMsg("msgAtt","✅ تم Check-out بنجاح","ok");
      }
    }

    $("btnAttReload").addEventListener("click", loadTodayAttendance);

    // =========================
    // Leaves (request)
    // =========================
    async function loadMyLeaves(){
      const snap = await getDocs(collection(db,"leaves"));
      const rows = [];
      snap.forEach(d=>{
        const x=d.data()||{};
        if(x.employeeId===me.uid) rows.push(x);
      });
      rows.sort((a,b)=> (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
      const tb = $("myLeavesTbody");
      tb.innerHTML = "";
      if(!rows.length){
        tb.innerHTML = `<tr><td colspan="3" class="badge">لا يوجد طلبات</td></tr>`;
        return;
      }
      for(const r of rows){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(r.from||"-")}</td>
          <td>${esc(r.to||"-")}</td>
          <td><span class="badge">${esc(r.status||"pending")}</span></td>
        `;
        tb.appendChild(tr);
      }
    }

    // =========================
    // Init
    // =========================
    let me = null;

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href="./login.html"; return; }
      me = user;
      $("mePill").textContent = user.email || user.uid;

      await ensureEmployeeDoc(user);
      const role = await getMyRole(user.uid);
      if(role==="admin") $("goAdmin").style.display="inline-flex";

      const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate()+1);
      const after = new Date(tomorrow); after.setDate(after.getDate()+1);
      $("lFrom").value = ymd(tomorrow);
      $("lTo").value = ymd(after);

      await loadMyLeaves();
      await loadMyScheduleThisWeek();
      await loadTodayAttendance();
    });

    $("btnOut").addEventListener("click", async ()=>{ await signOut(auth); location.href="./login.html"; });

    $("btnLeave").addEventListener("click", async ()=>{
      hideMsg("msgLeave");
      const from = $("lFrom").value;
      const to = $("lTo").value;
      if(!from || !to) return setMsg("msgLeave","اختر من/إلى","bad");
      if(from > to) return setMsg("msgLeave","التاريخ (من) يجب أن يكون قبل (إلى)","bad");

      await addDoc(collection(db,"leaves"), {
        employeeId: me.uid,
        employeeName: (me.email||"").split("@")[0],
        from, to,
        status: "pending",
        createdAt: serverTimestamp()
      });
      setMsg("msgLeave","تم إرسال الطلب ✅","ok");
      await loadMyLeaves();
    });
  </script>
</body>
</html>
