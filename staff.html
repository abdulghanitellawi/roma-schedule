<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Roma Schedule - Staff</title>
  <link rel="icon" href="./assets/logo.webp">
  <style>
    :root{
      --bg:#0b1220; --panel:rgba(255,255,255,.06); --line:rgba(255,255,255,.14);
      --txt:#e5e7eb; --muted:#9ca3af; --accent:#d4a019; --shadow: 0 18px 60px rgba(0,0,0,.35);
      --ok:#16a34a; --bad:#ef4444; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; background:
        radial-gradient(1200px 600px at 10% 10%, rgba(212,160,25,.16), transparent 55%),
        radial-gradient(900px 500px at 90% 20%, rgba(59,130,246,.14), transparent 55%),
        var(--bg);
      color:var(--txt);
      font-family: system-ui, "Noto Sans Arabic", Tahoma, Arial, sans-serif;
    }
    .top{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(10,16,28,.55);
      border-bottom:1px solid var(--line);
    }
    .topin{max-width:1100px; margin:0 auto; padding:14px; display:flex; gap:10px; align-items:center; justify-content:space-between}
    .brand{display:flex; align-items:center; gap:10px}
    .brand img{width:30px;height:30px;object-fit:contain;border-radius:12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12)}
    .btn{
      cursor:pointer; border:1px solid var(--line); background:rgba(255,255,255,.06);
      color:var(--txt); padding:10px 12px; border-radius:12px; font-weight:900;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      text-decoration:none;
    }
    .btn:hover{background:rgba(255,255,255,.09)}
    .btn.primary{border-color:rgba(212,160,25,.45); background:rgba(212,160,25,.14)}
    .btn.primary:hover{background:rgba(212,160,25,.20)}
    .btn.danger{border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.12)}
    .btn.danger:hover{background:rgba(239,68,68,.16)}
    .btn.warn{border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.10)}
    .btn.warn:hover{background:rgba(245,158,11,.15)}
    .wrap{max-width:1100px; margin:0 auto; padding:14px}
    .grid{display:grid; grid-template-columns: 360px 1fr; gap:14px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }
    .card{border:1px solid var(--line); background:var(--panel); border-radius:18px; padding:12px; box-shadow:var(--shadow)}
    h2{margin:0 0 10px; font-size:18px}
    h3{margin:12px 0 8px; font-size:15px}
    label{display:block; margin:10px 0 6px; color:var(--muted); font-size:13px}
    input{
      width:100%; padding:11px 12px; border-radius:12px;
      border:1px solid var(--line); background:rgba(0,0,0,.16);
      color:var(--txt); outline:none;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px}
    th,td{padding:10px; border-bottom:1px solid rgba(255,255,255,.08); text-align:right; font-size:13px}
    th{color:var(--muted); font-weight:900; background:rgba(255,255,255,.04)}
    .msg{margin-top:10px; padding:10px 12px; border-radius:12px; border:1px solid var(--line); display:none}
    .msg.ok{display:block; border-color:rgba(22,163,74,.35); background:rgba(22,163,74,.12)}
    .msg.bad{display:block; border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.12)}
    .badge{display:inline-block; padding:6px 10px; border:1px solid var(--line); border-radius:999px; color:var(--muted); font-size:12px}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--line); border-radius:999px; color:var(--muted); font-size:12px}
    .pill.ok{border-color:rgba(22,163,74,.35); background:rgba(22,163,74,.12); color:#d1fae5}
    .pill.bad{border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.12); color:#fee2e2}
    .pill.warn{border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.10); color:#ffedd5}
    .sep{border:none;border-top:1px solid rgba(255,255,255,.12); margin:14px 0}
    .tiny{color:var(--muted); font-size:12px; line-height:1.7}

    /* Tabs */
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tabBtn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--txt);
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      cursor:pointer;
    }
    .tabBtn.active{
      border-color:rgba(212,160,25,.45);
      background:rgba(212,160,25,.14);
    }
    .tabPanel{display:none}
    .tabPanel.show{display:block}

    .modalOv{
      position:fixed; inset:0; display:none; place-items:center; padding:16px;
      background:rgba(0,0,0,.55); z-index:50;
    }
    .modalOv.show{display:grid}
    .modal{
      width:min(560px, 100%); border:1px solid var(--line); background:rgba(12,18,32,.92);
      border-radius:18px; box-shadow:var(--shadow); padding:14px;
    }
    .modal .topRow{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="top">
    <div class="topin">
      <div class="brand">
        <img src="./assets/logo.webp" alt="Roma">
        <div>
          <b>Roma Schedule</b>
          <div class="badge" id="mePill">...</div>
        </div>
      </div>
      <div style="display:flex; gap:10px; align-items:center">
        <a class="btn" href="./admin-dashboard.html" id="goAdmin" style="display:none">Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</a>
        <button class="btn danger" id="btnLogout">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- Left: Leaves -->
      <div class="card">
        <h2>Ø·Ù„Ø¨ Ø¥Ø¬Ø§Ø²Ø©</h2>
        <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
        <input id="lFrom" type="date">
        <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
        <input id="lTo" type="date">
        <button class="btn primary" id="btnLeave" style="margin-top:12px; width:100%">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
        <div id="msgLeave" class="msg"></div>

        <hr class="sep">

        <h2>Ø·Ù„Ø¨Ø§ØªÙŠ</h2>
        <div style="overflow:auto; margin-top:10px">
          <table>
            <thead><tr><th>Ù…Ù†</th><th>Ø¥Ù„Ù‰</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
            <tbody id="myLeavesTbody"></tbody>
          </table>
        </div>
      </div>

      <!-- Right: Attendance + Schedule -->
      <div class="card">
        <h2>Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…</h2>

        <div class="row" style="justify-content:space-between">
          <div class="pill" id="attPill">...</div>
          <div class="pill" id="shiftPill">...</div>
        </div>

        <div class="tiny" style="margin-top:8px">
          â€¢ âœ… GPS Ø¥Ù„Ø²Ø§Ù…ÙŠ: Ù„Ù† ÙŠØªÙ… Ù‚Ø¨ÙˆÙ„ Check-In/Out Ø¥Ù„Ø§ Ø¯Ø§Ø®Ù„ Ù†Ø·Ø§Ù‚ Ø§Ù„ÙØ±Ø¹.<br>
          â€¢ Ø¥Ø°Ø§ Ø§Ù„ÙØ±Ø¹ Ù…Ø§ Ø¹Ù„ÙŠÙ‡ Ù„ÙˆÙƒÙŠØ´Ù†: Ø§Ù„Ø£Ø¯Ù…Ù† Ù„Ø§Ø²Ù… ÙŠØ­Ø¯Ø¯ lat/lng + radius.
        </div>

        <hr class="sep">

        <!-- Tabs -->
        <div class="tabs">
          <button class="tabBtn active" data-tab="tabAttend">âœ… Check-In/Out</button>
          <button class="tabBtn" data-tab="tabFix">ğŸŸ¡ Ø·Ù„Ø¨ ØªØµØ­ÙŠØ­</button>
        </div>

        <!-- Panel 1: Attend -->
        <div class="tabPanel show" id="tabAttend" style="margin-top:12px">
          <div class="row">
            <button class="btn primary" id="btnIn">âœ… Check-In</button>
            <button class="btn danger" id="btnOutShift" disabled>â›” Check-Out</button>
            <button class="btn" id="btnTestGps">ğŸ“ ÙØ­Øµ Ù…ÙˆÙ‚Ø¹ÙŠ</button>
          </div>

          <div id="msgAtt" class="msg"></div>

          <div class="tiny" style="margin-top:10px">
            â€¢ â€œÙØ­Øµ Ù…ÙˆÙ‚Ø¹ÙŠâ€ Ø¨ÙŠÙ‚Ù„Ùƒ ÙƒÙ… Ù…ØªØ± Ø¨Ø¹ÙŠØ¯ Ø¹Ù† Ø§Ù„ÙØ±Ø¹ ÙˆÙ‡Ù„ Ø£Ù†Øª Ø¶Ù…Ù† Ø§Ù„Ù†Ø·Ø§Ù‚.
          </div>
        </div>

        <!-- Panel 2: Fix -->
        <div class="tabPanel" id="tabFix" style="margin-top:12px">
          <div class="row">
            <button class="btn warn" id="btnFix">ğŸŸ¡ ÙØªØ­ Ø·Ù„Ø¨ ØªØµØ­ÙŠØ­</button>
          </div>
          <div class="tiny" style="margin-top:8px">
            Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„Ø·Ù„Ø¨ (Ù…Ø«Ø§Ù„: Ù†Ø³ÙŠØª Check-Out)ØŒ ÙˆØ§Ù„Ø£Ø¯Ù…Ù† Ø¨ÙŠÙˆØ§ÙÙ‚.
          </div>
        </div>

        <hr class="sep">

        <h2>Ø¬Ø¯ÙˆÙ„ÙŠ</h2>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn" id="btnThisWeek">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>
          <button class="btn" id="btnNextWeek">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù‚Ø§Ø¯Ù…</button>
        </div>

        <div style="overflow:auto; margin-top:10px">
          <table>
            <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙØ±Ø¹</th><th>Ø§Ù„Ø´ÙØª</th><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th></tr></thead>
            <tbody id="mySchedTbody"></tbody>
          </table>
        </div>
        <div id="msgSched" class="msg"></div>

        <hr class="sep">

        <h3>Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù… (Ø­Ø¶ÙˆØ±/ØºÙŠØ§Ø¨)</h3>
        <div style="overflow:auto; margin-top:10px">
          <table>
            <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙØ±Ø¹</th><th>Ø§Ù„Ø´ÙØª</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ø¯Ø®ÙˆÙ„</th><th>Ø§Ù„Ø®Ø±ÙˆØ¬</th></tr></thead>
            <tbody id="att7Tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Fix Modal -->
  <div class="modalOv" id="fixOv" aria-hidden="true">
    <div class="modal">
      <div class="topRow">
        <b>ğŸŸ¡ Ø·Ù„Ø¨ ØªØµØ­ÙŠØ­ Ø¯ÙˆØ§Ù…</b>
        <button class="btn" id="fixClose">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>

      <div class="tiny" style="margin-top:8px">
        Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„Ø·Ù„Ø¨. Ù…Ø«Ø§Ù„: Ù†Ø³ÙŠØª Check-Out Ø£Ùˆ ÙƒÙ†Øª Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¬Ù‡Ø§Ø².
      </div>

      <label>Ù…Ù„Ø§Ø­Ø¸Ø© / Ø³Ø¨Ø¨</label>
      <input id="fixNote" type="text" placeholder="Ù…Ø«Ø§Ù„: ÙƒÙ†Øª Ø®Ø§Ø±Ø¬ Ø§Ù„ØªØºØ·ÙŠØ© ÙˆÙ†Ø³ÙŠØª Ø§Ù„Ø®Ø±ÙˆØ¬...">

      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="fixSend">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
        <div class="pill" id="fixMeta" style="margin-inline-start:auto">...</div>
      </div>
      <div id="msgFix" class="msg"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc,
      collection, addDoc, getDocs, query, where,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN88FY9CJU8T8cm5lLYjcI-I8VmD46o40",
      authDomain: "roma-schedule.firebaseapp.com",
      projectId: "roma-schedule",
      storageBucket: "roma-schedule.firebasestorage.app",
      messagingSenderId: "685810932602",
      appId: "1:685810932602:web:f1ec506ea6ff5e919d94c3",
      measurementId: "G-5FY5S5TZLJ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id)=>document.getElementById(id);

    const setMsg = (id, text, type="ok")=>{
      const el = $(id);
      el.className = "msg " + (type==="bad"?"bad":"ok");
      el.textContent = text;
      el.style.display = "block";
    };

    function pill(el, text, kind=""){
      el.className = "pill" + (kind ? " "+kind : "");
      el.textContent = text;
    }

    function ymd(d){
      const dt = new Date(d);
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,"0");
      const da = String(dt.getDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    }
    function startOfWeek(d){
      const x = new Date(d);
      x.setHours(0,0,0,0);
      const day = x.getDay();
      const diff = (day===0 ? -6 : 1-day);
      x.setDate(x.getDate()+diff);
      return x;
    }
    function timeToMin(t){
      const s = String(t||"").trim();
      const m = /^(\d{1,2}):(\d{2})$/.exec(s);
      if(!m) return null;
      const hh = Math.max(0, Math.min(23, Number(m[1])));
      const mm = Math.max(0, Math.min(59, Number(m[2])));
      return hh*60+mm;
    }
    function nowMin(){
      const d=new Date();
      return d.getHours()*60 + d.getMinutes();
    }
    function safeId(s){
      return String(s||"").replace(/[^a-zA-Z0-9_-]/g,"_").slice(0,240);
    }

    // ===== Tabs UI =====
    function initTabs(){
      const btns = Array.from(document.querySelectorAll(".tabBtn"));
      btns.forEach(b=>{
        b.addEventListener("click", ()=>{
          btns.forEach(x=>x.classList.remove("active"));
          b.classList.add("active");
          const id = b.getAttribute("data-tab");
          document.querySelectorAll(".tabPanel").forEach(p=>p.classList.remove("show"));
          const panel = document.getElementById(id);
          if(panel) panel.classList.add("show");
        });
      });
    }

    // ===== employee preset logic =====
    const safeEmailDocId = (email)=> String(email||"").trim().toLowerCase().replace(/\./g,"(dot)");
    const presetIdFromEmail = (email)=> "preset:" + safeEmailDocId(email);

    async function readPresetByEmail(email){
      const ref = doc(db, "employees_email", safeEmailDocId(email));
      const snap = await getDoc(ref);
      return snap.exists() ? snap.data() : null;
    }

    async function ensureEmployeeDoc(user){
      const ref = doc(db, "employees", user.uid);
      const snap = await getDoc(ref);
      if(snap.exists()) return;

      const preset = await readPresetByEmail(user.email || "");
      const base = {
        name: (user.email||"user").split("@")[0],
        email: user.email || "",
        role: "staff",
        type: "regular",
        department: "General",
        branchId: "",
        fixedBranch: true,
        coverAllBranches: false,
        coverBranchIds: [],
        canCover: true,
        active: true,
        createdAt: serverTimestamp()
      };
      const data = preset ? { ...base, ...preset } : base;
      await setDoc(ref, data, { merge:true });
    }

    async function getMyRole(uid){
      const snap = await getDoc(doc(db,"employees",uid));
      return snap.exists() ? (snap.data()?.role || "staff") : "staff";
    }

    // ===== shifts fetching from "shifts" =====
    async function fetchMyShiftsInRange(from, to, currentUser){
      const daysSet = new Set();
      const a = new Date(from), b = new Date(to);
      a.setHours(0,0,0,0); b.setHours(0,0,0,0);
      for(let d=new Date(a); d<=b; d.setDate(d.getDate()+1)) daysSet.add(ymd(d));

      const email = currentUser?.email || "";
      if(!email) return [];
      const presetId = presetIdFromEmail(email);

      const collected = [];
      const seen = new Set();

      async function tryQuery(field){
        try{
          const snap = await getDocs(query(collection(db,"shifts"), where(field, "==", presetId)));
          snap.forEach(docu=>{
            const x = docu.data() || {};
            const date = x.date || x.day || x.shiftDate || "";
            if(!daysSet.has(date)) return;
            if(seen.has(docu.id)) return;
            seen.add(docu.id);
            collected.push({ id: docu.id, ...x });
          });
          return true;
        }catch{
          return false;
        }
      }

      const ok1 = await tryQuery("assignedEmployeeId");
      const ok2 = await tryQuery("employeeId");
      const ok3 = await tryQuery("employee_id");

      if(!ok1 && !ok2 && !ok3){
        const snapAll = await getDocs(collection(db,"shifts"));
        snapAll.forEach(docu=>{
          const x = docu.data() || {};
          const empId = String(x.assignedEmployeeId || x.employeeId || x.employee_id || x.assigned_employee_id || "");
          if(empId !== presetId) return;

          const date = x.date || x.day || x.shiftDate || "";
          if(!daysSet.has(date)) return;

          if(seen.has(docu.id)) return;
          seen.add(docu.id);
          collected.push({ id: docu.id, ...x });
        });
      }

      return collected.map(x=>({
        date: x.date || x.day || x.shiftDate || "",
        branchId: x.branchId || x.branch || "",
        branchName: x.branchName || x.branch || x.branchId || "",
        shiftName: x.shiftName || x.name || x.shift || x.key || "Shift",
        start: x.start || x.from || x.startTime || "",
        end: x.end || x.to || x.endTime || "",
        note: x.note || x.statusNote || x.coverNote || ""
      }));
    }

    // ===== GPS: distance + branch geo =====
    function haversineMeters(lat1, lon1, lat2, lon2){
      const R = 6371000;
      const toRad = (v)=> v * Math.PI / 180;
      const dLat = toRad(lat2-lat1);
      const dLon = toRad(lon2-lon1);
      const a =
        Math.sin(dLat/2)**2 +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    async function getGpsOnce(){
      if(!navigator.geolocation){
        throw new Error("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS.");
      }
      return await new Promise((resolve, reject)=>{
        navigator.geolocation.getCurrentPosition(
          (pos)=> resolve({
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
            acc: pos.coords.accuracy
          }),
          (err)=> reject(new Error("ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹. ÙØ¹Ù‘Ù„ GPS ÙˆØ§Ø³Ù…Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹.")),
          { enableHighAccuracy:true, timeout:12000, maximumAge:0 }
        );
      });
    }

    async function readBranchGeo(branchId){
      if(!branchId) return null;
      const snap = await getDoc(doc(db,"branches", branchId));
      if(!snap.exists()) return null;
      const b = snap.data() || {};
      const g = b.geo || null; // expected: {lat,lng,radiusM}
      if(!g || typeof g.lat!=="number" || typeof g.lng!=="number") return null;
      const radiusM = (typeof g.radiusM==="number" && g.radiusM>0) ? g.radiusM : 80;
      return { lat:g.lat, lng:g.lng, radiusM };
    }

    async function assertInsideBranch(branchId){
      const geo = await readBranchGeo(branchId);
      if(!geo){
        throw new Error("Ù‡Ø°Ø§ Ø§Ù„ÙØ±Ø¹ Ù„Ø§ ÙŠÙ…Ù„Ùƒ Ù„ÙˆÙƒÙŠØ´Ù† Ø¨Ø¹Ø¯. Ø§Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù† ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ÙØ±Ø¹ (lat/lng + radius).");
      }
      const gps = await getGpsOnce();
      const dist = haversineMeters(gps.lat, gps.lng, geo.lat, geo.lng);
      const ok = dist <= geo.radiusM;

      return {
        ok,
        distM: Math.round(dist),
        radiusM: Math.round(geo.radiusM),
        gps,
        branchGeo: geo
      };
    }

    // ===== Attendance logic =====
    const LATE_GRACE_MIN = 10;

    // âœ… (Fix redeclare) use unique vars
    let currentUser = null;
    let myProfile = null;

    let todayShift = null;
    let attendanceId = null;
    let attendanceDoc = null;

    async function getApprovedLeavesForMe(){
      const snap = await getDocs(collection(db,"leaves"));
      const out = [];
      snap.forEach(d=>{
        const x = d.data() || {};
        if(x.employeeId !== currentUser.uid) return;
        if(String(x.status||"").toLowerCase() !== "approved") return;
        if(!x.from || !x.to) return;
        out.push({ from:x.from, to:x.to });
      });
      return out;
    }

    function inLeaveRange(dateStr, ranges){
      for(const r of ranges){
        if(dateStr >= r.from && dateStr <= r.to) return true;
      }
      return false;
    }

    async function loadTodayShift(){
      const date = ymd(new Date());
      const rows = await fetchMyShiftsInRange(date, date, currentUser);

      rows.sort((a,b)=>{
        const sa = timeToMin(a.start) ?? 99999;
        const sb = timeToMin(b.start) ?? 99999;
        return sa - sb;
      });

      todayShift = rows[0] || null;

      if(!todayShift){
        pill($("shiftPill"), `Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´ÙØª Ø§Ù„ÙŠÙˆÙ… (${date})`, "warn");
        attendanceId = null;
        return null;
      }

      const key = `${currentUser.uid}__${todayShift.date||date}__${todayShift.branchId||""}__${todayShift.shiftName||""}__${todayShift.start||""}`;
      attendanceId = safeId(key);

      const label = `${todayShift.branchName||todayShift.branchId||"ÙØ±Ø¹"} â€¢ ${todayShift.shiftName||"Shift"} â€¢ ${(todayShift.start&&todayShift.end)?(todayShift.start+"-"+todayShift.end):"â€”"}`;
      pill($("shiftPill"), label, "");
      return todayShift;
    }

    async function loadAttendanceDoc(){
      if(!attendanceId){ attendanceDoc=null; return; }
      const snap = await getDoc(doc(db,"attendance", attendanceId));
      attendanceDoc = snap.exists() ? (snap.data()||null) : null;

      if(!attendanceDoc){
        pill($("attPill"), "Ø§Ù„ÙŠÙˆÙ…: Ù„Ù… ØªØ³Ø¬Ù„ Ø­Ø¶ÙˆØ± Ø¨Ø¹Ø¯", "warn");
        $("btnIn").disabled = false;
        $("btnOutShift").disabled = true;
        return;
      }

      const st = String(attendanceDoc.status||"").toLowerCase();
      const hasIn  = !!attendanceDoc.checkInAtLocal;
      const hasOut = !!attendanceDoc.checkOutAtLocal;

      if(st === "absent"){
        pill($("attPill"), "Ø§Ù„ÙŠÙˆÙ…: ØºÙŠØ§Ø¨ âŒ", "bad");
        $("btnIn").disabled = true;
        $("btnOutShift").disabled = true;
      }else if(st === "leave"){
        pill($("attPill"), "Ø§Ù„ÙŠÙˆÙ…: Ø¥Ø¬Ø§Ø²Ø© âœ…", "ok");
        $("btnIn").disabled = true;
        $("btnOutShift").disabled = true;
      }else if(hasIn && !hasOut){
        const late = Number(attendanceDoc.minutesLate||0);
        pill($("attPill"), late>0 ? `Ø­Ø§Ø¶Ø± (Ù…ØªØ£Ø®Ø± ${late}Ø¯) â°` : "Ø­Ø§Ø¶Ø± âœ…", late>0 ? "warn" : "ok");
        $("btnIn").disabled = true;
        $("btnOutShift").disabled = false;
      }else if(hasIn && hasOut){
        const late = Number(attendanceDoc.minutesLate||0);
        const w = Number(attendanceDoc.workedMinutes||0);
        pill($("attPill"), `Ù…ÙƒØªÙ…Ù„ âœ… (${w}Ø¯)${late>0?` â€¢ ØªØ£Ø®ÙŠØ± ${late}Ø¯`:``}`, late>0 ? "warn" : "ok");
        $("btnIn").disabled = true;
        $("btnOutShift").disabled = true;
      }else{
        pill($("attPill"), "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø¨Ø¯ÙˆÙ† Ø¯Ø®ÙˆÙ„", "warn");
        $("btnIn").disabled = false;
        $("btnOutShift").disabled = true;
      }
    }

    function computeLate(shift){
      const s = timeToMin(shift?.start);
      if(s===null) return 0;
      const diff = (nowMin() - s) - LATE_GRACE_MIN;
      return Math.max(0, diff);
    }

    async function checkLeaveBlock(dateStr){
      const ranges = await getApprovedLeavesForMe();
      const onLeave = inLeaveRange(dateStr, ranges);
      return { onLeave, ranges };
    }

    async function doCheckIn(){
      if(!todayShift) return setMsg("msgAtt","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´ÙØª Ø§Ù„ÙŠÙˆÙ… Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±.", "bad");

      // âœ… GPS enforce (must be inside branch)
      const inside = await assertInsideBranch(todayShift.branchId || "");
      if(!inside.ok){
        return setMsg("msgAtt", `âŒ Ø£Ù†Øª Ø®Ø§Ø±Ø¬ Ø§Ù„ÙØ±Ø¹: Ø¨Ø¹ÙŠØ¯ ${inside.distM}m (Ø§Ù„Ù…Ø³Ù…ÙˆØ­ ${inside.radiusM}m).`, "bad");
      }

      const date = todayShift.date || ymd(new Date());
      const leave = await checkLeaveBlock(date);
      if(leave.onLeave){
        setMsg("msgAtt","Ø£Ù†Øª Ø¨Ø¥Ø¬Ø§Ø²Ø© âœ… Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¹Ù…Ù„ Check-In.", "bad");
        await setDoc(doc(db,"attendance", attendanceId), {
          employeeId: currentUser.uid,
          employeeEmail: currentUser.email || "",
          employeeName: myProfile?.name || (currentUser.email||"").split("@")[0] || "",
          date,
          branchId: todayShift.branchId || "",
          branchName: todayShift.branchName || "",
          shiftName: todayShift.shiftName || "",
          start: todayShift.start || "",
          end: todayShift.end || "",
          status: "leave",
          note: "On approved leave",
          updatedAt: serverTimestamp()
        }, { merge:true });
        await loadAttendanceDoc();
        return;
      }

      const late = computeLate(todayShift);

      await setDoc(doc(db,"attendance", attendanceId), {
        employeeId: currentUser.uid,
        employeeEmail: currentUser.email || "",
        employeeName: myProfile?.name || (currentUser.email||"").split("@")[0] || "",
        date,
        branchId: todayShift.branchId || "",
        branchName: todayShift.branchName || "",
        shiftName: todayShift.shiftName || "",
        start: todayShift.start || "",
        end: todayShift.end || "",
        minutesLate: late,
        status: "present",
        checkInAt: serverTimestamp(),
        checkInAtLocal: Date.now(),
        gpsIn: inside.gps,
        gpsInDistM: inside.distM,
        gpsInRadiusM: inside.radiusM,
        updatedAt: serverTimestamp()
      }, { merge:true });

      setMsg("msgAtt", late>0 ? `ØªÙ… Check-In âœ… (Ø¯Ø§Ø®Ù„ Ø§Ù„ÙØ±Ø¹) â€¢ Ù…ØªØ£Ø®Ø± ${late} Ø¯Ù‚ÙŠÙ‚Ø©` : "ØªÙ… Check-In âœ… (Ø¯Ø§Ø®Ù„ Ø§Ù„ÙØ±Ø¹)", "ok");
      await loadAttendanceDoc();
      await loadAttLast7Days();
    }

    async function doCheckOut(){
      if(!attendanceId) return;

      // âœ… GPS enforce (must be inside branch)
      if(todayShift?.branchId){
        const inside = await assertInsideBranch(todayShift.branchId || "");
        if(!inside.ok){
          return setMsg("msgAtt", `âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Check-Out Ø®Ø§Ø±Ø¬ Ø§Ù„ÙØ±Ø¹: Ø¨Ø¹ÙŠØ¯ ${inside.distM}m (Ø§Ù„Ù…Ø³Ù…ÙˆØ­ ${inside.radiusM}m).`, "bad");
        }
      }

      const snap = await getDoc(doc(db,"attendance", attendanceId));
      if(!snap.exists()) return setMsg("msgAtt","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ± Ù„Ø¹Ù…Ù„ Check-Out.", "bad");

      const x = snap.data() || {};
      if(!x.checkInAtLocal) return setMsg("msgAtt","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Check-In Ù…Ø³Ø¬Ù„.", "bad");
      if(x.checkOutAtLocal) return setMsg("msgAtt","ØªÙ… Ø¹Ù…Ù„ Check-Out Ù…Ø³Ø¨Ù‚Ù‹Ø§.", "bad");

      const geo = await assertInsideBranch(todayShift.branchId || "");
      const worked = Math.max(0, Math.round((Date.now() - Number(x.checkInAtLocal||Date.now()))/60000));

      await updateDoc(doc(db,"attendance", attendanceId), {
        status: "completed",
        workedMinutes: worked,
        checkOutAt: serverTimestamp(),
        checkOutAtLocal: Date.now(),
        gpsOut: geo.gps,
        gpsOutDistM: geo.distM,
        gpsOutRadiusM: geo.radiusM,
        updatedAt: serverTimestamp()
      });

      setMsg("msgAtt", `ØªÙ… Check-Out âœ… (Ø¯Ø§Ø®Ù„ Ø§Ù„ÙØ±Ø¹) â€¢ Ø¹Ù…Ù„Øª ${worked} Ø¯Ù‚ÙŠÙ‚Ø©`, "ok");
      await loadAttendanceDoc();
      await loadAttLast7Days();
    }

    async function loadAttLast7Days(){
      const tb = $("att7Tbody");
      tb.innerHTML = "";

      const snap = await getDocs(collection(db,"attendance"));
      const rows = [];
      snap.forEach(d=>{
        const x = d.data() || {};
        if(x.employeeId !== currentUser.uid) return;
        if(!x.date) return;
        rows.push({ id:d.id, ...x });
      });
      rows.sort((a,b)=> String(b.date).localeCompare(String(a.date)));

      const last7 = rows.slice(0,7);
      for(const r of last7){
        const st = String(r.status||"").toLowerCase();
        const stLabel =
          st==="absent" ? "Absent âŒ" :
          st==="leave" ? "Leave âœ…" :
          st==="completed" ? "Completed âœ…" :
          st==="present" ? (Number(r.minutesLate||0)>0 ? `Late â° (${r.minutesLate}Ø¯)` : "Present âœ…") :
          (r.status||"-");

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.date||"-"}</td>
          <td>${r.branchName||r.branchId||"-"}</td>
          <td>${r.shiftName||"-"}</td>
          <td><span class="badge">${stLabel}</span></td>
          <td>${r.checkInAtLocal ? new Date(r.checkInAtLocal).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'}) : "-"}</td>
          <td>${r.checkOutAtLocal ? new Date(r.checkOutAtLocal).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'}) : "-"}</td>
        `;
        tb.appendChild(tr);
      }
    }

    // ===== Leaves =====
    async function loadMyLeaves(){
      const snap = await getDocs(collection(db,"leaves"));
      const rows = [];
      snap.forEach(d=>{
        const x=d.data();
        if(x.employeeId===currentUser.uid) rows.push(x);
      });
      rows.sort((a,b)=> (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
      const tb = $("myLeavesTbody");
      tb.innerHTML = "";
      for(const r of rows){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.from||"-"}</td>
          <td>${r.to||"-"}</td>
          <td><span class="badge">${r.status||"pending"}</span></td>
        `;
        tb.appendChild(tr);
      }
    }

    async function loadMySchedule(from, to){
      try{
        const rows = await fetchMyShiftsInRange(from, to, currentUser);
        rows.sort((a,b)=>
          (a.date||"").localeCompare(b.date||"") ||
          ((timeToMin(a.start)??99999) - (timeToMin(b.start)??99999)) ||
          (a.shiftName||"").localeCompare(b.shiftName||"")
        );

        const tb = $("mySchedTbody");
        tb.innerHTML = "";
        for(const r of rows){
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${r.date||"-"}</td>
            <td>${r.branchName||r.branchId||"-"}</td>
            <td>${r.shiftName||"-"}</td>
            <td>${(r.start||"") && (r.end||"") ? `${r.start} - ${r.end}` : "-"}</td>
            <td>${r.note ? `<span class="badge">${r.note}</span>` : ""}</td>
          `;
          tb.appendChild(tr);
        }
        setMsg("msgSched",`ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ âœ… (Ø§Ù„Ù…ØµØ¯Ø±: shifts)`,"ok");
      }catch(e){
        setMsg("msgSched", e?.message || "Ø®Ø·Ø£ Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„", "bad");
      }
    }

    async function loadMyScheduleThisWeek(){
      const start = startOfWeek(new Date());
      const end = new Date(start); end.setDate(end.getDate()+6);
      await loadMySchedule(ymd(start), ymd(end));
    }
    async function loadMyScheduleNextWeek(){
      const start = startOfWeek(new Date());
      start.setDate(start.getDate()+7);
      const end = new Date(start); end.setDate(end.getDate()+6);
      await loadMySchedule(ymd(start), ymd(end));
    }

    // ===== Fix modal =====
    function openFix(){
      const date = todayShift?.date || ymd(new Date());
      const meta = `${date} â€¢ ${(todayShift?.branchName||todayShift?.branchId||"")} â€¢ ${(todayShift?.shiftName||"")}`;
      pill($("fixMeta"), meta, "");
      $("msgFix").className = "msg";
      $("msgFix").textContent = "";
      $("fixOv").classList.add("show");
      $("fixOv").setAttribute("aria-hidden","false");
      setTimeout(()=> $("fixNote").focus(), 50);
    }
    function closeFix(){
      $("fixOv").classList.remove("show");
      $("fixOv").setAttribute("aria-hidden","true");
    }

    // ===== events =====
    initTabs();

    $("btnLogout").addEventListener("click", async ()=>{ await signOut(auth); location.href="./login.html"; });

    $("btnLeave").addEventListener("click", async ()=>{
      const from = $("lFrom").value;
      const to = $("lTo").value;
      if(!from || !to) return setMsg("msgLeave","Ø§Ø®ØªØ± Ù…Ù†/Ø¥Ù„Ù‰","bad");
      if(from > to) return setMsg("msgLeave","Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù…Ù†) ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‚Ø¨Ù„ (Ø¥Ù„Ù‰)","bad");

      await addDoc(collection(db,"leaves"), {
        employeeId: currentUser.uid,
        from, to,
        status: "pending",
        createdAt: serverTimestamp()
      });
      setMsg("msgLeave","ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ âœ…","ok");
      await loadMyLeaves();
    });

    $("btnThisWeek").addEventListener("click", loadMyScheduleThisWeek);
    $("btnNextWeek").addEventListener("click", loadMyScheduleNextWeek);

    $("btnIn").addEventListener("click", async ()=>{
      try{ await doCheckIn(); }catch(e){ console.error(e); setMsg("msgAtt", e?.message || "Ø®Ø·Ø£", "bad"); }
    });
    $("btnOutShift").addEventListener("click", async ()=>{
      try{ await doCheckOut(); }catch(e){ console.error(e); setMsg("msgAtt", e?.message || "Ø®Ø·Ø£", "bad"); }
    });

    $("btnFix").addEventListener("click", ()=>{
      if(!todayShift) return setMsg("msgAtt","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´ÙØª Ø§Ù„ÙŠÙˆÙ… Ù„Ø·Ù„Ø¨ Ø§Ù„ØªØµØ­ÙŠØ­.", "bad");
      openFix();
    });
    $("fixClose").addEventListener("click", closeFix);
    $("fixOv").addEventListener("click", (e)=>{ if(e.target === $("fixOv")) closeFix(); });
    document.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeFix(); });

    $("fixSend").addEventListener("click", async ()=>{
      try{
        const date = todayShift?.date || ymd(new Date());
        const note = $("fixNote").value.trim();
        if(!note) return setMsg("msgFix","Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„Ø·Ù„Ø¨.", "bad");

        await addDoc(collection(db,"attendance_corrections"), {
          employeeId: currentUser.uid,
          employeeEmail: currentUser.email || "",
          employeeName: myProfile?.name || (currentUser.email||"").split("@")[0] || "",
          attendanceId: attendanceId || "",
          date,
          branchId: todayShift?.branchId || "",
          branchName: todayShift?.branchName || "",
          shiftName: todayShift?.shiftName || "",
          start: todayShift?.start || "",
          end: todayShift?.end || "",
          note,
          status: "pending",
          createdAt: serverTimestamp()
        });

        setMsg("msgFix","ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØµØ­ÙŠØ­ âœ… (Pending)", "ok");
        $("fixNote").value = "";
      }catch(e){
        console.error(e);
        setMsg("msgFix", e?.message || "Ø®Ø·Ø£", "bad");
      }
    });

    $("btnTestGps").addEventListener("click", async ()=>{
      try{
        if(!todayShift?.branchId) return setMsg("msgAtt","Ù„Ø§ ÙŠÙˆØ¬Ø¯ branchId Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´ÙØª.", "bad");
        const res = await assertInsideBranch(todayShift.branchId);
        if(res.ok){
          setMsg("msgAtt", `âœ… Ø£Ù†Øª Ø¯Ø§Ø®Ù„ Ø§Ù„ÙØ±Ø¹: Ø¨Ø¹ÙŠØ¯ ${res.distM}m (Ø§Ù„Ù…Ø³Ù…ÙˆØ­ ${res.radiusM}m).`, "ok");
        }else{
          setMsg("msgAtt", `âŒ Ø£Ù†Øª Ø®Ø§Ø±Ø¬ Ø§Ù„ÙØ±Ø¹: Ø¨Ø¹ÙŠØ¯ ${res.distM}m (Ø§Ù„Ù…Ø³Ù…ÙˆØ­ ${res.radiusM}m).`, "bad");
        }
      }catch(e){
        setMsg("msgAtt", e?.message || "ÙØ´Ù„ ÙØ­Øµ GPS", "bad");
      }
    });

    // ===== Boot =====
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href="./login.html"; return; }
      currentUser = user;
      $("mePill").textContent = user.email || user.uid;

      await ensureEmployeeDoc(user);
      const role = await getMyRole(user.uid);
      if(role==="admin") $("goAdmin").style.display="inline-flex";

      try{
        const p = await getDoc(doc(db,"employees", user.uid));
        myProfile = p.exists() ? (p.data()||null) : null;
      }catch{ myProfile=null; }

      const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate()+1);
      const after = new Date(tomorrow); after.setDate(after.getDate()+1);
      $("lFrom").value = ymd(tomorrow);
      $("lTo").value = ymd(after);

      await loadMyLeaves();
      await loadMyScheduleThisWeek();

      await loadTodayShift();
      await loadAttendanceDoc();
      await loadAttLast7Days();
    });
  </script>
</body>
</html>
