<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Roma Schedule - Staff</title>
  <link rel="icon" href="./assets/logo.webp">
  <style>
    :root{
      --bg:#0b1220; --panel:rgba(255,255,255,.06); --line:rgba(255,255,255,.14);
      --txt:#e5e7eb; --muted:#9ca3af; --accent:#d4a019; --shadow: 0 18px 60px rgba(0,0,0,.35);
      --ok:#16a34a; --bad:#ef4444; --warn:#f59e0b;
      --leaveBg: rgba(22,163,74,.10);
      --leaveLine: rgba(22,163,74,.28);
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; background:
        radial-gradient(1200px 600px at 10% 10%, rgba(212,160,25,.16), transparent 55%),
        radial-gradient(900px 500px at 90% 20%, rgba(59,130,246,.14), transparent 55%),
        var(--bg);
      color:var(--txt);
      font-family: system-ui, "Noto Sans Arabic", Tahoma, Arial, sans-serif;
    }

    /* Topbar */
    .top{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(10,16,28,.55);
      border-bottom:1px solid var(--line);
    }
    .topin{max-width:1100px; margin:0 auto; padding:14px; display:flex; gap:10px; align-items:center; justify-content:space-between}
    .brand{display:flex; align-items:center; gap:10px}
    .brand img{width:30px;height:30px;object-fit:contain;border-radius:12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12)}
    .rightTop{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .badge{display:inline-block; padding:6px 10px; border:1px solid var(--line); border-radius:999px; color:var(--muted); font-size:12px}

    .btn{
      cursor:pointer; border:1px solid var(--line); background:rgba(255,255,255,.06);
      color:var(--txt); padding:10px 12px; border-radius:12px; font-weight:900;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      text-decoration:none;
      user-select:none;
    }
    .btn:hover{background:rgba(255,255,255,.09)}
    .btn.primary{border-color:rgba(212,160,25,.45); background:rgba(212,160,25,.14)}
    .btn.primary:hover{background:rgba(212,160,25,.20)}
    .btn.danger{border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.12)}
    .btn.danger:hover{background:rgba(239,68,68,.16)}
    .btn.warn{border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.10)}
    .btn.warn:hover{background:rgba(245,158,11,.15)}

    .wrap{max-width:1100px; margin:0 auto; padding:14px}
    .card{border:1px solid var(--line); background:var(--panel); border-radius:18px; padding:12px; box-shadow:var(--shadow)}
    h2{margin:0 0 10px; font-size:18px}
    h3{margin:12px 0 8px; font-size:15px}
    label{display:block; margin:10px 0 6px; color:var(--muted); font-size:13px}
    input, select{
      width:100%; padding:11px 12px; border-radius:12px;
      border:1px solid var(--line); background:rgba(0,0,0,.16);
      color:var(--txt); outline:none;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px}
    th,td{padding:10px; border-bottom:1px solid rgba(255,255,255,.08); text-align:right; font-size:13px; vertical-align:top}
    th{color:var(--muted); font-weight:900; background:rgba(255,255,255,.04)}
    .msg{margin-top:10px; padding:10px 12px; border-radius:12px; border:1px solid var(--line); display:none; white-space:pre-line}
    .msg.ok{display:block; border-color:rgba(22,163,74,.35); background:rgba(22,163,74,.12)}
    .msg.bad{display:block; border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.12)}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--line); border-radius:999px; color:var(--muted); font-size:12px}
    .pill.ok{border-color:rgba(22,163,74,.35); background:rgba(22,163,74,.12); color:#d1fae5}
    .pill.bad{border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.12); color:#fee2e2}
    .pill.warn{border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.10); color:#ffedd5}
    .sep{border:none;border-top:1px solid rgba(255,255,255,.12); margin:14px 0}
    .tiny{color:var(--muted); font-size:12px; line-height:1.7}

    /* Main Tabs */
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tabBtn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--txt);
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      cursor:pointer;
    }
    .tabBtn.active{
      border-color:rgba(212,160,25,.45);
      background:rgba(212,160,25,.14);
    }
    .tabPanel{display:none}
    .tabPanel.show{display:block}

    /* Modals */
    .modalOv{
      position:fixed; inset:0; display:none; place-items:center; padding:16px;
      background:rgba(0,0,0,.55); z-index:50;
    }
    .modalOv.show{display:grid}
    .modal{
      width:min(560px, 100%); border:1px solid var(--line); background:rgba(12,18,32,.92);
      border-radius:18px; box-shadow:var(--shadow); padding:14px;
    }
    .modal.big{ width:min(820px, 100%); }
    .modal .topRow{display:flex; align-items:center; justify-content:space-between; gap:10px}

    /* Leave mode UI */
    .modeRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .modeBtn{
      cursor:pointer;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);
      color:var(--txt);padding:10px 12px;border-radius:999px;font-weight:900;font-size:13px;
    }
    .modeBtn.active{border-color:rgba(212,160,25,.45);background:rgba(212,160,25,.14)}
    .modePanel{display:none}
    .modePanel.show{display:block}
    .datesBox{margin-top:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.05);border-radius:14px;padding:10px}
    .dateLine{display:flex;gap:8px;align-items:center;margin-top:8px}
    .dateLine input[type="date"]{flex:1}
    .smBtn{cursor:pointer;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:var(--txt);padding:9px 10px;border-radius:12px;font-weight:900}
    .smBtn:hover{background:rgba(255,255,255,.10)}
    .smBtn.danger{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.12)}
    .smBtn.danger:hover{background:rgba(239,68,68,.16)}

    /* Leave row highlight in schedule */
    tr.leaveRow td{
      background: var(--leaveBg);
      border-bottom: 1px solid rgba(22,163,74,.20);
    }
    tr.leaveRow td:first-child{ box-shadow: inset 4px 0 0 var(--leaveLine); }

    /* Language switch animation */
    .langAnim{
      animation: langPop .28s ease;
    }
    @keyframes langPop{
      from{ opacity:.55; transform: translateY(4px) scale(.995); filter: blur(.2px); }
      to{ opacity:1; transform: translateY(0) scale(1); filter:none; }
    }
  </style>
</head>
<body>

  <!-- Topbar -->
  <div class="top">
    <div class="topin">
      <div class="brand">
        <img src="./assets/logo.webp" alt="Roma">
        <div>
          <b>Roma Schedule</b>
          <div class="badge" id="mePill">...</div>
        </div>
      </div>

      <div class="rightTop">
        <button class="btn" id="btnLang" title="Switch Language">EN</button>
        <button class="btn danger" id="btnLogout">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="card" id="cardRoot">
      <h2 id="t_title">Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙˆØ¸Ù</h2>

      <div class="row" style="justify-content:space-between; margin-top:8px">
        <div class="pill" id="attPill">...</div>
        <div class="pill" id="shiftPill">...</div>
      </div>

      <div class="tiny" style="margin-top:8px" id="t_gpsNote">
        â€¢ âœ… GPS Ø¥Ù„Ø²Ø§Ù…ÙŠ: Ù„Ù† ÙŠØªÙ… Ù‚Ø¨ÙˆÙ„ Check-In/Out Ø¥Ù„Ø§ Ø¯Ø§Ø®Ù„ Ù†Ø·Ø§Ù‚ Ø§Ù„ÙØ±Ø¹.<br>
        â€¢ Ø¥Ø°Ø§ Ø§Ù„ÙØ±Ø¹ Ù…Ø§ Ø¹Ù„ÙŠÙ‡ Ù„ÙˆÙƒÙŠØ´Ù†: Ø§Ù„Ø£Ø¯Ù…Ù† Ù„Ø§Ø²Ù… ÙŠØ­Ø¯Ø¯ lat/lng + radius.
      </div>

      <hr class="sep">

      <!-- MAIN TABS -->
      <div class="tabs">
        <button class="tabBtn active" data-tab="tabSched" id="t_tabSched">ğŸ“… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯ÙˆØ§Ù…</button>
        <button class="tabBtn" data-tab="tabAttend" id="t_tabAttend">âœ… Check-In/Out</button>
        <button class="tabBtn" data-tab="tabFix" id="t_tabFix">ğŸŸ¡ Ø·Ù„Ø¨ Ø§Ù„ØªØµØ­ÙŠØ­</button>
        <button class="tabBtn" data-tab="tabLeave" id="t_tabLeave">ğŸ–ï¸ Ø·Ù„Ø¨ Ø¥Ø¬Ø§Ø²Ø©</button>
      </div>

      <!-- TAB: SCHEDULE (DEFAULT) -->
      <div class="tabPanel show" id="tabSched" style="margin-top:12px">
        <div class="row" style="align-items:flex-end; justify-content:space-between">
          <div style="min-width:260px">
            <label id="t_schedRangeLabel">Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„</label>
            <select id="schedRange">
              <option value="today" id="t_opt_today">Ø§Ù„ÙŠÙˆÙ…</option>
              <option value="tomorrow" id="t_opt_tomorrow">Ø§Ù„ØºØ¯</option>
              <option value="thisWeek" id="t_opt_thisWeek" selected>Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</option>
              <option value="nextWeek" id="t_opt_nextWeek">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù‚Ø§Ø¯Ù…</option>
              <option value="thisMonth" id="t_opt_thisMonth">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</option>
            </select>
          </div>

          <div class="row">
            <button class="btn primary" id="btnLoadSched">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
          </div>
        </div>

        <div style="overflow:auto; margin-top:10px">
          <table>
            <thead>
              <tr>
                <th id="t_th_date">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th id="t_th_day">Ø§Ù„ÙŠÙˆÙ…</th>
                <th id="t_th_branch">Ø§Ù„ÙØ±Ø¹</th>
                <th id="t_th_shift">Ø§Ù„Ø´ÙØª</th>
                <th id="t_th_time">Ø§Ù„ÙˆÙ‚Øª</th>
                <th id="t_th_note">Ù…Ù„Ø§Ø­Ø¸Ø©</th>
              </tr>
            </thead>
            <tbody id="mySchedTbody"></tbody>
          </table>
        </div>
        <div id="msgSched" class="msg"></div>

        <hr class="sep">

        <h3 id="t_last7Title">Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù… (Ø­Ø¶ÙˆØ±/ØºÙŠØ§Ø¨)</h3>
        <div style="overflow:auto; margin-top:10px">
          <table>
            <thead>
              <tr>
                <th id="t_th_a_date">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th id="t_th_a_day">Ø§Ù„ÙŠÙˆÙ…</th>
                <th id="t_th_a_branch">Ø§Ù„ÙØ±Ø¹</th>
                <th id="t_th_a_shift">Ø§Ù„Ø´ÙØª</th>
                <th id="t_th_a_status">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th id="t_th_a_in">Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
                <th id="t_th_a_out">Ø§Ù„Ø®Ø±ÙˆØ¬</th>
              </tr>
            </thead>
            <tbody id="att7Tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- TAB: ATTEND -->
      <div class="tabPanel" id="tabAttend" style="margin-top:12px">
        <div class="row">
          <button class="btn primary" id="btnIn">âœ… Check-In</button>
          <button class="btn danger" id="btnOutShift" disabled>â›” Check-Out</button>
          <button class="btn" id="btnTestGps">ğŸ“ ÙØ­Øµ Ù…ÙˆÙ‚Ø¹ÙŠ</button>
        </div>
        <div id="msgAtt" class="msg"></div>

        <div class="tiny" style="margin-top:10px" id="t_gpsHint">
          â€¢ â€œÙØ­Øµ Ù…ÙˆÙ‚Ø¹ÙŠâ€ Ø¨ÙŠÙ‚Ù„Ùƒ ÙƒÙ… Ù…ØªØ± Ø¨Ø¹ÙŠØ¯ Ø¹Ù† Ø§Ù„ÙØ±Ø¹ ÙˆÙ‡Ù„ Ø£Ù†Øª Ø¶Ù…Ù† Ø§Ù„Ù†Ø·Ø§Ù‚.
        </div>
      </div>

      <!-- TAB: FIX -->
      <div class="tabPanel" id="tabFix" style="margin-top:12px">
        <div class="row" style="justify-content:space-between">
          <div class="pill" id="fixHintPill">Ø§Ø®ØªØ± Ø´ÙŠÙØª Ø«Ù… Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„ØªØµØ­ÙŠØ­</div>
          <div class="row">
            <button class="btn warn" id="btnPickShift">ğŸ—“ï¸ Ø§Ø®ØªÙŠØ§Ø± Ø´ÙŠÙØª</button>
            <button class="btn warn" id="btnFix" title="ÙŠÙØªØ­ Ø·Ù„Ø¨ ØªØµØ­ÙŠØ­ Ù„Ø´ÙŠÙØª Ø§Ù„ÙŠÙˆÙ…">ğŸŸ¡ Ø´ÙŠÙØª Ø§Ù„ÙŠÙˆÙ…</button>
          </div>
        </div>
        <div class="tiny" style="margin-top:8px" id="t_fixHint">
          â€œØ§Ø®ØªÙŠØ§Ø± Ø´ÙŠÙØªâ€ ÙŠÙØªØ­ Ù…ÙˆØ¯Ø§Ù„: ØªØ®ØªØ§Ø± ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·ØŒ ÙˆØ¥Ø°Ø§ Ù…Ø§ ÙÙŠ Ø´ÙØª ÙŠØ¸Ù‡Ø± ØªÙ†Ø¨ÙŠÙ‡.
        </div>
        <div id="msgFixList" class="msg"></div>
      </div>

      <!-- TAB: LEAVE -->
      <div class="tabPanel" id="tabLeave" style="margin-top:12px">
        <h3 id="t_leaveTitle">Ø·Ù„Ø¨ Ø¥Ø¬Ø§Ø²Ø©</h3>

        <label style="margin-top:6px" id="t_leaveType">Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</label>
        <div class="modeRow">
          <button class="modeBtn active" id="leaveModeSingle" type="button">ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯</button>
          <button class="modeBtn" id="leaveModeRange" type="button">ÙØªØ±Ø© (Ù…Ù† â†’ Ø¥Ù„Ù‰)</button>
          <button class="modeBtn" id="leaveModeScattered" type="button">Ø£ÙŠØ§Ù… Ù…ØªÙØ±Ù‚Ø©</button>
        </div>

        <div class="modePanel show" id="leavePanelSingle">
          <label id="t_leaveDay">Ø§Ù„ÙŠÙˆÙ…</label>
          <input id="lDay" type="date">
        </div>

        <div class="modePanel" id="leavePanelRange">
          <label id="t_leaveFrom">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
          <input id="lFrom" type="date">
          <label id="t_leaveTo">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
          <input id="lTo" type="date">
        </div>

        <div class="modePanel" id="leavePanelScattered">
          <div class="datesBox">
            <div class="row" style="align-items:center;margin:0">
              <div style="flex:2">
                <b style="font-size:13px" id="t_leaveDates">ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©</b>
                <div class="tiny" id="t_leaveDatesHint">Ø£Ø¶Ù ØªÙˆØ§Ø±ÙŠØ® Ù…ØªØ¹Ø¯Ø¯Ø© (ØºÙŠØ± Ù…ØªØªØ§Ø¨Ø¹Ø©)</div>
              </div>
              <div style="display:flex;justify-content:flex-end;gap:8px;flex-wrap:wrap">
                <button class="smBtn" id="btnAddLeaveDate" type="button">+ Ø¥Ø¶Ø§ÙØ© ØªØ§Ø±ÙŠØ®</button>
                <button class="smBtn danger" id="btnClearLeaveDates" type="button">ØªÙØ±ÙŠØº</button>
              </div>
            </div>
            <div id="leaveDatesList"></div>
          </div>
        </div>

        <button class="btn primary" id="btnLeave" style="margin-top:12px; width:100%">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
        <div id="msgLeave" class="msg"></div>

        <hr class="sep">

        <h3 id="t_myLeaves">Ø·Ù„Ø¨Ø§ØªÙŠ</h3>
        <div style="overflow:auto; margin-top:10px">
          <table>
            <thead><tr><th id="t_th_l_type">Ø§Ù„Ù†ÙˆØ¹</th><th id="t_th_l_dates">Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®</th><th id="t_th_l_status">Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
            <tbody id="myLeavesTbody"></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <!-- Shift Picker Modal -->
  <div class="modalOv" id="pickOv" aria-hidden="true">
    <div class="modal big">
      <div class="topRow">
        <b id="t_pickTitle">ğŸ—“ï¸ Ø§Ø®ØªÙŠØ§Ø± Ø´ÙŠÙØª Ù„Ù„ØªØµØ­ÙŠØ­</b>
        <button class="btn" id="pickClose">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>

      <div class="tiny" style="margin-top:8px" id="t_pickHint">
        Ø§Ø®ØªØ± ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·ØŒ Ø«Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø§ÙƒØªØ¨ Ø¨Ø­Ø« Ø¨Ø§Ù„ÙØ±Ø¹/Ø§Ø³Ù… Ø§Ù„Ø´ÙŠÙØª.
      </div>

      <label id="t_pickDate">Ø§Ù„ØªØ§Ø±ÙŠØ® (ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯)</label>
      <input id="pickDate" type="date">

      <label id="t_pickSearch">Ø¨Ø­Ø« (ÙØ±Ø¹ / Ø§Ø³Ù… Ø´ÙØª) (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input id="pickQ" type="text" placeholder="Ù…Ø«Ø§Ù„: Main Ø£Ùˆ Morning...">

      <div class="row" style="margin-top:12px; justify-content:space-between">
        <div class="row">
          <button class="btn primary" id="pickLoad">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´ÙØªØ§Øª</button>
          <button class="btn" id="pickToday">Ø§Ù„ÙŠÙˆÙ…</button>
        </div>
        <div class="pill" id="pickMeta">...</div>
      </div>

      <div id="msgPick" class="msg"></div>

      <div style="overflow:auto; margin-top:12px; max-height: 360px">
        <table>
          <thead>
            <tr>
              <th id="t_th_p_date">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th id="t_th_p_branch">Ø§Ù„ÙØ±Ø¹</th>
              <th id="t_th_p_shift">Ø§Ù„Ø´ÙØª</th>
              <th id="t_th_p_time">Ø§Ù„ÙˆÙ‚Øª</th>
              <th id="t_th_p_pick">Ø§Ø®ØªÙŠØ§Ø±</th>
            </tr>
          </thead>
          <tbody id="pickTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Fix Modal -->
  <div class="modalOv" id="fixOv" aria-hidden="true">
    <div class="modal">
      <div class="topRow">
        <b id="t_fixTitle">ğŸŸ¡ Ø·Ù„Ø¨ ØªØµØ­ÙŠØ­ Ø¯ÙˆØ§Ù…</b>
        <button class="btn" id="fixClose">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>

      <div class="tiny" style="margin-top:8px" id="t_fixHint2">
        Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„Ø·Ù„Ø¨. Ù…Ø«Ø§Ù„: Ù†Ø³ÙŠØª Check-Out Ø£Ùˆ ÙƒÙ†Øª Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¬Ù‡Ø§Ø².
      </div>

      <label id="t_fixReason">Ù…Ù„Ø§Ø­Ø¸Ø© / Ø³Ø¨Ø¨</label>
      <input id="fixNote" type="text" placeholder="Ù…Ø«Ø§Ù„: ÙƒÙ†Øª Ø®Ø§Ø±Ø¬ Ø§Ù„ØªØºØ·ÙŠØ© ÙˆÙ†Ø³ÙŠØª Ø§Ù„Ø®Ø±ÙˆØ¬...">

      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="fixSend">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
        <div class="pill" id="fixMeta" style="margin-inline-start:auto">...</div>
      </div>
      <div id="msgFix" class="msg"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signOut,
      setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc,
      collection, addDoc, getDocs, query, where,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // âœ… IMPORTANT: Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù€ config Ø§Ù„ØµØ­ÙŠØ­ ÙƒÙ…Ø§ ÙƒØ§Ù† Ø¹Ù†Ø¯Ùƒ (Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØºÙŠÙŠØ±)
    const firebaseConfig = {
      apiKey: "AIzaSyCN88FY9CJU8T8cm5lLYjcI-I8VmD46o40",
      authDomain: "roma-schedule.firebaseapp.com",
      projectId: "roma-schedule",
      storageBucket: "roma-schedule.firebasestorage.app",
      messagingSenderId: "685810932602",
      appId: "1:685810932602:web:f1ec506ea6ff5e919d94c3",
      measurementId: "G-5FY5S5TZLJ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // âœ… ÙŠÙ…Ù†Ø¹ Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø¹Ù„Ù‰ login Ø¨Ø³Ø¨Ø¨ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ù€ session
    (async ()=>{
      try{
        await setPersistence(auth, browserLocalPersistence);
      }catch(e){
        console.warn("Auth persistence failed:", e);
      }
    })();

    const db = getFirestore(app);

    const $ = (id)=>document.getElementById(id);

    // =========================
    // i18n (AR/EN) âœ… ØªØ±Ø¬Ù…Ø© ÙƒØ§Ù…Ù„Ø© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©
    // =========================
    const I18N = {
      ar: {
        dir:"rtl",
        langBtn:"EN",
        logout:"ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬",
        title:"Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙˆØ¸Ù",
        gpsNote:"â€¢ âœ… GPS Ø¥Ù„Ø²Ø§Ù…ÙŠ: Ù„Ù† ÙŠØªÙ… Ù‚Ø¨ÙˆÙ„ Check-In/Out Ø¥Ù„Ø§ Ø¯Ø§Ø®Ù„ Ù†Ø·Ø§Ù‚ Ø§Ù„ÙØ±Ø¹.<br>",
        tabSched:"ğŸ“… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯ÙˆØ§Ù…",
        tabAttend:"âœ… Check-In/Out",
        tabFix:"ğŸŸ¡ Ø·Ù„Ø¨ Ø§Ù„ØªØµØ­ÙŠØ­",
        tabLeave:"ğŸ–ï¸ Ø·Ù„Ø¨ Ø¥Ø¬Ø§Ø²Ø©",
        schedRange:"Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„",
        optToday:"Ø§Ù„ÙŠÙˆÙ…",
        optTomorrow:"Ø§Ù„ØºØ¯",
        optThisWeek:"Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹",
        optNextWeek:"Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù‚Ø§Ø¯Ù…",
        optThisMonth:"Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±",
        refresh:"ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„",
        thDate:"Ø§Ù„ØªØ§Ø±ÙŠØ®",
        thDay:"Ø§Ù„ÙŠÙˆÙ…",
        thBranch:"Ø§Ù„ÙØ±Ø¹",
        thShift:"Ø§Ù„Ø´ÙØª",
        thTime:"Ø§Ù„ÙˆÙ‚Øª",
        thNote:"Ù…Ù„Ø§Ø­Ø¸Ø©",
        last7:"Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù… (Ø­Ø¶ÙˆØ±/ØºÙŠØ§Ø¨)",
        thStatus:"Ø§Ù„Ø­Ø§Ù„Ø©",
        thIn:"Ø§Ù„Ø¯Ø®ÙˆÙ„",
        thOut:"Ø§Ù„Ø®Ø±ÙˆØ¬",
        gpsHint:"â€¢ â€œÙØ­Øµ Ù…ÙˆÙ‚Ø¹ÙŠâ€ Ø¨ÙŠÙ‚Ù„Ùƒ ÙƒÙ… Ù…ØªØ± Ø¨Ø¹ÙŠØ¯ Ø¹Ù† Ø§Ù„ÙØ±Ø¹ ÙˆÙ‡Ù„ Ø£Ù†Øª Ø¶Ù…Ù† Ø§Ù„Ù†Ø·Ø§Ù‚.",
        pickShift:"ğŸ—“ï¸ Ø§Ø®ØªÙŠØ§Ø± Ø´ÙŠÙØª",
        todayShift:"ğŸŸ¡ Ø´ÙŠÙØª Ø§Ù„ÙŠÙˆÙ…",
        fixHint:"â€œØ§Ø®ØªÙŠØ§Ø± Ø´ÙŠÙØªâ€ ÙŠÙØªØ­ Ù…ÙˆØ¯Ø§Ù„: ØªØ®ØªØ§Ø± ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·ØŒ ÙˆØ¥Ø°Ø§ Ù…Ø§ ÙÙŠ Ø´ÙØª ÙŠØ¸Ù‡Ø± ØªÙ†Ø¨ÙŠÙ‡.",
        leaveTitle:"Ø·Ù„Ø¨ Ø¥Ø¬Ø§Ø²Ø©",
        leaveType:"Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨",
        leaveSingle:"ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯",
        leaveRange:"ÙØªØ±Ø© (Ù…Ù† â†’ Ø¥Ù„Ù‰)",
        leaveScattered:"Ø£ÙŠØ§Ù… Ù…ØªÙØ±Ù‚Ø©",
        leaveDay:"Ø§Ù„ÙŠÙˆÙ…",
        leaveFrom:"Ù…Ù† ØªØ§Ø±ÙŠØ®",
        leaveTo:"Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®",
        leaveDates:"ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©",
        leaveDatesHint:"Ø£Ø¶Ù ØªÙˆØ§Ø±ÙŠØ® Ù…ØªØ¹Ø¯Ø¯Ø© (ØºÙŠØ± Ù…ØªØªØ§Ø¨Ø¹Ø©)",
        addDate:"+ Ø¥Ø¶Ø§ÙØ© ØªØ§Ø±ÙŠØ®",
        clear:"ØªÙØ±ÙŠØº",
        sendLeave:"Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨",
        myLeaves:"Ø·Ù„Ø¨Ø§ØªÙŠ",
        lType:"Ø§Ù„Ù†ÙˆØ¹",
        lDates:"Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®",
        lStatus:"Ø§Ù„Ø­Ø§Ù„Ø©",
        // Modals
        pickTitle:"ğŸ—“ï¸ Ø§Ø®ØªÙŠØ§Ø± Ø´ÙŠÙØª Ù„Ù„ØªØµØ­ÙŠØ­",
        close:"Ø¥ØºÙ„Ø§Ù‚",
        pickHint:"Ø§Ø®ØªØ± ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·ØŒ Ø«Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø§ÙƒØªØ¨ Ø¨Ø­Ø« Ø¨Ø§Ù„ÙØ±Ø¹/Ø§Ø³Ù… Ø§Ù„Ø´ÙŠÙØª.",
        pickDate:"Ø§Ù„ØªØ§Ø±ÙŠØ® (ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯)",
        pickSearch:"Ø¨Ø­Ø« (ÙØ±Ø¹ / Ø§Ø³Ù… Ø´ÙØª) (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)",
        pickLoad:"ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´ÙØªØ§Øª",
        pickToday:"Ø§Ù„ÙŠÙˆÙ…",
        thPick:"Ø§Ø®ØªÙŠØ§Ø±",
        fixTitle:"ğŸŸ¡ Ø·Ù„Ø¨ ØªØµØ­ÙŠØ­ Ø¯ÙˆØ§Ù…",
        fixHint2:"Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„Ø·Ù„Ø¨. Ù…Ø«Ø§Ù„: Ù†Ø³ÙŠØª Check-Out Ø£Ùˆ ÙƒÙ†Øª Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¬Ù‡Ø§Ø².",
        fixReason:"Ù…Ù„Ø§Ø­Ø¸Ø© / Ø³Ø¨Ø¨",
        fixSend:"Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨",
        // Dynamic labels
        leaveWord:"Ø¥Ø¬Ø§Ø²Ø©",
        approvedLeave:"Ø¥Ø¬Ø§Ø²Ø© Ù…Ù‚Ø¨ÙˆÙ„Ø©",
        scheduleLoaded:(n)=>`ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ âœ… (${n})`,
        noShifts:"Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´ÙØª Ø¶Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù†Ø·Ø§Ù‚.",
        pickNone:"Ù…Ø§ÙÙŠ Ø´ÙŠÙØª Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…",
        chooseDay:"Ø§Ø®ØªØ± ÙŠÙˆÙ… Ø£ÙˆÙ„Ø§Ù‹.",
        loading:"Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...",
        // Attendance pills
        noShiftToday:(d)=>`Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´ÙØª Ø§Ù„ÙŠÙˆÙ… (${d})`,
        // Day names
        days:["Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø§Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª"],
        // Status
        absent:"ØºÙŠØ§Ø¨ âŒ",
        leave:"Ø¥Ø¬Ø§Ø²Ø© âœ…",
        completed:"Ù…ÙƒØªÙ…Ù„ âœ…",
        present:"Ø­Ø§Ø¶Ø± âœ…",
        late:(m)=>`Ù…ØªØ£Ø®Ø± â° (${m}Ø¯)`
      },
      en: {
        dir:"ltr",
        langBtn:"AR",
        logout:"Logout",
        title:"Staff Panel",
        gpsNote:"â€¢ âœ… GPS required: Check-In/Out is accepted only inside the branch radius.<br>",
        tabSched:"ğŸ“… Schedule",
        tabAttend:"âœ… Check-In/Out",
        tabFix:"ğŸŸ¡ Correction Request",
        tabLeave:"ğŸ–ï¸ Leave Request",
        schedRange:"Schedule Range",
        optToday:"Today",
        optTomorrow:"Tomorrow",
        optThisWeek:"This Week",
        optNextWeek:"Next Week",
        optThisMonth:"This Month",
        refresh:"Refresh Schedule",
        thDate:"Date",
        thDay:"Day",
        thBranch:"Branch",
        thShift:"Shift",
        thTime:"Time",
        thNote:"Note",
        last7:"Last 7 Days (Attendance)",
        thStatus:"Status",
        thIn:"Check-In",
        thOut:"Check-Out",
        gpsHint:"â€¢ â€œTest my locationâ€ tells you how far you are from the branch and whether you are inside the allowed radius.",
        pickShift:"ğŸ—“ï¸ Pick a Shift",
        todayShift:"ğŸŸ¡ Today Shift",
        fixHint:"â€œPick a Shiftâ€ opens a modal: pick ONE day only. If there is no shift, you will see an alert.",
        leaveTitle:"Leave Request",
        leaveType:"Request type",
        leaveSingle:"Single day",
        leaveRange:"Range (From â†’ To)",
        leaveScattered:"Scattered days",
        leaveDay:"Day",
        leaveFrom:"From date",
        leaveTo:"To date",
        leaveDates:"Leave dates",
        leaveDatesHint:"Add multiple dates (non-consecutive)",
        addDate:"+ Add date",
        clear:"Clear",
        sendLeave:"Send Request",
        myLeaves:"My Requests",
        lType:"Type",
        lDates:"Dates",
        lStatus:"Status",
        // Modals
        pickTitle:"ğŸ—“ï¸ Pick a shift for correction",
        close:"Close",
        pickHint:"Pick ONE day, then (optional) search by branch/shift name.",
        pickDate:"Date (single day)",
        pickSearch:"Search (Branch / Shift) (optional)",
        pickLoad:"Load shifts",
        pickToday:"Today",
        thPick:"Pick",
        fixTitle:"ğŸŸ¡ Attendance Correction Request",
        fixHint2:"Write the reason. Example: forgot Check-Out or was away from the device.",
        fixReason:"Note / Reason",
        fixSend:"Send Request",
        // Dynamic labels
        leaveWord:"Leave",
        approvedLeave:"Approved Leave",
        scheduleLoaded:(n)=>`Schedule loaded âœ… (${n})`,
        noShifts:"No shifts in this range.",
        pickNone:"No shifts on this day",
        chooseDay:"Please choose a date first.",
        loading:"Loading...",
        noShiftToday:(d)=>`No shift today (${d})`,
        days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],
        absent:"Absent âŒ",
        leave:"Leave âœ…",
        completed:"Completed âœ…",
        present:"Present âœ…",
        late:(m)=>`Late â° (${m}m)`
      }
    };

    let LANG = (localStorage.getItem("roma_staff_lang") || "ar");
    function t(key, ...args){
      const pack = I18N[LANG] || I18N.ar;
      const v = pack[key];
      return (typeof v === "function") ? v(...args) : (v ?? key);
    }

    function applyLang(){
      const pack = I18N[LANG] || I18N.ar;

      document.documentElement.lang = (LANG==="ar" ? "ar" : "en");
      document.documentElement.dir = pack.dir;

      // Top
      $("btnLang").textContent = pack.langBtn;
      $("btnLogout").textContent = pack.logout;

      // Main texts
      $("t_title").textContent = pack.title;
      $("t_gpsNote").innerHTML = pack.gpsNote;

      $("t_tabSched").textContent = pack.tabSched;
      $("t_tabAttend").textContent = pack.tabAttend;
      $("t_tabFix").textContent = pack.tabFix;
      $("t_tabLeave").textContent = pack.tabLeave;

      $("t_schedRangeLabel").textContent = pack.schedRange;

      $("t_opt_today").textContent = pack.optToday;
      $("t_opt_tomorrow").textContent = pack.optTomorrow;
      $("t_opt_thisWeek").textContent = pack.optThisWeek;
      $("t_opt_nextWeek").textContent = pack.optNextWeek;
      $("t_opt_thisMonth").textContent = pack.optThisMonth;

      $("btnLoadSched").textContent = pack.refresh;

      $("t_th_date").textContent = pack.thDate;
      $("t_th_day").textContent = pack.thDay;
      $("t_th_branch").textContent = pack.thBranch;
      $("t_th_shift").textContent = pack.thShift;
      $("t_th_time").textContent = pack.thTime;
      $("t_th_note").textContent = pack.thNote;

      $("t_last7Title").textContent = pack.last7;

      $("t_th_a_date").textContent = pack.thDate;
      $("t_th_a_day").textContent = pack.thDay;
      $("t_th_a_branch").textContent = pack.thBranch;
      $("t_th_a_shift").textContent = pack.thShift;
      $("t_th_a_status").textContent = pack.thStatus;
      $("t_th_a_in").textContent = pack.thIn;
      $("t_th_a_out").textContent = pack.thOut;

      $("t_gpsHint").textContent = pack.gpsHint;

      $("fixHintPill").textContent = (LANG==="ar" ? "Ø§Ø®ØªØ± Ø´ÙŠÙØª Ø«Ù… Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„ØªØµØ­ÙŠØ­" : "Pick a shift then write the reason");
      $("btnPickShift").textContent = pack.pickShift;
      $("btnFix").textContent = pack.todayShift;
      $("t_fixHint").textContent = pack.fixHint;

      $("t_leaveTitle").textContent = pack.leaveTitle;
      $("t_leaveType").textContent = pack.leaveType;
      $("leaveModeSingle").textContent = pack.leaveSingle;
      $("leaveModeRange").textContent = pack.leaveRange;
      $("leaveModeScattered").textContent = pack.leaveScattered;
      $("t_leaveDay").textContent = pack.leaveDay;
      $("t_leaveFrom").textContent = pack.leaveFrom;
      $("t_leaveTo").textContent = pack.leaveTo;
      $("t_leaveDates").textContent = pack.leaveDates;
      $("t_leaveDatesHint").textContent = pack.leaveDatesHint;
      $("btnAddLeaveDate").textContent = pack.addDate;
      $("btnClearLeaveDates").textContent = pack.clear;
      $("btnLeave").textContent = pack.sendLeave;
      $("t_myLeaves").textContent = pack.myLeaves;
      $("t_th_l_type").textContent = pack.lType;
      $("t_th_l_dates").textContent = pack.lDates;
      $("t_th_l_status").textContent = pack.lStatus;

      // Modals
      $("t_pickTitle").textContent = pack.pickTitle;
      $("pickClose").textContent = pack.close;
      $("t_pickHint").textContent = pack.pickHint;
      $("t_pickDate").textContent = pack.pickDate;
      $("t_pickSearch").textContent = pack.pickSearch;
      $("pickLoad").textContent = pack.pickLoad;
      $("pickToday").textContent = pack.pickToday;

      $("t_th_p_date").textContent = pack.thDate;
      $("t_th_p_branch").textContent = pack.thBranch;
      $("t_th_p_shift").textContent = pack.thShift;
      $("t_th_p_time").textContent = pack.thTime;
      $("t_th_p_pick").textContent = pack.thPick;

      $("t_fixTitle").textContent = pack.fixTitle;
      $("fixClose").textContent = pack.close;
      $("t_fixHint2").textContent = pack.fixHint2;
      $("t_fixReason").textContent = pack.fixReason;
      $("fixSend").textContent = pack.fixSend;

      // placeholders
      $("pickQ").placeholder = (LANG==="ar" ? "Ù…Ø«Ø§Ù„: Main Ø£Ùˆ Morning..." : "Example: Main or Morning...");
      $("fixNote").placeholder = (LANG==="ar" ? "Ù…Ø«Ø§Ù„: ÙƒÙ†Øª Ø®Ø§Ø±Ø¬ Ø§Ù„ØªØºØ·ÙŠØ© ÙˆÙ†Ø³ÙŠØª Ø§Ù„Ø®Ø±ÙˆØ¬..." : "Example: I was out of coverage and forgot to check out...");

      // force align in tables based on dir
      document.querySelectorAll("th,td").forEach(cell=>{
        cell.style.textAlign = (pack.dir==="rtl" ? "right" : "left");
      });

      // Animation
      const root = $("cardRoot");
      root.classList.remove("langAnim");
      void root.offsetWidth; // reflow
      root.classList.add("langAnim");
    }

    // ===== UI helpers =====
    const setMsg = (id, text, type="ok")=>{
      const el = $(id);
      el.className = "msg " + (type==="bad"?"bad":"ok");
      el.textContent = text;
      el.style.display = "block";
    };

    function pill(el, text, kind=""){
      el.className = "pill" + (kind ? " "+kind : "");
      el.textContent = text;
    }

    function ymd(d){
      const dt = new Date(d);
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,"0");
      const da = String(dt.getDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    }

    function dayNameFromYMD(dateStr){
      const dt = new Date(dateStr+"T00:00:00");
      const idx = dt.getDay(); // 0..6
      const pack = I18N[LANG] || I18N.ar;
      return pack.days[idx] || "";
    }

    function startOfWeek(d){
      const x = new Date(d);
      x.setHours(0,0,0,0);
      const day = x.getDay();
      const diff = (day===0 ? -6 : 1-day);
      x.setDate(x.getDate()+diff);
      return x;
    }

    function endOfMonth(d){
      const x = new Date(d);
      return new Date(x.getFullYear(), x.getMonth()+1, 0);
    }

    function timeToMin(t){
      const s = String(t||"").trim();
      const m = /^(\d{1,2}):(\d{2})$/.exec(s);
      if(!m) return null;
      const hh = Math.max(0, Math.min(23, Number(m[1])));
      const mm = Math.max(0, Math.min(59, Number(m[2])));
      return hh*60+mm;
    }

    function nowMin(){
      const d=new Date();
      return d.getHours()*60 + d.getMinutes();
    }

    function safeId(s){
      return String(s||"").replace(/[^a-zA-Z0-9_-]/g,"_").slice(0,240);
    }

    function getRangeDates(kind){
      const today = new Date(); today.setHours(0,0,0,0);

      if(kind === "today"){
        const d = ymd(today);
        return { from:d, to:d };
      }
      if(kind === "tomorrow"){
        const t = new Date(today); t.setDate(t.getDate()+1);
        const d = ymd(t);
        return { from:d, to:d };
      }
      if(kind === "thisWeek"){
        const s = startOfWeek(today);
        const e = new Date(s); e.setDate(e.getDate()+6);
        return { from: ymd(s), to: ymd(e) };
      }
      if(kind === "nextWeek"){
        const s = startOfWeek(today); s.setDate(s.getDate()+7);
        const e = new Date(s); e.setDate(e.getDate()+6);
        return { from: ymd(s), to: ymd(e) };
      }
      if(kind === "thisMonth"){
        const s = new Date(today.getFullYear(), today.getMonth(), 1);
        const e = endOfMonth(today);
        return { from: ymd(s), to: ymd(e) };
      }
      const d = ymd(today);
      return { from:d, to:d };
    }

    // ===== Tabs UI =====
    function initTabs(){
      const btns = Array.from(document.querySelectorAll(".tabBtn"));
      btns.forEach(b=>{
        b.addEventListener("click", ()=>{
          btns.forEach(x=>x.classList.remove("active"));
          b.classList.add("active");
          const id = b.getAttribute("data-tab");
          document.querySelectorAll(".tabPanel").forEach(p=>p.classList.remove("show"));
          const panel = document.getElementById(id);
          if(panel) panel.classList.add("show");
        });
      });
    }

    // ===== employee preset (fallback only) =====
    const safeEmailDocId = (email)=> String(email||"").trim().toLowerCase().replace(/\./g,"(dot)");
    async function readPresetByEmail(email){
      const ref = doc(db, "employees_email", safeEmailDocId(email));
      const snap = await getDoc(ref);
      return snap.exists() ? snap.data() : null;
    }

    async function ensureEmployeeDoc(user){
      const ref = doc(db, "employees", user.uid);
      const snap = await getDoc(ref);
      if(snap.exists()) return;

      const preset = await readPresetByEmail(user.email || "");
      const base = {
        name: (user.email||"user").split("@")[0],
        email: user.email || "",
        role: "staff",
        type: "regular",
        department: "General",
        branchId: "",
        fixedBranch: true,
        coverAllBranches: false,
        coverBranchIds: [],
        canCover: true,
        active: true,
        createdAt: serverTimestamp()
      };
      const data = preset ? { ...base, ...preset } : base;
      await setDoc(ref, data, { merge:true });
    }

    async function getMyRole(uid){
      const snap = await getDoc(doc(db,"employees",uid));
      return snap.exists() ? (snap.data()?.role || "staff") : "staff";
    }

    // ===== âœ… shifts fetching from "shifts" (employeeId = uid) =====
    async function fetchMyShiftsInRange(from, to, currentUser){
      const daysSet = new Set();
      const a = new Date(from), b = new Date(to);
      a.setHours(0,0,0,0); b.setHours(0,0,0,0);
      for(let d=new Date(a); d<=b; d.setDate(d.getDate()+1)){
        daysSet.add(ymd(d));
      }

      const uid = currentUser?.uid || "";
      const email = (currentUser?.email || "").trim().toLowerCase();
      if(!uid) return [];

      const id_uid = uid;
      const id_preset = "preset:" + safeEmailDocId(email);

      const collected = [];
      const seen = new Set();

      const addRow = (docu)=>{
        if(seen.has(docu.id)) return;
        const x = docu.data() || {};
        const date = String(x.date || x.day || x.shiftDate || "").trim();
        if(!daysSet.has(date)) return;
        seen.add(docu.id);
        collected.push({ id: docu.id, ...x });
      };

      // 1) employeeId == uid âœ…
      try{
        const snap = await getDocs(query(collection(db,"shifts"), where("employeeId","==", id_uid)));
        snap.forEach(addRow);
      }catch(e){
        console.error("Query shifts by employeeId(uid) failed:", e);
      }

      // 2) employeeUid == uid (backup)
      if(!collected.length){
        try{
          const snap = await getDocs(query(collection(db,"shifts"), where("employeeUid","==", uid)));
          snap.forEach(addRow);
        }catch(e){
          console.error("Query shifts by employeeUid failed:", e);
        }
      }

      // 3) assignedEmployeeId == uid (backup covers)
      if(!collected.length){
        try{
          const snap = await getDocs(query(collection(db,"shifts"), where("assignedEmployeeId","==", id_uid)));
          snap.forEach(addRow);
        }catch(e){
          console.error("Query shifts by assignedEmployeeId(uid) failed:", e);
        }
      }

      // 4) old fallback preset: employeeId == preset:email(dot)
      if(!collected.length && email){
        try{
          const snap = await getDocs(query(collection(db,"shifts"), where("employeeId","==", id_preset)));
          snap.forEach(addRow);
        }catch(e){
          console.error("Query shifts by employeeId(preset) failed:", e);
        }
      }

      // 5) last resort scan
      if(!collected.length){
        try{
          const snapAll = await getDocs(collection(db,"shifts"));
          snapAll.forEach(docu=>{
            const x = docu.data() || {};
            const date = String(x.date || x.day || x.shiftDate || "").trim();
            if(!daysSet.has(date)) return;

            const empId = String(x.employeeId || x.assignedEmployeeId || x.employeeUid || "").trim();
            if(empId !== id_uid && empId !== id_preset) return;

            addRow(docu);
          });
        }catch(e){
          console.error("Scan shifts failed:", e);
        }
      }

      return collected.map(x=>({
        date: String(x.date || x.day || x.shiftDate || "").trim(),
        branchId: x.branchId || x.branch || "",
        branchName: x.branchName || x.branch || x.branchId || "",
        shiftName: x.shiftName || x.name || x.shift || x.key || "Shift",
        start: x.start || x.from || x.startTime || "",
        end: x.end || x.to || x.endTime || "",
        note: x.note || x.statusNote || x.coverNote || ""
      }));
    }

    // ===== GPS =====
    function haversineMeters(lat1, lon1, lat2, lon2){
      const R = 6371000;
      const toRad = (v)=> v * Math.PI / 180;
      const dLat = toRad(lat2-lat1);
      const dLon = toRad(lon2-lon1);
      const a =
        Math.sin(dLat/2)**2 +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    async function getGpsOnce(){
      if(!navigator.geolocation) throw new Error(LANG==="ar" ? "Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS." : "Your browser does not support GPS.");
      return await new Promise((resolve, reject)=>{
        navigator.geolocation.getCurrentPosition(
          (pos)=> resolve({
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
            acc: pos.coords.accuracy
          }),
          ()=> reject(new Error(LANG==="ar" ? "ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹. ÙØ¹Ù‘Ù„ GPS ÙˆØ§Ø³Ù…Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹." : "Failed to get location. Enable GPS and allow location access.")),
          { enableHighAccuracy:true, timeout:12000, maximumAge:0 }
        );
      });
    }

    async function readBranchGeo(branchId){
      if(!branchId) return null;
      const snap = await getDoc(doc(db,"branches", branchId));
      if(!snap.exists()) return null;
      const b = snap.data() || {};
      const g = b.geo || null;
      if(!g || typeof g.lat!=="number" || typeof g.lng!=="number") return null;
      const radiusM = (typeof g.radiusM==="number" && g.radiusM>0) ? g.radiusM : 80;
      return { lat:g.lat, lng:g.lng, radiusM };
    }

    async function assertInsideBranch(branchId){
      const geo = await readBranchGeo(branchId);
      if(!geo){
        throw new Error(LANG==="ar"
          ? "Ù‡Ø°Ø§ Ø§Ù„ÙØ±Ø¹ Ù„Ø§ ÙŠÙ…Ù„Ùƒ Ù„ÙˆÙƒÙŠØ´Ù† Ø¨Ø¹Ø¯. Ø§Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù† ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ÙØ±Ø¹ (lat/lng + radius)."
          : "This branch has no location yet. Ask the admin to set branch lat/lng + radius."
        );
      }
      const gps = await getGpsOnce();
      const dist = haversineMeters(gps.lat, gps.lng, geo.lat, geo.lng);
      const ok = dist <= geo.radiusM;

      return {
        ok,
        distM: Math.round(dist),
        radiusM: Math.round(geo.radiusM),
        gps,
        branchGeo: geo
      };
    }

    // ===== Attendance =====
    const LATE_GRACE_MIN = 10;

    let currentUser = null;
    let myProfile = null;

    let todayShift = null;
    let attendanceId = null;
    let attendanceDoc = null;

    let selectedFixShift = null;

    // âœ… employeeId ÙÙŠ Ø´ÙØªØ§ØªÙƒ = uid
    let myPresetKey = "";

    function attendanceIdFromShift(shift, user){
      const date = shift?.date || ymd(new Date());
      const key = `${user.uid}__${date}__${shift?.branchId||""}__${shift?.shiftName||""}__${shift?.start||""}`;
      return safeId(key);
    }

    // ===== Leaves Approved (scattered + single + range) =====
    function expandApprovedLeaveDates(x){
      const mode = String(x.leaveMode||"range").toLowerCase();
      const set = new Set();

      if(mode === "scattered" && Array.isArray(x.dates) && x.dates.length){
        x.dates.forEach(d=>{
          if(typeof d==="string" && /^\d{4}-\d{2}-\d{2}$/.test(d)) set.add(d);
        });
        return set;
      }

      if(mode === "single"){
        const d = x.from || (Array.isArray(x.dates) ? x.dates[0] : null);
        if(d && /^\d{4}-\d{2}-\d{2}$/.test(String(d))) set.add(String(d));
        return set;
      }

      if(x.from && x.to){
        const a = new Date(x.from), b = new Date(x.to);
        a.setHours(0,0,0,0); b.setHours(0,0,0,0);
        for(let d=new Date(a); d<=b; d.setDate(d.getDate()+1)){
          set.add(ymd(d));
        }
      }
      return set;
    }

    // âœ… ÙŠØ±Ø¬Ø¹ Set Ù„ÙƒÙ„ Ø§Ù„Ø£ÙŠØ§Ù… Approved Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù
    async function getApprovedLeaveDatesForMe(){
      const snap = await getDocs(collection(db,"leaves"));
      const set = new Set();

      snap.forEach(d=>{
        const x = d.data() || {};
        const st = String(x.status||"").toLowerCase();
        if(st !== "approved") return;

        const ok =
          (x.employeeUid && x.employeeUid === currentUser.uid) ||
          (x.employeeId && String(x.employeeId) === myPresetKey) ||
          (x.employeeEmail && String(x.employeeEmail).toLowerCase() === String(currentUser.email||"").toLowerCase());

        if(!ok) return;

        const dates = expandApprovedLeaveDates(x);
        dates.forEach(v=> set.add(v));
      });

      return set;
    }

    async function isOnApprovedLeave(dateStr){
      const set = await getApprovedLeaveDatesForMe();
      return { onLeave: set.has(dateStr), datesSet: set };
    }

    async function loadTodayShift(){
      const date = ymd(new Date());
      const rows = await fetchMyShiftsInRange(date, date, currentUser);

      rows.sort((a,b)=>{
        const sa = timeToMin(a.start) ?? 99999;
        const sb = timeToMin(b.start) ?? 99999;
        return sa - sb;
      });

      todayShift = rows[0] || null;

      if(!todayShift){
        pill($("shiftPill"), t("noShiftToday", date), "warn");
        attendanceId = null;
        return null;
      }

      attendanceId = attendanceIdFromShift(todayShift, currentUser);

      const label = `${todayShift.branchName||todayShift.branchId||"-"} â€¢ ${todayShift.shiftName||"Shift"} â€¢ ${(todayShift.start&&todayShift.end)?(todayShift.start+"-"+todayShift.end):"â€”"}`;
      pill($("shiftPill"), label, "");
      return todayShift;
    }

    async function loadAttendanceDoc(){
      if(!attendanceId){ attendanceDoc=null; return; }
      const snap = await getDoc(doc(db,"attendance", attendanceId));
      attendanceDoc = snap.exists() ? (snap.data()||null) : null;

      if(!attendanceDoc){
        pill($("attPill"), (LANG==="ar" ? "Ø§Ù„ÙŠÙˆÙ…: Ù„Ù… ØªØ³Ø¬Ù„ Ø­Ø¶ÙˆØ± Ø¨Ø¹Ø¯" : "Today: no attendance yet"), "warn");
        $("btnIn").disabled = false;
        $("btnOutShift").disabled = true;
        return;
      }

      const st = String(attendanceDoc.status||"").toLowerCase();
      const hasIn  = !!attendanceDoc.checkInAtLocal;
      const hasOut = !!attendanceDoc.checkOutAtLocal;

      if(st === "absent"){
        pill($("attPill"), (LANG==="ar" ? "Ø§Ù„ÙŠÙˆÙ…: ØºÙŠØ§Ø¨ âŒ" : "Today: Absent âŒ"), "bad");
        $("btnIn").disabled = true;
        $("btnOutShift").disabled = true;
      }else if(st === "leave"){
        pill($("attPill"), (LANG==="ar" ? "Ø§Ù„ÙŠÙˆÙ…: Ø¥Ø¬Ø§Ø²Ø© âœ…" : "Today: Leave âœ…"), "ok");
        $("btnIn").disabled = true;
        $("btnOutShift").disabled = true;
      }else if(hasIn && !hasOut){
        const late = Number(attendanceDoc.minutesLate||0);
        pill($("attPill"), late>0 ? (LANG==="ar" ? `Ø­Ø§Ø¶Ø± (Ù…ØªØ£Ø®Ø± ${late}Ø¯) â°` : `Present (Late ${late}m) â°`) : (LANG==="ar" ? "Ø­Ø§Ø¶Ø± âœ…" : "Present âœ…"), late>0 ? "warn" : "ok");
        $("btnIn").disabled = true;
        $("btnOutShift").disabled = false;
      }else if(hasIn && hasOut){
        const late = Number(attendanceDoc.minutesLate||0);
        const w = Number(attendanceDoc.workedMinutes||0);
        pill($("attPill"), (LANG==="ar"
          ? `Ù…ÙƒØªÙ…Ù„ âœ… (${w}Ø¯)${late>0?` â€¢ ØªØ£Ø®ÙŠØ± ${late}Ø¯`:``}`
          : `Completed âœ… (${w}m)${late>0?` â€¢ Late ${late}m`:``}`
        ), late>0 ? "warn" : "ok");
        $("btnIn").disabled = true;
        $("btnOutShift").disabled = true;
      }else{
        pill($("attPill"), (LANG==="ar" ? "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø¨Ø¯ÙˆÙ† Ø¯Ø®ÙˆÙ„" : "Record created without Check-In"), "warn");
        $("btnIn").disabled = false;
        $("btnOutShift").disabled = true;
      }
    }

    function computeLate(shift){
      const s = timeToMin(shift?.start);
      if(s===null) return 0;
      const diff = (nowMin() - s) - LATE_GRACE_MIN;
      return Math.max(0, diff);
    }

    async function doCheckIn(){
      if(!todayShift) return setMsg("msgAtt", (LANG==="ar" ? "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´ÙØª Ø§Ù„ÙŠÙˆÙ… Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±." : "No shift today to check in."), "bad");

      const inside = await assertInsideBranch(todayShift.branchId || "");
      if(!inside.ok){
        return setMsg("msgAtt", (LANG==="ar"
          ? `âŒ Ø£Ù†Øª Ø®Ø§Ø±Ø¬ Ø§Ù„ÙØ±Ø¹: Ø¨Ø¹ÙŠØ¯ ${inside.distM}m (Ø§Ù„Ù…Ø³Ù…ÙˆØ­ ${inside.radiusM}m).`
          : `âŒ You are outside the branch: ${inside.distM}m away (allowed ${inside.radiusM}m).`
        ), "bad");
      }

      const date = todayShift.date || ymd(new Date());
      const leave = await isOnApprovedLeave(date);
      if(leave.onLeave){
        setMsg("msgAtt", (LANG==="ar" ? "Ø£Ù†Øª Ø¨Ø¥Ø¬Ø§Ø²Ø© Approved âœ… Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¹Ù…Ù„ Check-In." : "You are on an approved leave âœ… You cannot Check-In."), "bad");
        await setDoc(doc(db,"attendance", attendanceId), {
          employeeUid: currentUser.uid,
          employeeId: myPresetKey,
          employeeEmail: currentUser.email || "",
          employeeName: myProfile?.name || (currentUser.email||"").split("@")[0] || "",
          date,
          branchId: todayShift.branchId || "",
          branchName: todayShift.branchName || "",
          shiftName: todayShift.shiftName || "",
          start: todayShift.start || "",
          end: todayShift.end || "",
          status: "leave",
          note: "On approved leave",
          updatedAt: serverTimestamp()
        }, { merge:true });
        await loadAttendanceDoc();
        return;
      }

      const late = computeLate(todayShift);

      await setDoc(doc(db,"attendance", attendanceId), {
        employeeUid: currentUser.uid,
        employeeId: myPresetKey,
        employeeEmail: currentUser.email || "",
        employeeName: myProfile?.name || (currentUser.email||"").split("@")[0] || "",
        date,
        branchId: todayShift.branchId || "",
        branchName: todayShift.branchName || "",
        shiftName: todayShift.shiftName || "",
        start: todayShift.start || "",
        end: todayShift.end || "",
        minutesLate: late,
        status: "present",
        checkInAt: serverTimestamp(),
        checkInAtLocal: Date.now(),
        gpsIn: inside.gps,
        gpsInDistM: inside.distM,
        gpsInRadiusM: inside.radiusM,
        updatedAt: serverTimestamp()
      }, { merge:true });

      setMsg("msgAtt",
        (late>0
          ? (LANG==="ar" ? `ØªÙ… Check-In âœ… (Ø¯Ø§Ø®Ù„ Ø§Ù„ÙØ±Ø¹) â€¢ Ù…ØªØ£Ø®Ø± ${late} Ø¯Ù‚ÙŠÙ‚Ø©` : `Checked in âœ… (inside branch) â€¢ Late ${late} min`)
          : (LANG==="ar" ? "ØªÙ… Check-In âœ… (Ø¯Ø§Ø®Ù„ Ø§Ù„ÙØ±Ø¹)" : "Checked in âœ… (inside branch)")
        ),
        "ok"
      );
      await loadAttendanceDoc();
      await loadAttLast7Days();
    }

    async function doCheckOut(){
      if(!attendanceId) return;

      if(todayShift?.branchId){
        const inside = await assertInsideBranch(todayShift.branchId || "");
        if(!inside.ok){
          return setMsg("msgAtt", (LANG==="ar"
            ? `âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Check-Out Ø®Ø§Ø±Ø¬ Ø§Ù„ÙØ±Ø¹: Ø¨Ø¹ÙŠØ¯ ${inside.distM}m (Ø§Ù„Ù…Ø³Ù…ÙˆØ­ ${inside.radiusM}m).`
            : `âŒ Cannot Check-Out outside the branch: ${inside.distM}m away (allowed ${inside.radiusM}m).`
          ), "bad");
        }
      }

      const snap = await getDoc(doc(db,"attendance", attendanceId));
      if(!snap.exists()) return setMsg("msgAtt", (LANG==="ar" ? "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ± Ù„Ø¹Ù…Ù„ Check-Out." : "No attendance record to check out."), "bad");

      const x = snap.data() || {};
      if(!x.checkInAtLocal) return setMsg("msgAtt", (LANG==="ar" ? "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Check-In Ù…Ø³Ø¬Ù„." : "No Check-In found."), "bad");
      if(x.checkOutAtLocal) return setMsg("msgAtt", (LANG==="ar" ? "ØªÙ… Ø¹Ù…Ù„ Check-Out Ù…Ø³Ø¨Ù‚Ù‹Ø§." : "Already checked out."), "bad");

      const geo = await assertInsideBranch(todayShift.branchId || "");
      const worked = Math.max(0, Math.round((Date.now() - Number(x.checkInAtLocal||Date.now()))/60000));

      await updateDoc(doc(db,"attendance", attendanceId), {
        status: "completed",
        workedMinutes: worked,
        checkOutAt: serverTimestamp(),
        checkOutAtLocal: Date.now(),
        gpsOut: geo.gps,
        gpsOutDistM: geo.distM,
        gpsOutRadiusM: geo.radiusM,
        updatedAt: serverTimestamp()
      });

      setMsg("msgAtt",
        (LANG==="ar" ? `ØªÙ… Check-Out âœ… (Ø¯Ø§Ø®Ù„ Ø§Ù„ÙØ±Ø¹) â€¢ Ø¹Ù…Ù„Øª ${worked} Ø¯Ù‚ÙŠÙ‚Ø©` : `Checked out âœ… (inside branch) â€¢ Worked ${worked} min`),
        "ok"
      );
      await loadAttendanceDoc();
      await loadAttLast7Days();
    }

    async function loadAttLast7Days(){
      const tb = $("att7Tbody");
      tb.innerHTML = "";

      const snap = await getDocs(collection(db,"attendance"));
      const rows = [];
      snap.forEach(d=>{
        const x = d.data() || {};
        const ok =
          (x.employeeUid && x.employeeUid === currentUser.uid) ||
          (x.employeeId && String(x.employeeId) === myPresetKey);
        if(!ok) return;

        if(!x.date) return;
        rows.push({ id:d.id, ...x });
      });
      rows.sort((a,b)=> String(b.date).localeCompare(String(a.date)));

      const last7 = rows.slice(0,7);
      for(const r of last7){
        const st = String(r.status||"").toLowerCase();
        const stLabel =
          st==="absent" ? t("absent") :
          st==="leave" ? t("leave") :
          st==="completed" ? t("completed") :
          st==="present" ? (Number(r.minutesLate||0)>0 ? t("late", r.minutesLate) : t("present")) :
          (r.status||"-");

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.date||"-"}</td>
          <td>${r.date ? dayNameFromYMD(r.date) : "-"}</td>
          <td>${r.branchName||r.branchId||"-"}</td>
          <td>${r.shiftName||"-"}</td>
          <td><span class="badge">${stLabel}</span></td>
          <td>${r.checkInAtLocal ? new Date(r.checkInAtLocal).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'}) : "-"}</td>
          <td>${r.checkOutAtLocal ? new Date(r.checkOutAtLocal).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'}) : "-"}</td>
        `;
        tb.appendChild(tr);
      }
    }

    // ===== Leaves UI helpers =====
    let leaveMode = "single";
    function setLeaveMode(mode){
      leaveMode = mode;
      $("leaveModeSingle").classList.toggle("active", mode==="single");
      $("leaveModeRange").classList.toggle("active", mode==="range");
      $("leaveModeScattered").classList.toggle("active", mode==="scattered");

      $("leavePanelSingle").classList.toggle("show", mode==="single");
      $("leavePanelRange").classList.toggle("show", mode==="range");
      $("leavePanelScattered").classList.toggle("show", mode==="scattered");
    }

    function addLeaveDateLine(val=""){
      const wrap = $("leaveDatesList");
      const line = document.createElement("div");
      line.className = "dateLine";
      line.innerHTML = `
        <input type="date" value="${String(val||"")}">
        <button class="smBtn danger" type="button">${LANG==="ar" ? "Ø­Ø°Ù" : "Delete"}</button>
      `;
      line.querySelector("button").addEventListener("click", ()=> line.remove());
      wrap.appendChild(line);
    }

    function clearLeaveDates(){ $("leaveDatesList").innerHTML = ""; }

    function getLeaveScatteredDates(){
      const dates = Array.from($("leaveDatesList").querySelectorAll('input[type="date"]'))
        .map(i=>i.value).filter(Boolean);
      return Array.from(new Set(dates)).sort();
    }

    function buildLeavePayload(){
      if(leaveMode === "single"){
        const day = $("lDay").value;
        if(!day) throw new Error(LANG==="ar" ? "Ø§Ø®ØªØ± ÙŠÙˆÙ… Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©" : "Choose the leave day");
        return { from: day, to: day, dates:[day], leaveMode:"single" };
      }
      if(leaveMode === "range"){
        const from = $("lFrom").value;
        const to = $("lTo").value;
        if(!from || !to) throw new Error(LANG==="ar" ? "Ø§Ø®ØªØ± Ù…Ù†/Ø¥Ù„Ù‰" : "Choose From/To");
        if(from > to) throw new Error(LANG==="ar" ? "Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù…Ù†) ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‚Ø¨Ù„ (Ø¥Ù„Ù‰)" : "From date must be before To date");
        return { from, to, dates:[], leaveMode:"range" };
      }
      const dates = getLeaveScatteredDates();
      if(!dates.length) throw new Error(LANG==="ar" ? "Ø£Ø¶Ù ØªØ§Ø±ÙŠØ® ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„" : "Add at least one date");
      return { from: dates[0], to: dates[dates.length-1], dates, leaveMode:"scattered" };
    }

    function leaveDatesLabel(r){
      const m = r.leaveMode || (r.dates && r.dates.length ? "scattered" : "range");
      if(m==="single"){
        const d = (r.from || (Array.isArray(r.dates)? r.dates[0] : "")) || "-";
        return d;
      }
      if(m==="scattered"){
        const arr = Array.isArray(r.dates) ? r.dates : [];
        if(arr.length<=3) return arr.join(" , ");
        return `${arr.slice(0,3).join(" , ")} ... (+${arr.length-3})`;
      }
      return `${r.from||"-"} â†’ ${r.to||"-"}`;
    }

    function leaveModeLabel(m){
      if(m==="single") return (LANG==="ar" ? "ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯" : "Single day");
      if(m==="scattered") return (LANG==="ar" ? "Ø£ÙŠØ§Ù… Ù…ØªÙØ±Ù‚Ø©" : "Scattered");
      return (LANG==="ar" ? "ÙØªØ±Ø©" : "Range");
    }

    async function loadMyLeaves(){
      const snap = await getDocs(collection(db,"leaves"));
      const rows = [];
      snap.forEach(d=>{
        const x = d.data() || {};
        const ok =
          (x.employeeUid && x.employeeUid === currentUser.uid) ||
          (x.employeeId && String(x.employeeId) === myPresetKey) ||
          (x.employeeEmail && String(x.employeeEmail).toLowerCase() === String(currentUser.email||"").toLowerCase());
        if(ok) rows.push({ id:d.id, ...x });
      });
      rows.sort((a,b)=> (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));

      const tb = $("myLeavesTbody");
      tb.innerHTML = "";
      if(!rows.length){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="3"><span class="badge">${LANG==="ar" ? "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª" : "No requests"}</span></td>`;
        tb.appendChild(tr);
        return;
      }

      for(const r of rows){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><span class="badge">${leaveModeLabel(r.leaveMode||"range")}</span></td>
          <td>${leaveDatesLabel(r)}</td>
          <td><span class="badge">${r.status||"pending"}</span></td>
        `;
        tb.appendChild(tr);
      }
    }

    // ===== âœ… Schedule (Ù…Ø¹ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø­ØªÙ‰ Ù„Ùˆ Ù…Ø§ ÙÙŠ Ø´ÙØª) =====
    function buildDateList(from,to){
      const out=[];
      const a=new Date(from), b=new Date(to);
      a.setHours(0,0,0,0); b.setHours(0,0,0,0);
      for(let d=new Date(a); d<=b; d.setDate(d.getDate()+1)){
        out.push(ymd(d));
      }
      return out;
    }

    async function loadMySchedule(from, to){
      try{
        // shifts
        const shifts = await fetchMyShiftsInRange(from, to, currentUser);
        shifts.sort((a,b)=>
          (a.date||"").localeCompare(b.date||"") ||
          ((timeToMin(a.start)??99999) - (timeToMin(b.start)??99999)) ||
          (a.shiftName||"").localeCompare(b.shiftName||"")
        );

        // approved leaves set
        const leaveSetAll = await getApprovedLeaveDatesForMe();
        const dates = buildDateList(from,to);
        const leaveSetInRange = new Set(dates.filter(d=> leaveSetAll.has(d)));

        // index shifts by date (take first shift per day for view)
        const byDate = new Map();
        for(const s of shifts){
          if(!byDate.has(s.date)) byDate.set(s.date, []);
          byDate.get(s.date).push(s);
        }

        const tb = $("mySchedTbody");
        tb.innerHTML = "";

        // show rows day-by-day (Ø­ØªÙ‰ Ù„Ùˆ Ù…Ø§ ÙÙŠ Ø´ÙØª)
        let rendered = 0;

        for(const d of dates){
          const dayName = dayNameFromYMD(d);
          const dayShifts = byDate.get(d) || [];
          const isLeave = leaveSetInRange.has(d);

          if(dayShifts.length){
            // render all shifts for that day
            for(const r of dayShifts){
              const tr = document.createElement("tr");
              if(isLeave) tr.classList.add("leaveRow"); // Ø¥Ø°Ø§ Ø¹Ù„ÙŠÙ‡ Ø¥Ø¬Ø§Ø²Ø©ØŒ Ù„ÙˆÙ†Ù‡ Ù…Ù…ÙŠØ²
              tr.innerHTML = `
                <td>${r.date||"-"}</td>
                <td>${dayName||"-"}</td>
                <td>${r.branchName||r.branchId||"-"}</td>
                <td>${isLeave ? t("leaveWord") : (r.shiftName||"-")}</td>
                <td>${isLeave ? "-" : ((r.start||"") && (r.end||"") ? `${r.start} - ${r.end}` : "-")}</td>
                <td>
                  ${isLeave ? `<span class="badge">${t("leaveWord")}</span> <span class="badge">${t("approvedLeave")}</span>` : (r.note ? `<span class="badge">${r.note}</span>` : "")}
                </td>
              `;
              tb.appendChild(tr);
              rendered++;
            }
          }else{
            // no shift, but leave? show leave row, otherwise show empty row
            if(isLeave){
              const tr = document.createElement("tr");
              tr.classList.add("leaveRow");
              tr.innerHTML = `
                <td>${d}</td>
                <td>${dayName}</td>
                <td>â€”</td>
                <td>${t("leaveWord")}</td>
                <td>â€”</td>
                <td><span class="badge">${t("leaveWord")}</span> <span class="badge">${t("approvedLeave")}</span></td>
              `;
              tb.appendChild(tr);
              rendered++;
            }else{
              // optional: show nothing OR show empty line. We show empty line for clarity.
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${d}</td>
                <td>${dayName}</td>
                <td>â€”</td>
                <td>â€”</td>
                <td>â€”</td>
                <td></td>
              `;
              tb.appendChild(tr);
              rendered++;
            }
          }
        }

        // msg
        setMsg("msgSched",
          rendered ? t("scheduleLoaded", rendered) : t("noShifts"),
          rendered ? "ok" : "bad"
        );
      }catch(e){
        setMsg("msgSched", e?.message || (LANG==="ar" ? "Ø®Ø·Ø£ Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„" : "Failed to load schedule"), "bad");
      }
    }

    async function refreshScheduleFromDropdown(){
      const kind = $("schedRange").value;
      const {from, to} = getRangeDates(kind);
      await loadMySchedule(from, to);
    }

    // ===== Fix modal =====
    function openFix(shiftObj){
      const s = shiftObj || todayShift || null;
      if(!s){
        setMsg("msgFixList", (LANG==="ar" ? "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´ÙØª Ù„ÙØªØ­ Ø·Ù„Ø¨ Ø§Ù„ØªØµØ­ÙŠØ­." : "No shift to open correction request."), "bad");
        return;
      }
      selectedFixShift = s;

      const date = s?.date || ymd(new Date());
      const meta = `${date} â€¢ ${(s?.branchName||s?.branchId||"")} â€¢ ${(s?.shiftName||"")} â€¢ ${((s?.start&&s?.end)?(s.start+"-"+s.end):"â€”")}`;
      pill($("fixMeta"), meta, "");
      pill($("fixHintPill"), (LANG==="ar" ? `Ø§Ù„Ø´ÙŠÙØª Ø§Ù„Ù…Ø­Ø¯Ø¯: ${date}` : `Selected shift: ${date}`), "");
      $("msgFix").className = "msg";
      $("msgFix").textContent = "";
      $("fixOv").classList.add("show");
      $("fixOv").setAttribute("aria-hidden","false");
      setTimeout(()=> $("fixNote").focus(), 50);
    }
    function closeFix(){
      $("fixOv").classList.remove("show");
      $("fixOv").setAttribute("aria-hidden","true");
    }

    // ===== Picker modal =====
    function openPick(){
      $("msgPick").style.display="none";
      $("pickOv").classList.add("show");
      $("pickOv").setAttribute("aria-hidden","false");
      setTimeout(()=> $("pickDate").focus(), 50);
      loadPickerShifts();
    }
    function closePick(){
      $("pickOv").classList.remove("show");
      $("pickOv").setAttribute("aria-hidden","true");
    }

    let pickerRowsCache = [];

    function renderPickerRows(rows){
      const tb = $("pickTbody");
      tb.innerHTML = "";
      pill($("pickMeta"), (LANG==="ar" ? `Ø¹Ø¯Ø¯ Ø§Ù„Ø´ÙØªØ§Øª: ${rows.length}` : `Shifts: ${rows.length}`), "");

      if(!rows.length){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="5"><span class="badge">${t("pickNone")}</span></td>`;
        tb.appendChild(tr);
        return;
      }

      rows.forEach((r, idx)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.date||"-"}</td>
          <td>${r.branchName||r.branchId||"-"}</td>
          <td>${r.shiftName||"-"}</td>
          <td>${(r.start&&r.end)?`${r.start} - ${r.end}`:"-"}</td>
          <td><button class="btn warn" data-pick="${idx}">${LANG==="ar" ? "Ø§Ø®ØªÙŠØ§Ø±" : "Pick"}</button></td>
        `;
        tb.appendChild(tr);
      });

      tb.querySelectorAll("[data-pick]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const idx = Number(btn.getAttribute("data-pick"));
          const s = rows[idx];
          if(!s) return;
          closePick();
          openFix(s);
        });
      });
    }

    function applyPickerFilterAndRender(){
      const q = ($("pickQ").value||"").trim().toLowerCase();
      const filtered = pickerRowsCache.filter(r=>{
        if(!q) return true;
        const hay = `${r.branchName||""} ${r.branchId||""} ${r.shiftName||""}`.toLowerCase();
        return hay.includes(q);
      });
      renderPickerRows(filtered);
    }

    async function loadPickerShifts(){
      try{
        const day = $("pickDate").value;
        if(!day){
          setMsg("msgPick", t("chooseDay"), "bad");
          pickerRowsCache = [];
          renderPickerRows([]);
          return;
        }

        setMsg("msgPick", t("loading"), "ok");

        const rows = await fetchMyShiftsInRange(day, day, currentUser);
        rows.sort((a,b)=>
          ((timeToMin(a.start)??99999) - (timeToMin(b.start)??99999)) ||
          (a.shiftName||"").localeCompare(b.shiftName||"")
        );

        pickerRowsCache = rows;

        if(!rows.length){
          setMsg("msgPick", t("pickNone"), "bad");
        }else{
          setMsg("msgPick", (LANG==="ar" ? `ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ âœ… (${rows.length})` : `Loaded âœ… (${rows.length})`), "ok");
        }

        applyPickerFilterAndRender();
      }catch(e){
        console.error(e);
        setMsg("msgPick", e?.message || (LANG==="ar" ? "ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´ÙØªØ§Øª." : "Failed to load shifts."), "bad");
      }
    }

    // ===== events =====
    initTabs();

    // Logout button âœ…
    $("btnLogout").addEventListener("click", async ()=>{
      try{
        await signOut(auth);
      }catch(e){
        console.warn(e);
      }
      location.href="./login.html";
    });

    // Language toggle âœ… + animation
    $("btnLang").addEventListener("click", ()=>{
      LANG = (LANG==="ar" ? "en" : "ar");
      localStorage.setItem("roma_staff_lang", LANG);
      applyLang();
      // refresh day names + schedule msg + leaves list view
      // (Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©)
      try{ refreshScheduleFromDropdown(); }catch{}
      try{ loadAttLast7Days(); }catch{}
      try{ loadMyLeaves(); }catch{}
      // re-render scattered delete button labels
      document.querySelectorAll("#leaveDatesList .dateLine button").forEach(btn=>{
        btn.textContent = (LANG==="ar" ? "Ø­Ø°Ù" : "Delete");
      });
    });

    $("btnIn").addEventListener("click", async ()=>{
      try{ await doCheckIn(); }catch(e){ console.error(e); setMsg("msgAtt", e?.message || "Error", "bad"); }
    });
    $("btnOutShift").addEventListener("click", async ()=>{
      try{ await doCheckOut(); }catch(e){ console.error(e); setMsg("msgAtt", e?.message || "Error", "bad"); }
    });

    $("btnFix").addEventListener("click", ()=>{
      if(!todayShift) return setMsg("msgFixList", (LANG==="ar" ? "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´ÙØª Ø§Ù„ÙŠÙˆÙ… Ù„Ø·Ù„Ø¨ Ø§Ù„ØªØµØ­ÙŠØ­." : "No shift today to request correction."), "bad");
      openFix(todayShift);
    });

    $("btnPickShift").addEventListener("click", openPick);

    $("pickClose").addEventListener("click", closePick);
    $("pickOv").addEventListener("click", (e)=>{ if(e.target === $("pickOv")) closePick(); });

    $("pickLoad").addEventListener("click", loadPickerShifts);
    $("pickQ").addEventListener("input", applyPickerFilterAndRender);

    $("pickToday").addEventListener("click", ()=>{
      $("pickDate").value = ymd(new Date());
      loadPickerShifts();
    });

    $("pickDate").addEventListener("change", ()=> loadPickerShifts());

    $("fixClose").addEventListener("click", closeFix);
    $("fixOv").addEventListener("click", (e)=>{ if(e.target === $("fixOv")) closeFix(); });
    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape"){
        closeFix();
        closePick();
      }
    });

    $("fixSend").addEventListener("click", async ()=>{
      try{
        const s = selectedFixShift || todayShift || null;
        if(!s) return setMsg("msgFix", (LANG==="ar" ? "Ø§Ø®ØªØ± Ø´ÙŠÙØª Ø£ÙˆÙ„Ø§Ù‹." : "Pick a shift first."), "bad");

        const date = s?.date || ymd(new Date());
        const note = $("fixNote").value.trim();
        if(!note) return setMsg("msgFix", (LANG==="ar" ? "Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„Ø·Ù„Ø¨." : "Write the reason."), "bad");

        const attId = attendanceIdFromShift(s, currentUser);

        await addDoc(collection(db,"attendance_corrections"), {
          employeeUid: currentUser.uid,
          employeeId: myPresetKey,
          employeeEmail: currentUser.email || "",
          employeeName: myProfile?.name || (currentUser.email||"").split("@")[0] || "",
          attendanceId: attId || "",
          date,
          branchId: s?.branchId || "",
          branchName: s?.branchName || "",
          shiftName: s?.shiftName || "",
          start: s?.start || "",
          end: s?.end || "",
          note,
          status: "pending",
          createdAt: serverTimestamp()
        });

        setMsg("msgFix", (LANG==="ar" ? "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØµØ­ÙŠØ­ âœ… (Pending)" : "Correction request sent âœ… (Pending)"), "ok");
        $("fixNote").value = "";
      }catch(e){
        console.error(e);
        setMsg("msgFix", e?.message || "Error", "bad");
      }
    });

    $("btnTestGps").addEventListener("click", async ()=>{
      try{
        if(!todayShift?.branchId) return setMsg("msgAtt", (LANG==="ar" ? "Ù„Ø§ ÙŠÙˆØ¬Ø¯ branchId Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´ÙØª." : "No branchId for this shift."), "bad");
        const res = await assertInsideBranch(todayShift.branchId);
        if(res.ok){
          setMsg("msgAtt", (LANG==="ar"
            ? `âœ… Ø£Ù†Øª Ø¯Ø§Ø®Ù„ Ø§Ù„ÙØ±Ø¹: Ø¨Ø¹ÙŠØ¯ ${res.distM}m (Ø§Ù„Ù…Ø³Ù…ÙˆØ­ ${res.radiusM}m).`
            : `âœ… You are inside: ${res.distM}m away (allowed ${res.radiusM}m).`
          ), "ok");
        }else{
          setMsg("msgAtt", (LANG==="ar"
            ? `âŒ Ø£Ù†Øª Ø®Ø§Ø±Ø¬ Ø§Ù„ÙØ±Ø¹: Ø¨Ø¹ÙŠØ¯ ${res.distM}m (Ø§Ù„Ù…Ø³Ù…ÙˆØ­ ${res.radiusM}m).`
            : `âŒ You are outside: ${res.distM}m away (allowed ${res.radiusM}m).`
          ), "bad");
        }
      }catch(e){
        setMsg("msgAtt", e?.message || (LANG==="ar" ? "ÙØ´Ù„ ÙØ­Øµ GPS" : "GPS test failed"), "bad");
      }
    });

    $("leaveModeSingle").addEventListener("click", ()=> setLeaveMode("single"));
    $("leaveModeRange").addEventListener("click", ()=> setLeaveMode("range"));
    $("leaveModeScattered").addEventListener("click", ()=> setLeaveMode("scattered"));

    $("btnAddLeaveDate").addEventListener("click", ()=> addLeaveDateLine(""));
    $("btnClearLeaveDates").addEventListener("click", clearLeaveDates);

    $("btnLeave").addEventListener("click", async ()=>{
      try{
        const payload = buildLeavePayload();

        await addDoc(collection(db,"leaves"), {
          employeeUid: currentUser.uid,
          employeeId: myPresetKey,
          employeeEmail: (currentUser.email || "").toLowerCase(),
          employeeName: myProfile?.name || (currentUser.email||"").split("@")[0] || "",

          leaveMode: payload.leaveMode,
          dates: (payload.leaveMode==="single" || payload.leaveMode==="scattered") ? payload.dates : [],
          from: payload.from,
          to: payload.to,

          status: "pending",
          createdAt: serverTimestamp()
        });

        setMsg("msgLeave", (LANG==="ar" ? "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ âœ…" : "Request sent âœ…"), "ok");
        await loadMyLeaves();
        await refreshScheduleFromDropdown(); // Ù„ÙŠØ¸Ù‡Ø± pending/approved Ù„Ø§Ø­Ù‚Ø§Ù‹
      }catch(e){
        setMsg("msgLeave", e?.message || (LANG==="ar" ? "ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" : "Check the data"), "bad");
      }
    });

    $("btnLoadSched").addEventListener("click", refreshScheduleFromDropdown);
    $("schedRange").addEventListener("change", refreshScheduleFromDropdown);

    // ===== Boot =====
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href="./login.html"; return; }
      currentUser = user;

      // âœ… matches shifts docs: employeeId = uid
      myPresetKey = user.uid;

      const mePill = $("mePill");
      if(mePill) mePill.textContent = user.email || user.uid;

      // Apply language first (so UI correct)
      applyLang();

      await ensureEmployeeDoc(user);
      await getMyRole(user.uid); // (kept for future)

      try{
        const p = await getDoc(doc(db,"employees", user.uid));
        myProfile = p.exists() ? (p.data()||null) : null;
      }catch{ myProfile=null; }

      const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate()+1);
      const after = new Date(tomorrow); after.setDate(after.getDate()+1);

      setLeaveMode("single");
      $("lDay").value = ymd(tomorrow);

      $("lFrom").value = ymd(tomorrow);
      $("lTo").value = ymd(after);

      clearLeaveDates();
      addLeaveDateLine(ymd(tomorrow));

      $("pickDate").value = ymd(new Date());
      pill($("pickMeta"), (LANG==="ar" ? "Ø§Ø®ØªØ± ÙŠÙˆÙ… Ø«Ù… Ø­Ù…Ù‘Ù„" : "Pick a day then load"), "");

      await loadMyLeaves();
      await refreshScheduleFromDropdown();

      await loadTodayShift();
      await loadAttendanceDoc();
      await loadAttLast7Days();
    });
  </script>
</body>
</html>
