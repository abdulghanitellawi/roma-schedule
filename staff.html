<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Roma Schedule - Staff</title>
  <link rel="icon" href="./assets/logo.webp">
  <style>
    :root{
      --bg:#0b1220; --panel:rgba(255,255,255,.06); --line:rgba(255,255,255,.14);
      --txt:#e5e7eb; --muted:#9ca3af; --accent:#d4a019; --shadow: 0 18px 60px rgba(0,0,0,.35);
      --ok:#16a34a; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; background:
        radial-gradient(1200px 600px at 10% 10%, rgba(212,160,25,.16), transparent 55%),
        radial-gradient(900px 500px at 90% 20%, rgba(59,130,246,.14), transparent 55%),
        var(--bg);
      color:var(--txt);
      font-family: system-ui, "Noto Sans Arabic", Tahoma, Arial, sans-serif;
    }
    .top{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(10,16,28,.55);
      border-bottom:1px solid var(--line);
    }
    .topin{max-width:1100px; margin:0 auto; padding:14px; display:flex; gap:10px; align-items:center; justify-content:space-between}
    .brand{display:flex; align-items:center; gap:10px}
    .brand img{width:30px;height:30px;object-fit:contain;border-radius:12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12)}
    .btn{
      cursor:pointer; border:1px solid var(--line); background:rgba(255,255,255,.06);
      color:var(--txt); padding:10px 12px; border-radius:12px; font-weight:900;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      text-decoration:none;
    }
    .btn:hover{background:rgba(255,255,255,.09)}
    .btn.primary{border-color:rgba(212,160,25,.45); background:rgba(212,160,25,.14)}
    .btn.primary:hover{background:rgba(212,160,25,.20)}
    .btn.danger{border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.12)}
    .btn.danger:hover{background:rgba(239,68,68,.16)}
    .wrap{max-width:1100px; margin:0 auto; padding:14px}
    .grid{display:grid; grid-template-columns: 360px 1fr; gap:14px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }
    .card{border:1px solid var(--line); background:var(--panel); border-radius:18px; padding:12px; box-shadow:var(--shadow)}
    h2{margin:0 0 10px; font-size:18px}
    .mini{color:var(--muted); font-size:12px; line-height:1.7}
    label{display:block; margin:10px 0 6px; color:var(--muted); font-size:13px}
    input,select{
      width:100%; padding:11px 12px; border-radius:12px;
      border:1px solid var(--line); background:rgba(0,0,0,.16);
      color:var(--txt); outline:none;
    }
    input:focus,select:focus{border-color:rgba(212,160,25,.65);box-shadow:0 0 0 4px rgba(212,160,25,.14)}
    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px}
    th,td{padding:10px; border-bottom:1px solid rgba(255,255,255,.08); text-align:right; font-size:13px; vertical-align:top}
    th{color:var(--muted); font-weight:900; background:rgba(255,255,255,.04)}
    .msg{margin-top:10px; padding:10px 12px; border-radius:12px; border:1px solid var(--line); display:none; white-space:pre-line}
    .msg.ok{display:block; border-color:rgba(22,163,74,.35); background:rgba(22,163,74,.12)}
    .msg.bad{display:block; border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.12)}
    .badge{display:inline-block; padding:6px 10px; border:1px solid var(--line); border-radius:999px; color:var(--muted); font-size:12px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:7px 10px;border:1px solid rgba(255,255,255,.14);border-radius:999px;background:rgba(255,255,255,.05)}
    .timeCell{direction:ltr; unicode-bidi:embed; text-align:left;}
  </style>
</head>
<body>
  <div class="top">
    <div class="topin">
      <div class="brand">
        <img src="./assets/logo.webp" alt="Roma">
        <div>
          <b>Roma Schedule</b>
          <div class="badge" id="mePill">...</div>
        </div>
      </div>
      <div style="display:flex; gap:10px; align-items:center">
        <a class="btn" href="./admin-dashboard.html" id="goAdmin" style="display:none">لوحة الأدمن</a>
        <button class="btn danger" id="btnOut">تسجيل خروج</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <div class="card">
        <h2>طلب إجازة</h2>
        <label>من تاريخ</label>
        <input id="lFrom" type="date">
        <label>إلى تاريخ</label>
        <input id="lTo" type="date">
        <button class="btn primary" id="btnLeave" style="margin-top:12px; width:100%">إرسال الطلب</button>
        <div id="msgLeave" class="msg"></div>

        <hr style="border:none;border-top:1px solid rgba(255,255,255,.12); margin:14px 0">

        <h2>طلباتي</h2>
        <div style="overflow:auto; margin-top:10px">
          <table>
            <thead><tr><th>من</th><th>إلى</th><th>الحالة</th></tr></thead>
            <tbody id="myLeavesTbody"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
          <div>
            <h2 style="margin:0">جدولي</h2>
            <div class="mini">مصدر العرض: employees/{uid}/schedules</div>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
            <button class="btn" id="btnThisWeek">هذا الأسبوع</button>
            <button class="btn" id="btnNextWeek">الأسبوع القادم</button>
          </div>
        </div>

        <div style="overflow:auto; margin-top:10px">
          <table>
            <thead><tr><th>التاريخ</th><th>الفرع</th><th>الشفت</th><th>الوقت</th><th>ملاحظة</th></tr></thead>
            <tbody id="mySchedTbody"></tbody>
          </table>
        </div>
        <div id="msgSched" class="msg"></div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div>
          <h2 style="margin:0">الحضور اليوم (GPS)</h2>
          <div class="mini">
            • لا يمكن عمل Check-in / Check-out إلا داخل نطاق الفرع (Geofence).<br>
            • الحساب ينربط بأول جهاز يعمل Check-in (مكافحة مشاركة الحساب).<br>
            • يتم حساب التأخير/الخروج المبكر حسب وقت السيرفر.
          </div>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap">
          <span class="pill">جهازي: <span class="badge" id="devPill">...</span></span>
          <button class="btn" id="btnAttReload">تحديث</button>
        </div>
      </div>

      <div id="msgAtt" class="msg"></div>

      <div style="overflow:auto;margin-top:10px">
        <table>
          <thead>
            <tr>
              <th>الفرع</th>
              <th>الشفت</th>
              <th class="timeCell">الوقت</th>
              <th>الحالة</th>
              <th>الإجراء</th>
            </tr>
          </thead>
          <tbody id="attTodayTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc,
      collection, addDoc, getDocs, query, where,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN88FY9CJU8T8cm5lLYjcI-I8VmD46o40",
      authDomain: "roma-schedule.firebaseapp.com",
      projectId: "roma-schedule",
      storageBucket: "roma-schedule.firebasestorage.app",
      messagingSenderId: "685810932602",
      appId: "1:685810932602:web:f1ec506ea6ff5e919d94c3",
      measurementId: "G-5FY5S5TZLJ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id)=>document.getElementById(id);
    const setMsg = (id, text, type="ok")=>{
      const el = $(id);
      el.className = "msg " + (type==="bad"?"bad":"ok");
      el.textContent = text;
    };

    function ymd(d){
      const dt = new Date(d);
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,"0");
      const da = String(dt.getDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    }
    function startOfWeek(d){
      const x = new Date(d);
      x.setHours(0,0,0,0);
      const day = x.getDay(); // 0 Sun .. 6 Sat
      const diff = (day===0 ? -6 : 1-day); // Monday
      x.setDate(x.getDate()+diff);
      return x;
    }

    // ===== Email → presetId (employees_email) =====
    const safeEmailDocId = (email)=> email.trim().toLowerCase().replace(/\\./g,"(dot)");
    const presetIdFromEmail = (email)=> email ? ("preset:" + safeEmailDocId(email)) : null;

    async function readPresetByEmail(email){
      const ref = doc(db, "employees_email", safeEmailDocId(email));
      const snap = await getDoc(ref);
      return snap.exists() ? snap.data() : null;
    }

    async function ensureEmployeeDoc(user){
      const ref = doc(db, "employees", user.uid);
      const snap = await getDoc(ref);
      if(snap.exists()) return;

      const preset = await readPresetByEmail(user.email || "");
      const base = {
        name: (user.email||"user").split("@")[0],
        email: user.email || "",
        role: "staff",
        type: "regular",
        department: "General",
        branchId: "",
        fixedBranch: true,
        coverAllBranches: false,
        coverBranchIds: [],
        canCover: true,
        active: true,
        createdAt: serverTimestamp()
      };
      const data = preset ? { ...base, ...preset } : base;
      await setDoc(ref, data, { merge:true });
    }

    async function getMyRole(uid){
      const snap = await getDoc(doc(db,"employees",uid));
      return snap.exists() ? (snap.data()?.role || "staff") : "staff";
    }

    // ===== Geofence helpers =====
    function toRad(x){ return x * Math.PI / 180; }
    function haversineMeters(lat1,lng1,lat2,lng2){
      const R = 6371000;
      const dLat = toRad(lat2-lat1);
      const dLng = toRad(lng2-lng1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
      return 2*R*Math.asin(Math.sqrt(a));
    }
    function getGeo(){
      return new Promise((resolve,reject)=>{
        if(!("geolocation" in navigator)) return reject(new Error("الجهاز لا يدعم GPS"));
        navigator.geolocation.getCurrentPosition(
          (pos)=> resolve(pos),
          (err)=> reject(new Error(err?.message || "فشل الحصول على موقعك")),
          { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
        );
      });
    }
    function pickBranchGeo(branchData){
      const d = branchData || {};
      const lat = d.geoLat ?? d.lat ?? d.latitude ?? d.location?.lat ?? null;
      const lng = d.geoLng ?? d.lng ?? d.longitude ?? d.location?.lng ?? null;
      const radiusM = Number(d.geoRadiusM ?? d.radiusM ?? d.radius ?? 150);
      if(lat==null || lng==null) return null;
      return { lat:Number(lat), lng:Number(lng), radiusM: isFinite(radiusM)?radiusM:150 };
    }

    // ===== Anti-tamper helpers (server time + device binding) =====
    function uuid(){
      return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, c=>{
        const r = (crypto.getRandomValues(new Uint8Array(1))[0] & 15);
        const v = c==="x" ? r : (r & 0x3) | 0x8;
        return v.toString(16);
      });
    }
    function getOrCreateDeviceId(){
      const key = "roma_device_id";
      let v = localStorage.getItem(key);
      if(!v){
        v = uuid();
        localStorage.setItem(key, v);
      }
      return v;
    }
    function timeToMin(t){
      const m = String(t||"").trim().match(/^(\\d{1,2}):(\\d{2})$/);
      if(!m) return null;
      const hh = Math.max(0, Math.min(23, parseInt(m[1],10)));
      const mm = Math.max(0, Math.min(59, parseInt(m[2],10)));
      return hh*60 + mm;
    }
    function combineDateAndMin(ymdStr, mins){
      const [y,m,d] = String(ymdStr).split("-").map(n=>parseInt(n,10));
      const dt = new Date(y, (m||1)-1, d||1, 0,0,0,0);
      dt.setMinutes(mins);
      return dt;
    }

    let _serverOffsetMs = null;
    async function getServerOffsetMs(){
      if(_serverOffsetMs != null) return _serverOffsetMs;
      try{
        const ref = doc(db,"meta","clock");
        await setDoc(ref, { ts: serverTimestamp() }, { merge:true });
        const snap = await getDoc(ref);
        const ts = snap.exists() ? snap.data()?.ts : null;
        if(ts && typeof ts.toDate === "function"){
          const serverNow = ts.toDate().getTime();
          _serverOffsetMs = serverNow - Date.now();
          return _serverOffsetMs;
        }
      }catch(_){}
      _serverOffsetMs = 0;
      return 0;
    }

    // ===== Attendance (GPS + device + late/early) =====
    function statusLabel(r){
      const blocked = r.blocked === true || r.status === "blocked";
      if(blocked) return "blocked";
      if(r.status) return r.status;
      const hasIn = !!r.checkInAt;
      const hasOut = !!r.checkOutAt;
      if(hasIn && hasOut) return "out";
      if(hasIn) return "in";
      return "-";
    }

    async function loadTodayAttendance(){
      try{
        const today = ymd(new Date());
        const presetId = presetIdFromEmail(me?.email || "");
        if(!presetId){
          $("attTodayTbody").innerHTML = `<tr><td colspan="5" class="badge">لا يوجد Email بالحساب</td></tr>`;
          return;
        }

        setMsg("msgAtt","جاري التحميل...","ok");

        // ✅ بدون composite index: نجيب شفتات اليوم فقط ثم نفلتر محلياً حسب employeeId
        const shSnap = await getDocs(query(collection(db,"shifts"), where("date","==", today)));
        const shifts=[];
        shSnap.forEach(d=>{
          const x=d.data()||{};
          if(String(x.employeeId||"") === String(presetId)) shifts.push({ id:d.id, ...x });
        });
        shifts.sort((a,b)=> (a.start||"").localeCompare(b.start||""));

        // attendance docs for today (filter locally)
        const atSnap = await getDocs(query(collection(db,"attendance"), where("date","==", today)));
        const attByShift = new Map();
        atSnap.forEach(d=>{
          const x=d.data()||{};
          if(String(x.employeeId||"") !== String(presetId)) return;
          if(x.shiftId) attByShift.set(String(x.shiftId), { id:d.id, ...x });
        });

        const tb = $("attTodayTbody");
        tb.innerHTML = "";
        if(!shifts.length){
          tb.innerHTML = `<tr><td colspan="5" class="badge">لا يوجد شفتات لك اليوم</td></tr>`;
          setMsg("msgAtt","—","ok");
          return;
        }

        for(const sh of shifts){
          const rec = attByShift.get(String(sh.id)) || null;
          const st = statusLabel(rec||{});
          const hasIn = !!rec?.checkInAt;
          const hasOut = !!rec?.checkOutAt;
          const blocked = st==="blocked";

          let actionHtml = "";
          if(blocked){
            actionHtml = `<button class="btn" data-act="in" data-shift="${esc(sh.id)}">إعادة محاولة</button>`;
          }else if(!hasIn){
            actionHtml = `<button class="btn primary" data-act="in" data-shift="${esc(sh.id)}">Check-in</button>`;
          }else if(hasIn && !hasOut){
            actionHtml = `<button class="btn danger" data-act="out" data-shift="${esc(sh.id)}">Check-out</button>`;
          }else{
            actionHtml = `<span class="badge">تم ✅</span>`;
          }

          const extra = rec?.lateMinutes ? ` • Late ${rec.lateMinutes}m` : rec?.earlyMinutes ? ` • Early ${rec.earlyMinutes}m` : "";
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${esc(sh.branchName||sh.branchId||"-")}</td>
            <td>${esc(sh.shiftName||"-")}${sh.shiftSlot>1?` <span class="badge">#${esc(sh.shiftSlot)}</span>`:""}</td>
            <td class="timeCell">${esc(sh.start||"")} → ${esc(sh.end||"")}</td>
            <td><span class="badge">${esc(st)}${esc(extra)}</span></td>
            <td>${actionHtml}</td>
          `;
          tb.appendChild(tr);
        }

        tb.querySelectorAll("button[data-act]").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            const act = btn.getAttribute("data-act");
            const shiftId = btn.getAttribute("data-shift");
            const sh = shifts.find(x=> String(x.id)===String(shiftId));
            if(!sh) return;
            await doAttendanceAction(act, sh);
            await loadTodayAttendance();
          });
        });

        setMsg("msgAtt","تم ✅","ok");
      }catch(e){
        setMsg("msgAtt", e?.message || "خطأ بالحضور", "bad");
      }
    }

    async function doAttendanceAction(action, sh){
      const today = ymd(new Date());
      const presetId = presetIdFromEmail(me?.email || "");
      if(!presetId) return setMsg("msgAtt","لا يوجد Email بالحساب","bad");

      // GPS needs HTTPS
      if(location.protocol !== "https:" && location.hostname !== "localhost" && location.hostname !== "127.0.0.1"){
        return setMsg("msgAtt","الـ GPS يحتاج HTTPS. ارفع الموقع على Hosting أو افتحه عبر HTTPS.","bad");
      }

      // server time
      const serverOffsetMs = await getServerOffsetMs();
      const serverNow = new Date(Date.now() + serverOffsetMs);

      // device
      const deviceId = getOrCreateDeviceId();
      $("devPill").textContent = deviceId.slice(0,8);
      const deviceInfo = {
        id: deviceId,
        ua: navigator.userAgent || "",
        tz: Intl.DateTimeFormat().resolvedOptions().timeZone || "",
        platform: navigator.platform || ""
      };

      setMsg("msgAtt","جاري تحديد موقعك...","ok");

      // branch geofence
      const brSnap = await getDoc(doc(db,"branches", sh.branchId));
      const brData = brSnap.exists() ? brSnap.data() : null;
      const geo = pickBranchGeo(brData);
      if(!geo){
        return setMsg("msgAtt","هذا الفرع ليس لديه GPS بعد. اطلب من الأدمن يحدد lat/lng + radius ضمن الفروع.","bad");
      }

      const pos = await getGeo();
      const curLat = pos.coords.latitude;
      const curLng = pos.coords.longitude;
      const accuracyM = pos.coords.accuracy ?? null;

      const distM = haversineMeters(curLat,curLng, geo.lat, geo.lng);
      const allow = distM <= (geo.radiusM + Math.max(0, Number(accuracyM||0)));

      const docId = `${today}__${presetId}__${sh.id}`;
      const ref = doc(db,"attendance", docId);

      // shift time calc
      const startMin = timeToMin(sh.start||"");
      const endMin = timeToMin(sh.end||"");
      const shiftStart = (startMin==null) ? null : combineDateAndMin(today, startMin);
      const shiftEnd   = (endMin==null) ? null : combineDateAndMin(today, endMin);

      const graceLateMin = 10;
      const graceEarlyMin = 10;

      // device binding
      const devRef = doc(db,"attendance_devices", presetId);
      const devSnap = await getDoc(devRef);
      const bound = devSnap.exists() ? (devSnap.data()||{}) : null;
      const boundId = bound?.deviceId || null;

      // build base payload
      const base = {
        date: today,
        shiftId: sh.id,
        shiftName: sh.shiftName || "",
        branchId: sh.branchId || "",
        branchName: sh.branchName || "",
        employeeId: presetId,
        employeeUid: me.uid,
        employeeEmail: me.email || "",
        employeeName: (me.email||"").split("@")[0],
        deviceInfo,
        gps: { lat: curLat, lng: curLng, accuracyM, distanceM: distM, radiusM: geo.radiusM, within: allow },
        serverNow: serverNow.toISOString(),
        updatedAt: serverTimestamp()
      };

      if(boundId && boundId !== deviceId){
        await setDoc(ref, {
          ...base,
          blocked: true,
          status: "blocked",
          blockedReason: "device_mismatch",
          blockedAction: action,
          attemptedDeviceId: deviceId,
          blockedAt: serverTimestamp()
        }, { merge:true });
        return setMsg("msgAtt","❌ هذا الحساب مربوط بجهاز آخر. تواصل مع الأدمن ليعمل Reset للجهاز.","bad");
      }

      if(!allow){
        await setDoc(ref, {
          ...base,
          blocked: true,
          status: "blocked",
          blockedReason: "gps_outside",
          blockedAction: action,
          blockedAt: serverTimestamp()
        }, { merge:true });
        return setMsg("msgAtt",`❌ خارج نطاق الفرع: تبعد تقريباً ${Math.round(distM)}m (المسموح ${Math.round(geo.radiusM)}m)`,"bad");
      }

      // bind device if first time (only when action allowed)
      if(!boundId){
        await setDoc(devRef, {
          employeeId: presetId,
          employeeEmail: me.email || "",
          employeeUid: me.uid,
          deviceId,
          deviceInfo,
          firstSeenAt: serverTimestamp(),
          lastSeenAt: serverTimestamp()
        }, { merge:true });
      }else{
        await setDoc(devRef, { lastSeenAt: serverTimestamp(), deviceInfo }, { merge:true });
      }

      const existingSnap = await getDoc(ref);
      const existing = existingSnap.exists() ? (existingSnap.data()||{}) : null;

      if(action === "in"){
        if(existing?.checkInAt) return setMsg("msgAtt","⚠️ أنت عامل Check-in مسبقاً لهذا الشفت.","bad");

        let lateMinutes = 0;
        if(shiftStart){
          lateMinutes = Math.max(0, Math.floor((serverNow.getTime() - shiftStart.getTime())/60000));
        }
        const isLate = lateMinutes > graceLateMin;

        await setDoc(ref, {
          ...base,
          blocked: false,
          status: isLate ? "late" : "in",
          lateMinutes: isLate ? lateMinutes : 0,
          graceLateMin,
          checkInAt: serverTimestamp(),
          checkInServerNow: serverNow.toISOString()
        }, { merge:true });

        return setMsg("msgAtt", isLate ? `✅ تم Check-in (متأخر ${lateMinutes} دقيقة)` : "✅ تم Check-in بنجاح","ok");
      }

      if(action === "out"){
        if(!existing?.checkInAt) return setMsg("msgAtt","⚠️ لازم تعمل Check-in أولاً.","bad");
        if(existing?.checkOutAt) return setMsg("msgAtt","⚠️ أنت عامل Check-out مسبقاً لهذا الشفت.","bad");

        let earlyMinutes = 0;
        if(shiftEnd){
          earlyMinutes = Math.max(0, Math.floor((shiftEnd.getTime() - serverNow.getTime())/60000));
        }
        const isEarly = earlyMinutes > graceEarlyMin;

        await setDoc(ref, {
          ...base,
          blocked: false,
          status: isEarly ? "early_out" : "out",
          earlyMinutes: isEarly ? earlyMinutes : 0,
          graceEarlyMin,
          checkOutAt: serverTimestamp(),
          checkOutServerNow: serverNow.toISOString()
        }, { merge:true });

        return setMsg("msgAtt", isEarly ? `✅ تم Check-out (خروج مبكر ${earlyMinutes} دقيقة)` : "✅ تم Check-out بنجاح","ok");
      }
    }

    function esc(s){
      return String(s ?? "").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;"," >":"&gt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m] || m));
    }

    // ===== Leaves + schedule (existing) =====
    async function loadMyLeaves(){
      const snap = await getDocs(collection(db,"leaves"));
      const rows = [];
      snap.forEach(d=>{
        const x=d.data();
        if(x.employeeId===me.uid) rows.push(x);
      });
      rows.sort((a,b)=> (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
      const tb = $("myLeavesTbody");
      tb.innerHTML = "";
      for(const r of rows){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.from||"-"}</td>
          <td>${r.to||"-"}</td>
          <td><span class="badge">${r.status||"pending"}</span></td>
        `;
        tb.appendChild(tr);
      }
    }

    async function loadMySchedule(from, to){
      try{
        const daysSet = new Set();
        const a = new Date(from), b = new Date(to);
        a.setHours(0,0,0,0); b.setHours(0,0,0,0);
        for(let d=new Date(a); d<=b; d.setDate(d.getDate()+1)) daysSet.add(ymd(d));

        const snap = await getDocs(collection(db, "employees", me.uid, "schedules"));
        const rows = [];
        snap.forEach(d=>{
          const x=d.data();
          if(daysSet.has(x.date)) rows.push(x);
        });
        rows.sort((a,b)=> (a.date||"").localeCompare(b.date||"") || (a.shiftName||"").localeCompare(b.shiftName||""));

        const tb = $("mySchedTbody");
        tb.innerHTML = "";
        for(const r of rows){
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${r.date||"-"}</td>
            <td>${r.branchName||r.branchId||"-"}</td>
            <td>${r.shiftName||"-"}</td>
            <td class="timeCell">${(r.start||"") && (r.end||"") ? `${r.start} - ${r.end}` : "-"}</td>
            <td>${r.note ? `<span class="badge">${r.note}</span>` : ""}</td>
          `;
          tb.appendChild(tr);
        }
        setMsg("msgSched",`تم تحميل الجدول من ${from} إلى ${to} ✅`,"ok");
      }catch(e){
        setMsg("msgSched", e?.message || "خطأ بتحميل الجدول", "bad");
      }
    }

    async function loadMyScheduleThisWeek(){
      const start = startOfWeek(new Date());
      const end = new Date(start); end.setDate(end.getDate()+6);
      await loadMySchedule(ymd(start), ymd(end));
    }
    async function loadMyScheduleNextWeek(){
      const start = startOfWeek(new Date());
      start.setDate(start.getDate()+7);
      const end = new Date(start); end.setDate(end.getDate()+6);
      await loadMySchedule(ymd(start), ymd(end));
    }

    $("btnThisWeek").addEventListener("click", loadMyScheduleThisWeek);
    $("btnNextWeek").addEventListener("click", loadMyScheduleNextWeek);

    $("btnAttReload").addEventListener("click", loadTodayAttendance);

    let me = null;

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href="./login.html"; return; }
      me = user;
      $("mePill").textContent = user.email || user.uid;

      await ensureEmployeeDoc(user);
      const role = await getMyRole(user.uid);
      if(role==="admin") $("goAdmin").style.display="inline-flex";

      const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate()+1);
      const after = new Date(tomorrow); after.setDate(after.getDate()+1);
      $("lFrom").value = ymd(tomorrow);
      $("lTo").value = ymd(after);

      $("devPill").textContent = getOrCreateDeviceId().slice(0,8);

      await loadMyLeaves();
      await loadMyScheduleThisWeek();
      await loadTodayAttendance();
    });

    $("btnOut").addEventListener("click", async ()=>{ await signOut(auth); location.href="./login.html"; });

    $("btnLeave").addEventListener("click", async ()=>{
      const from = $("lFrom").value;
      const to = $("lTo").value;
      if(!from || !to) return setMsg("msgLeave","اختر من/إلى","bad");
      if(from > to) return setMsg("msgLeave","التاريخ (من) يجب أن يكون قبل (إلى)","bad");

      await addDoc(collection(db,"leaves"), {
        employeeId: me.uid,
        from, to,
        status: "pending",
        createdAt: serverTimestamp()
      });
      setMsg("msgLeave","تم إرسال الطلب ✅","ok");
      await loadMyLeaves();
    });
  </script>
</body>
</html>
