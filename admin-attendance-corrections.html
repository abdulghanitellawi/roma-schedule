<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Roma Schedule - Ø·Ù„Ø¨Ø§Øª ØªØµØ­ÙŠØ­ Ø§Ù„Ø­Ø¶ÙˆØ±</title>
  <link rel="icon" href="./assets/logo.webp">

  <!-- Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.04);
      --line:rgba(255,255,255,.14);
      --line2:rgba(255,255,255,.10);
      --txt:#e5e7eb;
      --muted:#9ca3af;
      --accent:#d4a019;
      --shadow:0 18px 60px rgba(0,0,0,.35);
      --ok:#16a34a;
      --bad:#ef4444;
      --warn:#f59e0b;
      --info:#60a5fa;
      --ease:cubic-bezier(.22,.61,.36,1);
    }
    *{box-sizing:border-box}
    body{
      margin:0;min-height:100vh;
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(212,160,25,.16), transparent 55%),
        radial-gradient(900px 500px at 90% 20%, rgba(59,130,246,.14), transparent 55%),
        var(--bg);
      color:var(--txt);
      font-family:system-ui,"Noto Sans Arabic",Tahoma,Arial,sans-serif
    }

    a.btn,button.btn{
      cursor:pointer;border:1px solid var(--line);background:rgba(255,255,255,.06);color:var(--txt);
      padding:10px 12px;border-radius:12px;font-weight:900;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      text-decoration:none;
      transition: transform .12s var(--ease), background .12s var(--ease), border-color .12s var(--ease);
      user-select:none;
    }
    .btn:hover{background:rgba(255,255,255,.10); transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.primary{border-color:rgba(212,160,25,.45);background:rgba(212,160,25,.14)}
    .btn.primary:hover{background:rgba(212,160,25,.22)}
    .btn.danger{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.12)}
    .btn.danger:hover{background:rgba(239,68,68,.18)}
    .btn.warn{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.10)}
    .btn.warn:hover{background:rgba(245,158,11,.16)}
    .btn.ghost{background:transparent}
    .btn:disabled{opacity:.45; cursor:not-allowed; transform:none!important}

    .wrap{max-width:1600px;margin:0 auto;padding:14px}
    .card{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      border-radius:18px;padding:12px;
      box-shadow:var(--shadow);
      margin-bottom:12px
    }
    h2{margin:0 0 10px;font-size:18px}
    .mini{color:var(--muted);font-size:12px;line-height:1.7}

    .msg{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);display:none;white-space:pre-line}
    .msg.ok{display:block;border-color:rgba(22,163,74,.35);background:rgba(22,163,74,.12)}
    .msg.bad{display:block;border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.12)}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .split{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .toolbar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      padding:10px; border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04); border-radius:16px;
    }
    .toolbar .left,.toolbar .right{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    input,select{
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      color:var(--txt);
      padding:11px 12px;border-radius:12px;outline:none;
      transition:.15s var(--ease);
      min-height:42px;
    }
    input:focus,select:focus{border-color:rgba(212,160,25,.70);box-shadow:0 0 0 4px rgba(212,160,25,.14)}
    input[type="date"]{min-width:180px}
    select{min-width:220px}
    .search{min-width:min(520px, 100%)}

    .kpi{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
    @media (max-width:1100px){.kpi{grid-template-columns:1fr 1fr 1fr}}
    @media (max-width:680px){.kpi{grid-template-columns:1fr 1fr}}
    .box{
      border:1px solid var(--line2);
      background:rgba(255,255,255,.05);
      border-radius:16px;
      padding:12px;
    }
    .box b{font-size:24px; letter-spacing:.5px}
    .box .mini{margin-top:4px}

    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:7px 10px;border:1px solid var(--line);
      border-radius:999px;color:var(--muted);font-size:12px;white-space:nowrap
    }
    .badge.ok{border-color:rgba(22,163,74,.35);background:rgba(22,163,74,.12);color:#d1fae5}
    .badge.bad{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.12);color:#fee2e2}
    .badge.warn{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.10);color:#ffedd5}
    .badge.info{border-color:rgba(96,165,250,.35);background:rgba(96,165,250,.10);color:#dbeafe}

    .tableWrap{
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      overflow:auto;
      background:rgba(0,0,0,.12);
    }
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:1320px}
    thead th{
      position:sticky; top:0; z-index:2;
      background:rgba(12,18,32,.92);
      backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(255,255,255,.12);
      color:var(--muted);
      font-weight:900;
    }
    th,td{padding:12px 12px; text-align:right; font-size:13px; vertical-align:top}
    tbody tr:nth-child(odd) td{background:rgba(255,255,255,.03)}
    tbody tr:hover td{background:rgba(212,160,25,.06)}
    tbody td{border-bottom:1px solid rgba(255,255,255,.06)}
    .timeCell{direction:ltr;unicode-bidi:embed;text-align:left}
    .nameCell{font-weight:900}
    .sub{display:block;color:var(--muted);font-size:12px;margin-top:2px}
    td.actions{white-space:normal!important;width:400px}
    .actions{display:flex!important;flex-wrap:wrap!important;gap:8px!important;align-items:center!important;justify-content:flex-start!important}
    .actions .btn{padding:10px 12px!important;border-radius:12px!important;min-height:42px!important;line-height:1!important;font-weight:900!important;flex:1 1 120px!important;text-align:center!important}
    @media (max-width:700px){td.actions{width:auto!important}.actions .btn{flex:1 1 calc(50% - 8px)!important}}

    /* âœ… ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Pending) */
    tr.isPending td{
      background: linear-gradient(90deg, rgba(245,158,11,.10), rgba(212,160,25,.06)) !important;
      border-bottom-color: rgba(245,158,11,.20);
    }
    tr.isPending:hover td{
      background: linear-gradient(90deg, rgba(245,158,11,.14), rgba(212,160,25,.10)) !important;
    }

    /* Pagination */
    .pager{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      margin-top:10px;
      padding:10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      border-radius:16px;
    }
    .pager .left,.pager .right{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{
      padding:7px 10px;border:1px solid rgba(255,255,255,.14);border-radius:999px;color:var(--muted);font-size:12px
    }

    /* Top branches */
    .topBranches{
      display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px
    }
    @media (max-width:1100px){.topBranches{grid-template-columns:1fr 1fr}}
    @media (max-width:680px){.topBranches{grid-template-columns:1fr}}
    .rank{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      border-radius:16px;padding:12px;
      display:flex;align-items:center;justify-content:space-between;gap:10px
    }
    .rank b{font-size:16px}
    .rank .count{font-size:22px;font-weight:900}
    .bar{
      height:10px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;margin-top:8px
    }
    .bar > i{display:block;height:100%;width:0;background:rgba(212,160,25,.55)}

    /* Modal */
    .modalOverlay{position:fixed; inset:0; z-index:999; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; padding:14px;}
    .modalOverlay.show{display:flex}
    .modal{
      width:min(980px, 100%); max-height:92vh; overflow:auto;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(12,18,32,.92);
      backdrop-filter: blur(10px);
      border-radius:18px;
      box-shadow: 0 24px 80px rgba(0,0,0,.55);
    }
    .modalHead{
      position:sticky; top:0; z-index:2;
      background:rgba(12,18,32,.95);
      border-bottom:1px solid rgba(255,255,255,.10);
      padding:12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .modalBody{padding:12px}
    .xbtn{border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); color:var(--txt); border-radius:12px; padding:10px 12px; font-weight:900; cursor:pointer}
    .xbtn:hover{background:rgba(255,255,255,.10)}
    .hint{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.05);color:var(--muted);font-size:12px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:900px){.grid2{grid-template-columns:1fr}}
    .kv{border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.04); border-radius:14px; padding:10px}
    .kv b{display:block; font-size:12px; color:var(--muted); margin-bottom:4px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; white-space:pre-wrap}

    /* âœ… Ù†Ø®ÙÙŠ Ø§Ù„ØªÙˆØ¨ ÙˆÙ†ØªØ±Ùƒ nav.html */
    .top{display:none!important}

    /* âœ… padding Ù…Ø¹ Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± */
    @media (min-width:980px){
      .wrap{padding-right:330px;padding-left:14px}
      html[dir="ltr"] .wrap{padding-left:330px;padding-right:14px}
    }
    @media (max-width:979.98px){.wrap{padding-top:10px}}
    @media (min-width:980px){.wrap{padding-right:14px!important;padding-left:14px!important}}
    .wrap{padding-top:14px!important}
  </style>
</head>

<body>

  <!-- âœ… nav.html mount -->
  <div id="navMount"></div>

  <!-- âœ… load nav.html then nav.js -->
  <script>
    (function(){
      const mount = document.getElementById("navMount");
      if(!mount) return;

      function loadScript(src){
        return new Promise((resolve,reject)=>{
          const s = document.createElement("script");
          s.src = src;
          s.onload = resolve;
          s.onerror = reject;
          document.body.appendChild(s);
        });
      }

      fetch("./nav.html", { cache:"no-store" })
        .then(r=> r.text())
        .then(async (html)=>{
          mount.innerHTML = html;
          await loadScript("./nav.js?v=" + Date.now());

          if(window.__romaUserText){
            try{
              window.dispatchEvent(new CustomEvent("roma:user", { detail:{ text: window.__romaUserText } }));
            }catch{}
          }
          window.dispatchEvent(new CustomEvent("roma:nav:layout"));
        })
        .catch(()=>{});
    })();
  </script>

  <div class="wrap">

    <div class="card">
      <div class="split">
        <div style="min-width:240px">
          <h2 style="margin:0">Ø·Ù„Ø¨Ø§Øª ØªØµØ­ÙŠØ­ Ø§Ù„Ø­Ø¶ÙˆØ±</h2>
          <div class="mini"></div></div>
        </div>
        <div class="row" style="justify-content:flex-end">
          <button class="btn" id="btnReload">ØªØ­Ø¯ÙŠØ«</button>
          <button class="btn primary" id="btnExportExcel">ØªØµØ¯ÙŠØ± Excel</button>
          <button class="btn danger" id="btnOutTop">Ø®Ø±ÙˆØ¬</button>
        </div>
      </div>
      <div id="msgTop" class="msg"></div>
    </div>

    <div class="card">
      <div class="kpi">
        <div class="box"><div class="mini">ğŸŸ§ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</div><b id="kPending">0</b></div>
        <div class="box"><div class="mini">âœ… ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</div><b id="kApproved">0</b></div>
        <div class="box"><div class="mini">ğŸŸ© ØªÙ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</div><b id="kApplied">0</b></div>
        <div class="box"><div class="mini">ğŸŸ¥ Ù…Ø±ÙÙˆØ¶</div><b id="kRejected">0</b></div>
        <div class="box"><div class="mini">ğŸŸ¨ ØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹</div><b id="kRolledBack">0</b></div>
      </div>

      <!-- âœ… Top branches -->
      <div class="topBranches" id="topBranches"></div>

      <div class="toolbar" style="margin-top:10px">
        <div class="left">
          <input id="qSearch" class="search" type="text" placeholder="ğŸ” Ø¨Ø­Ø« (Ø§Ø³Ù…/Ø¥ÙŠÙ…ÙŠÙ„/Ù…Ù„Ø§Ø­Ø¸Ø©/ÙØ±Ø¹/Ø´ÙØª) ..." />

          <label class="mini">Ø§Ù„Ø­Ø§Ù„Ø©</label>
          <select id="fStatus">
            <option value="">â€” Ø§Ù„ÙƒÙ„ â€”</option>
            <option value="pending">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
            <option value="approved">ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</option>
            <option value="applied">ØªÙ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</option>
            <option value="rejected">Ù…Ø±ÙÙˆØ¶</option>
            <option value="rolled_back">ØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹</option>
          </select>

          <label class="mini">Ø§Ù„ÙØ±Ø¹</label>
          <select id="fBranch"></select>

          <label class="mini">Ù…Ù†</label>
          <input type="date" id="fFrom">

          <label class="mini">Ø¥Ù„Ù‰</label>
          <input type="date" id="fTo">

          <button class="btn warn" id="btnOnlyNew" title="ÙŠØ¹Ø±Ø¶ ÙÙ‚Ø· Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© (Pending)">ÙÙ‚Ø· Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</button>
          <button class="btn ghost" id="btnClear">Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
        </div>

        <div class="right">
          <span class="badge info">Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶: <b id="kShown" style="margin-inline-start:6px">0</b></span>
          <span class="badge">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <b id="kTotal" style="margin-inline-start:6px">0</b></span>
        </div>
      </div>

      <div style="margin-top:10px" class="hint">
 <b></b> <br>

      </div>

      <div class="tableWrap" style="margin-top:10px">
        <table>
          <thead>
            <tr>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
              <th>Ø§Ù„ÙØ±Ø¹</th>
              <th>Ø§Ù„Ø´ÙØª</th>
              <th class="timeCell">Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ø¥Ù†Ø´Ø§Ø¡</th>
              <th style="width:400px">Ø¥Ø¬Ø±Ø§Ø¡</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <!-- âœ… Pagination -->
      <div class="pager">
        <div class="left">
          <button class="btn" id="btnPrev">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
          <button class="btn" id="btnNext">Ø§Ù„ØªØ§Ù„ÙŠ</button>
          <span class="pill">ØµÙØ­Ø© <b id="pNow">1</b> Ù…Ù† <b id="pTotal">1</b></span>
          <span class="pill">Ø­Ø¬Ù… Ø§Ù„ØµÙØ­Ø©:
            <select id="pageSize" style="min-width:120px; padding:8px 10px; border-radius:999px">
              <option value="25">25</option>
              <option value="50" selected>50</option>
              <option value="100">100</option>
            </select>
          </span>
        </div>
        <div class="right">
          <span class="pill">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±Ø©: <b id="filteredCount">0</b></span>
        </div>
      </div>

      <div id="msgList" class="msg"></div>
    </div>

  </div>

  <!-- Modal Details -->
  <div class="modalOverlay" id="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mTitle">
      <div class="modalHead">
        <div>
          <b id="mTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</b>
          <div class="mini" id="mSub">â€”</div>
        </div>
        <div class="row" style="justify-content:flex-end">
          <button class="btn" id="mApply">ØªØ·Ø¨ÙŠÙ‚</button>
          <button class="btn primary" id="mApproveApply">Ù…ÙˆØ§ÙÙ‚Ø© + ØªØ·Ø¨ÙŠÙ‚</button>
          <button class="btn danger" id="mReject">Ø±ÙØ¶</button>
          <button class="btn warn" id="mRollback">ØªØ±Ø§Ø¬Ø¹ (Rollback)</button>
          <button class="xbtn" id="mClose">Ø¥ØºÙ„Ø§Ù‚ âœ•</button>
        </div>
      </div>
      <div class="modalBody">
        <div class="grid2">
          <div class="kv">
            <b>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</b>
            <div id="mInfo" class="mini"></div>
          </div>
          <div class="kv">
            <b>Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (Ø¬Ø¯ÙŠØ¯)</b>
            <div id="mWant" class="mini"></div>
          </div>
        </div>

        <div class="grid2" style="margin-top:10px">
          <div class="kv">
            <b>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ±Ø§Ø¬Ø¹ (Ù‚Ø¨Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚)</b>
            <div id="mRollbackData" class="mono">-</div>
          </div>
          <div class="kv">
            <b>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§Ù… (JSON)</b>
            <div id="mJson" class="mono">-</div>
          </div>
        </div>

        <div id="msgModal" class="msg"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc,
      collection, getDocs, query, where,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN88FY9CJU8T8cm5lLYjcI-I8VmD46o40",
      authDomain: "roma-schedule.firebaseapp.com",
      projectId: "roma-schedule",
      storageBucket: "roma-schedule.firebasestorage.app",
      messagingSenderId: "685810932602",
      appId: "1:685810932602:web:f1ec506ea6ff5e919d94c3",
      measurementId: "G-5FY5S5TZLJ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id)=>document.getElementById(id);
    const setMsg = (id, text, type="ok")=>{
      const el = $(id);
      if(!el) return;
      el.className = "msg " + (type==="bad"?"bad":"ok");
      el.textContent = text;
      el.style.display = "block";
    };
    const hideMsg = (id)=>{ const el=$(id); if(el) el.style.display="none"; };

    async function requireAdmin(user){
      const snap = await getDoc(doc(db,"employees",user.uid));
      return snap.exists() && snap.data()?.role === "admin";
    }

    function ymd(d){
      const dt = new Date(d);
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,"0");
      const da = String(dt.getDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    }

    function timeToMin(t){
      const s = String(t||"").trim();
      const m = /^(\d{1,2}):(\d{2})$/.exec(s);
      if(!m) return null;
      const hh = Math.max(0, Math.min(23, Number(m[1])));
      const mm = Math.max(0, Math.min(59, Number(m[2])));
      return hh*60+mm;
    }

    function safeId(s){
      return String(s||"").replace(/[^a-zA-Z0-9_-]/g,"_").slice(0,240);
    }

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"]/g, (c)=>({
        "&":"&amp;",
        "<":"&lt;",
        ">":"&gt;",
        "\"":"&quot;"
      }[c]));
    }

    function fmtTime(ms){
      if(!ms) return "-";
      try{
        return new Date(Number(ms)).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
      }catch{ return "-"; }
    }

    function fmtDateTime(ts){
      try{
        if(!ts) return "-";
        if(typeof ts === "number") return new Date(ts).toLocaleString("en-GB");
        if(ts?.seconds) return new Date(ts.seconds*1000).toLocaleString("en-GB");
        return "-";
      }catch{ return "-"; }
    }

    function normalizeEmailToPresetId(email){
      const e = String(email||"").trim().toLowerCase();
      if(!e) return null;
      return "preset:" + e.replace(/\./g,"(dot)");
    }

    function employeeKeyFromAny(employeeId, employeeEmail){
      const id = String(employeeId||"");
      if(id.startsWith("preset:")) return id;
      const byEmail = normalizeEmailToPresetId(employeeEmail);
      return byEmail || (id || "");
    }

    function buildAttendanceDocIdFromCorrection(c){
      const empKey = employeeKeyFromAny(c.employeeId, c.employeeEmail);
      const date = c.date || c.shiftDate || "";
      const branchId = c.branchId || "";
      const shiftName = c.shiftName || c.shift || "";
      const start = c.start || c.shiftStart || "";
      if(!empKey || !date || !branchId || !shiftName || !start) return null;
      return safeId(`${empKey}__${date}__${branchId}__${shiftName}__${start}`);
    }

    function calcMinutesLateAndWorked(startStr, checkInMs, checkOutMs){
      const startMin = timeToMin(startStr);
      let minutesLate = null;
      if(startMin!=null && checkInMs){
        const d = new Date(Number(checkInMs));
        const inMin = d.getHours()*60 + d.getMinutes();
        minutesLate = Math.max(0, inMin - startMin);
      }
      let workedMinutes = null;
      if(checkInMs && checkOutMs && Number(checkOutMs) > Number(checkInMs)){
        workedMinutes = Math.floor((Number(checkOutMs)-Number(checkInMs))/60000);
      }
      return { minutesLate, workedMinutes };
    }

    // ===== Modal =====
    const overlay = $("modalOverlay");
    let selectedId = null;

    function openModal(){
      overlay.classList.add("show");
      overlay.setAttribute("aria-hidden","false");
      document.body.style.overflow="hidden";
      hideMsg("msgModal");
    }
    function closeModal(){
      overlay.classList.remove("show");
      overlay.setAttribute("aria-hidden","true");
      document.body.style.overflow="";
      hideMsg("msgModal");
      selectedId=null;
    }
    overlay.addEventListener("click",(e)=>{ if(e.target===overlay) closeModal(); });
    document.addEventListener("keydown",(e)=>{ if(e.key==="Escape" && overlay.classList.contains("show")) closeModal(); });
    $("mClose").addEventListener("click", closeModal);

    function statusBadge(st){
      const s = String(st||"pending").toLowerCase();
      if(s==="approved") return `<span class="badge ok">âœ… ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</span>`;
      if(s==="applied") return `<span class="badge ok">ğŸŸ© ØªÙ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</span>`;
      if(s==="rolled_back") return `<span class="badge warn">ğŸŸ¨ ØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹</span>`;
      if(s==="rejected") return `<span class="badge bad">ğŸŸ¥ Ù…Ø±ÙÙˆØ¶</span>`;
      return `<span class="badge warn">ğŸŸ§ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>`;
    }

    function wantText(r){
      const parts = [
        (r.newCheckInAtLocal ? ("Ø¯Ø®ÙˆÙ„: " + fmtTime(r.newCheckInAtLocal)) : ""),
        (r.newCheckOutAtLocal ? ("Ø®Ø±ÙˆØ¬: " + fmtTime(r.newCheckOutAtLocal)) : "")
      ].filter(Boolean);
      return parts.join(" | ") || (r.note || "-");
    }

    async function loadBranchSelect(){
      const snap = await getDocs(collection(db,"branches"));
      const rows = [];
      snap.forEach(d=> rows.push({ id:d.id, ...(d.data()||{}) }));
      rows.sort((a,b)=> (a.name||a.id||"").localeCompare(b.name||b.id||""));

      const sel = $("fBranch");
      sel.innerHTML =
        `<option value="">â€” ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹ â€”</option>` +
        rows.map(b=> `<option value="${escapeHtml(b.id)}">${escapeHtml(b.name||b.id)} (${escapeHtml(b.id)})</option>`).join("");

      return rows;
    }

    // ===== Data cache =====
    let allRows = [];    // ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
    let viewRows = [];   // Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„Ø§ØªØ±
    let pageRows = [];   // ØµÙØ­Ø© Ø­Ø§Ù„ÙŠØ©

    let state = {
      page: 1,
      pageSize: Number($("pageSize").value || 50),
      onlyNew: false
    };

    function computeKPIs(rows){
      const c = { pending:0, approved:0, applied:0, rejected:0, rolled_back:0 };
      for(const r of rows){
        const s = String(r.status||"pending").toLowerCase();
        if(c[s] != null) c[s]++; else c.pending++;
      }
      $("kPending").textContent = c.pending;
      $("kApproved").textContent = c.approved;
      $("kApplied").textContent = c.applied;
      $("kRejected").textContent = c.rejected;
      $("kRolledBack").textContent = c.rolled_back;
    }

    // âœ… Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹ (Top branches)
    function renderTopBranches(rows){
      const map = new Map(); // branchKey -> {name,count,pending}
      for(const r of rows){
        const key = String(r.branchId||"") || "â€”";
        const name = String(r.branchName||r.branchId||"â€”");
        const obj = map.get(key) || { key, name, count:0, pending:0 };
        obj.count++;
        if(String(r.status||"pending").toLowerCase()==="pending") obj.pending++;
        map.set(key, obj);
      }
      const list = Array.from(map.values()).sort((a,b)=> b.count - a.count);
      const top = list.slice(0,6);
      const max = top[0]?.count || 1;

      const mount = $("topBranches");
      if(!mount) return;
      if(!top.length){
        mount.innerHTML = "";
        return;
      }

      mount.innerHTML = top.map((x, idx)=>{
        const w = Math.round((x.count/max)*100);
        return `
          <div class="rank">
            <div style="flex:1">
              <div class="mini">#${idx+1} â€” ${escapeHtml(x.name)}</div>
              <b>${escapeHtml(x.key)}</b>
              <div class="bar"><i style="width:${w}%"></i></div>
              <div class="mini" style="margin-top:8px">
                Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <b>${x.count}</b> â€¢ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©: <b>${x.pending}</b>
              </div>
            </div>
            <div style="text-align:center;min-width:90px">
              <div class="mini">Ø¹Ø¯Ø¯</div>
              <div class="count">${x.count}</div>
            </div>
          </div>
        `;
      }).join("");
    }

    function applyFilters(){
      const q = String($("qSearch").value||"").trim().toLowerCase();
      const stUI = String($("fStatus").value||"").trim().toLowerCase();
      const br = String($("fBranch").value||"").trim();
      const from = $("fFrom").value || "";
      const to = $("fTo").value || "";

      // Ù…Ù„Ø§Ø­Ø¸Ø©: fStatus ÙŠØ¹Ø±Ø¶ Ø¹Ø±Ø¨ÙŠØŒ Ù„ÙƒÙ† value Ø¹Ù†Ø¯Ù†Ø§ Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ Ø¨Ø§Ù„ÙƒÙˆØ¯
      // Ù†Ø­Ù† Ù†Ø®Ø²Ù† Ø§Ù„Ù‚ÙŠÙ…: pending/approved/applied/rejected/rolled_back
      const st = (()=>{
        // Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ø®ØªØ§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŒ Ø§Ù„Ù‚ÙŠÙ…Ø© Ù‡ÙŠ Ø§Ù„Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ Ø£Ø³Ø§Ø³Ø§Ù‹
        // Ø¨Ø³ Ù„Ùˆ ØµØ§Ø± ØªØºÙŠØ± Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹ØŒ Ù†Ø®Ù„ÙŠÙ‡Ø§ safe
        const v = stUI;
        if(["pending","approved","applied","rejected","rolled_back",""].includes(v)) return v;
        return "";
      })();

      let rows = [...allRows];

      if(state.onlyNew){
        rows = rows.filter(r=> String(r.status||"pending").toLowerCase() === "pending");
      }
      if(st){
        rows = rows.filter(r=> String(r.status||"pending").toLowerCase() === st);
      }
      if(br){
        rows = rows.filter(r=> String(r.branchId||"") === br);
      }
      if(from){
        rows = rows.filter(r=> String(r.date||"") >= from);
      }
      if(to){
        rows = rows.filter(r=> String(r.date||"") <= to);
      }
      if(q){
        rows = rows.filter(r=>{
          const blob = [
            r.employeeName, r.employeeEmail, r.employeeId,
            r.branchName, r.branchId,
            r.shiftName, r.start, r.end,
            r.note,
            wantText(r)
          ].join(" ").toLowerCase();
          return blob.includes(q);
        });
      }

      viewRows = rows;

      $("kShown").textContent = String(viewRows.length);
      $("filteredCount").textContent = String(viewRows.length);

      // âœ… Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙÙ„Ø§ØªØ± Ø±Ø¬Ù‘Ø¹ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ø£ÙˆÙ„Ù‰
      state.page = 1;
      paginateAndRender();
    }

    function paginateAndRender(){
      const total = viewRows.length;
      const size = state.pageSize;
      const pages = Math.max(1, Math.ceil(total / size));
      if(state.page > pages) state.page = pages;
      if(state.page < 1) state.page = 1;

      $("pNow").textContent = String(state.page);
      $("pTotal").textContent = String(pages);

      $("btnPrev").disabled = (state.page <= 1);
      $("btnNext").disabled = (state.page >= pages);

      const start = (state.page - 1) * size;
      const end = start + size;
      pageRows = viewRows.slice(start, end);

      renderTable();
      renderTopBranches(viewRows); // âœ… top branches Ø­Ø³Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„Ø§ØªØ±
    }

    function renderTable(){
      const tb = $("tbody");
      tb.innerHTML = "";

      for(const r of pageRows){
        const name = r.employeeName || r.employeeEmail || r.employeeId || "-";
        const emailLine = r.employeeEmail ? `<span class="sub">${escapeHtml(r.employeeEmail)}</span>` : "";
        const shiftLine = (r.start && r.end) ? (r.start + " - " + r.end) : (r.start || "");
        const created = fmtDateTime(r.createdAt);

        const st = String(r.status||"pending").toLowerCase();
        const canRollback = !!r.rollbackData && (st==="approved" || st==="applied");
        const canAct = (st!=="rejected" && st!=="rolled_back");

        const tr = document.createElement("tr");
        if(st==="pending") tr.classList.add("isPending"); // âœ… highlight

        tr.innerHTML = `
          <td>${escapeHtml(r.date||"-")}</td>
          <td class="nameCell">
            ${escapeHtml(name)}
            ${emailLine}
          </td>
          <td>${escapeHtml(r.branchName||r.branchId||"-")}</td>
          <td>
            ${escapeHtml(r.shiftName||"-")}
            <span class="badge">${escapeHtml(shiftLine||"")}</span>
          </td>
          <td class="timeCell">${escapeHtml(wantText(r))}</td>
          <td>${statusBadge(r.status)}</td>
          <td><span class="badge info">${escapeHtml(created)}</span></td>
          <td class="actions">
            <button class="btn" data-view="${escapeHtml(r.__id)}">ØªÙØ§ØµÙŠÙ„</button>
            <button class="btn" data-apply="${escapeHtml(r.__id)}" ${canAct ? "" : "disabled"}>ØªØ·Ø¨ÙŠÙ‚</button>
            <button class="btn primary" data-approveapply="${escapeHtml(r.__id)}" ${canAct ? "" : "disabled"}>Ù…ÙˆØ§ÙÙ‚Ø©</button>
            <button class="btn danger" data-reject="${escapeHtml(r.__id)}" ${canAct ? "" : "disabled"}>Ø±ÙØ¶</button>
            <button class="btn warn" data-rollback="${escapeHtml(r.__id)}" ${canRollback ? "" : "disabled"}>ØªØ±Ø§Ø¬Ø¹</button>
          </td>
        `;
        tb.appendChild(tr);
      }

      tb.querySelectorAll("[data-view]").forEach(b=>{
        b.addEventListener("click", ()=> openDetails(b.getAttribute("data-view")));
      });
      tb.querySelectorAll("[data-apply]").forEach(b=>{
        b.addEventListener("click", ()=> runAction(b.getAttribute("data-apply"), "apply"));
      });
      tb.querySelectorAll("[data-approveapply]").forEach(b=>{
        b.addEventListener("click", ()=> runAction(b.getAttribute("data-approveapply"), "approve_apply"));
      });
      tb.querySelectorAll("[data-reject]").forEach(b=>{
        b.addEventListener("click", ()=> runReject(b.getAttribute("data-reject")));
      });
      tb.querySelectorAll("[data-rollback]").forEach(b=>{
        b.addEventListener("click", ()=> runAction(b.getAttribute("data-rollback"), "rollback"));
      });
    }

    async function loadCorrections(){
      const snap = await getDocs(collection(db,"attendance_corrections"));
      const rows=[];
      snap.forEach(d=>{
        const x=d.data()||{};
        rows.push({ __id:d.id, ...x });
      });

      rows.sort((a,b)=> (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));

      allRows = rows;
      $("kTotal").textContent = String(allRows.length);
      computeKPIs(allRows);

      applyFilters();
    }

    async function applyCorrection(correctionId, mode){
      const cRef = doc(db,"attendance_corrections", correctionId);
      const cSnap = await getDoc(cRef);
      if(!cSnap.exists()) throw new Error("Ø·Ù„Ø¨ Ø§Ù„ØªØµØ­ÙŠØ­ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");
      const c = { __id: correctionId, ...(cSnap.data()||{}) };

      const attId = buildAttendanceDocIdFromCorrection(c);
      if(!attId) throw new Error("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ù†Ø§Ù‚ØµØ© (date/branchId/shiftName/start + employeeId/email).");

      const aRef = doc(db,"attendance", attId);
      const aSnap = await getDoc(aRef);

      if(mode === "rollback"){
        const rb = c.rollbackData || null;
        if(!rb) throw new Error("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ±Ø§Ø¬Ø¹ (Ù„Ù… ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø·Ù„Ø¨ Ø³Ø§Ø¨Ù‚Ø§Ù‹).");
        await setDoc(aRef, { ...rb, updatedAt: serverTimestamp() }, { merge:true });

        await updateDoc(cRef, {
          status: "rolled_back",
          rolledBackAt: serverTimestamp(),
          rolledBackBy: auth.currentUser?.uid || null
        });
        return "ØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹ (Rollback) âœ…";
      }

      const newIn  = c.newCheckInAtLocal ?? c.newCheckIn ?? c.checkInAtLocalNew ?? null;
      const newOut = c.newCheckOutAtLocal ?? c.newCheckOut ?? c.checkOutAtLocalNew ?? null;

      if(!newIn && !newOut){
        throw new Error("Ø§Ù„Ø·Ù„Ø¨ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ ÙˆÙ‚Øª Ø¯Ø®ÙˆÙ„/Ø®Ø±ÙˆØ¬ Ø¬Ø¯ÙŠØ¯.");
      }

      const old = aSnap.exists() ? (aSnap.data()||{}) : {};
      const alreadySnap = !!c.rollbackData;

      if(!alreadySnap){
        await updateDoc(cRef, {
          rollbackData: {
            checkInAtLocal: old.checkInAtLocal ?? null,
            checkOutAtLocal: old.checkOutAtLocal ?? null,
            minutesLate: old.minutesLate ?? null,
            workedMinutes: old.workedMinutes ?? null,
            status: old.status ?? null,
            note: old.note ?? null
          }
        });
      }

      const inMs  = (newIn!=null ? Number(newIn) : (old.checkInAtLocal ?? null));
      const outMs = (newOut!=null ? Number(newOut) : (old.checkOutAtLocal ?? null));

      const { minutesLate, workedMinutes } = calcMinutesLateAndWorked(c.start || old.start || "", inMs, outMs);
      const status = (outMs ? "completed" : (inMs ? "present" : (old.status || "pending")));

      await setDoc(aRef, {
        employeeId: employeeKeyFromAny(c.employeeId, c.employeeEmail),
        employeeName: c.employeeName || old.employeeName || "",
        employeeEmail: c.employeeEmail || old.employeeEmail || "",
        date: c.date || old.date || "",
        branchId: c.branchId || old.branchId || "",
        branchName: c.branchName || old.branchName || "",
        shiftName: c.shiftName || old.shiftName || "",
        start: c.start || old.start || "",
        end: c.end || old.end || "",
        checkInAtLocal:  inMs,
        checkOutAtLocal: outMs,
        minutesLate,
        workedMinutes,
        status,
        note: c.note || old.note || "",
        updatedAt: serverTimestamp()
      }, { merge:true });

      const patch = {
        appliedAt: serverTimestamp(),
        appliedBy: auth.currentUser?.uid || null,
        status: (mode==="approve_apply") ? "approved" : "applied"
      };
      await updateDoc(cRef, patch);

      return (mode==="approve_apply") ? "ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© + Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ âœ…" : "ØªÙ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ âœ…";
    }

    async function runAction(id, mode){
      try{
        hideMsg("msgTop"); hideMsg("msgList"); hideMsg("msgModal");
        if(mode==="rollback"){
          const ok = confirm("Ø³ÙŠØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹ ÙˆØ¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø³Ø¬Ù„ ÙƒÙ…Ø§ ÙƒØ§Ù† Ù‚Ø¨Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚. Ù…ØªØ§Ø¨Ø¹Ø©ØŸ");
          if(!ok) return;
        }
        const msg = await applyCorrection(id, mode);
        setMsg("msgTop", msg, "ok");
        await loadCorrections();
        if(overlay.classList.contains("show") && selectedId===id){
          await openDetails(id, true);
        }
      }catch(e){
        setMsg(overlay.classList.contains("show") ? "msgModal" : "msgTop", e?.message || "Ø®Ø·Ø£", "bad");
      }
    }

    async function runReject(id){
      try{
        hideMsg("msgTop"); hideMsg("msgList"); hideMsg("msgModal");
        const ok = confirm("Ø±ÙØ¶ Ø·Ù„Ø¨ Ø§Ù„ØªØµØ­ÙŠØ­ØŸ");
        if(!ok) return;
        await updateDoc(doc(db,"attendance_corrections", id), {
          status:"rejected",
          updatedAt: serverTimestamp(),
          rejectedAt: serverTimestamp(),
          rejectedBy: auth.currentUser?.uid || null
        });
        setMsg("msgTop","ØªÙ… Ø§Ù„Ø±ÙØ¶ âœ…","ok");
        await loadCorrections();
        if(overlay.classList.contains("show") && selectedId===id){
          await openDetails(id, true);
        }
      }catch(e){
        setMsg(overlay.classList.contains("show") ? "msgModal" : "msgTop", e?.message || "Ø®Ø·Ø£", "bad");
      }
    }

    async function openDetails(id, keepOpen=false){
      const r = allRows.find(x=> x.__id === id);
      if(!r) return;

      selectedId = id;

      const st = String(r.status||"pending").toLowerCase();
      const canRollback = !!r.rollbackData && (st==="approved" || st==="applied");
      const canAct = (st!=="rejected" && st!=="rolled_back");

      $("mTitle").textContent = "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨";
      $("mSub").textContent = `${r.date||"-"} â€¢ ${r.branchName||r.branchId||"-"} â€¢ ${r.shiftName||"-"} (${r.start||""}${r.end?(" - "+r.end):""})`;

      const infoHtml = `
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <span class="badge info">Ø§Ù„Ù…Ø¹Ø±Ù: ${escapeHtml(r.__id)}</span>
          ${statusBadge(r.status)}
          <span class="badge">ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${escapeHtml(fmtDateTime(r.createdAt))}</span>
          ${r.appliedAt ? `<span class="badge ok">ØªÙ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚: ${escapeHtml(fmtDateTime(r.appliedAt))}</span>` : ``}
          ${r.rolledBackAt ? `<span class="badge warn">ØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹: ${escapeHtml(fmtDateTime(r.rolledBackAt))}</span>` : ``}
        </div>
        <div style="margin-top:8px">
          <b>Ø§Ù„Ù…ÙˆØ¸Ù:</b> ${escapeHtml(r.employeeName||r.employeeEmail||r.employeeId||"-")}
          ${r.employeeEmail ? `<div class="mini">${escapeHtml(r.employeeEmail)}</div>` : ``}
          ${r.note ? `<div class="mini" style="margin-top:6px"><b>Ù…Ù„Ø§Ø­Ø¸Ø©:</b> ${escapeHtml(r.note)}</div>` : ``}
        </div>
      `;
      $("mInfo").innerHTML = infoHtml;

      $("mWant").innerHTML = `
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <span class="badge">${escapeHtml(wantText(r))}</span>
          ${r.newCheckInAtLocal ? `<span class="badge ok">Ø¯Ø®ÙˆÙ„ Ø¬Ø¯ÙŠØ¯: ${escapeHtml(fmtTime(r.newCheckInAtLocal))}</span>` : ``}
          ${r.newCheckOutAtLocal ? `<span class="badge ok">Ø®Ø±ÙˆØ¬ Ø¬Ø¯ÙŠØ¯: ${escapeHtml(fmtTime(r.newCheckOutAtLocal))}</span>` : ``}
        </div>
      `;

      $("mRollbackData").textContent = r.rollbackData ? JSON.stringify(r.rollbackData, null, 2) : "-";
      $("mJson").textContent = JSON.stringify(r, null, 2);

      $("mApply").disabled = !canAct;
      $("mApproveApply").disabled = !canAct;
      $("mReject").disabled = !canAct;
      $("mRollback").disabled = !canRollback;

      if(!keepOpen) openModal();
    }

    // ===== Export Excel (filtered rows) =====
    async function exportExcel(){
      const rows = viewRows || [];
      if(!rows.length) return setMsg("msgTop","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±.","bad");
      const XLSX = window.XLSX;
      if(!XLSX) return setMsg("msgTop","Ù…ÙƒØªØ¨Ø© Excel ØºÙŠØ± Ù…Ø­Ù…Ù‘Ù„Ø©.","bad");

      const headers = [
        "id","Ø§Ù„Ø­Ø§Ù„Ø©","Ø§Ù„ØªØ§Ø±ÙŠØ®","Ø§Ù„Ù…ÙˆØ¸Ù","Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„","branchId","branchName","Ø§Ù„Ø´ÙØª","start","end",
        "Ø¯Ø®ÙˆÙ„_Ø¬Ø¯ÙŠØ¯","Ø®Ø±ÙˆØ¬_Ø¬Ø¯ÙŠØ¯","Ù…Ù„Ø§Ø­Ø¸Ø©","createdAt","appliedAt","rolledBackAt","hasRollbackData"
      ];

      const data = rows.map(r=>[
        r.__id || "",
        r.status || "",
        r.date || "",
        r.employeeName || "",
        r.employeeEmail || "",
        r.branchId || "",
        r.branchName || "",
        r.shiftName || "",
        r.start || "",
        r.end || "",
        r.newCheckInAtLocal ?? "",
        r.newCheckOutAtLocal ?? "",
        r.note || "",
        fmtDateTime(r.createdAt),
        fmtDateTime(r.appliedAt),
        fmtDateTime(r.rolledBackAt),
        r.rollbackData ? "yes" : "no"
      ]);

      const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);

      for(let c=0; c<headers.length; c++){
        const addr = XLSX.utils.encode_cell({ r:0, c });
        if(ws[addr]) ws[addr].s = {
          font: { bold:true, color:{ rgb:"FFFFFFFF" } },
          fill: { patternType:"solid", fgColor:{ rgb:"FF111827" } },
          alignment: { horizontal:"center", vertical:"center" },
          border: {
            top:{style:"thin",color:{rgb:"FF374151"}},
            bottom:{style:"thin",color:{rgb:"FF374151"}},
            left:{style:"thin",color:{rgb:"FF374151"}},
            right:{style:"thin",color:{rgb:"FF374151"}},
          }
        };
      }

      ws["!cols"] = headers.map(()=>({ wch: 18 }));
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Corrections");

      const stamp = ymd(new Date());
      XLSX.writeFile(wb, `Ø·Ù„Ø¨Ø§Øª_ØªØµØ­ÙŠØ­_Ø§Ù„Ø­Ø¶ÙˆØ±_${stamp}.xlsx`);
      setMsg("msgTop","ØªÙ… ØªØµØ¯ÙŠØ± Excel âœ…","ok");
    }

    // ===== Logout binding =====
    function bindLogoutIfExists(){
      const btn = document.getElementById("btnOut");
      const btn2 = document.getElementById("btnOutTop");
      const handler = async ()=>{
        await signOut(auth);
        location.href="./login.html";
      };
      [btn, btn2].forEach(b=>{
        if(b && !b.__bound){
          b.__bound = true;
          b.addEventListener("click", handler);
        }
      });
    }
    bindLogoutIfExists();
    window.addEventListener("roma:nav:layout", bindLogoutIfExists);

    // ===== Events =====
    const debounce = (fn, ms=250)=>{
      let t=null;
      return (...args)=>{
        clearTimeout(t);
        t=setTimeout(()=>fn(...args), ms);
      };
    };

    $("qSearch").addEventListener("input", debounce(applyFilters, 250));
    $("fStatus").addEventListener("change", applyFilters);
    $("fBranch").addEventListener("change", applyFilters);
    $("fFrom").addEventListener("change", applyFilters);
    $("fTo").addEventListener("change", applyFilters);

    $("pageSize").addEventListener("change", ()=>{
      state.pageSize = Number($("pageSize").value || 50);
      state.page = 1;
      paginateAndRender();
    });

    $("btnPrev").addEventListener("click", ()=>{
      state.page = Math.max(1, state.page - 1);
      paginateAndRender();
    });
    $("btnNext").addEventListener("click", ()=>{
      const pages = Math.max(1, Math.ceil(viewRows.length / state.pageSize));
      state.page = Math.min(pages, state.page + 1);
      paginateAndRender();
    });

    $("btnOnlyNew").addEventListener("click", ()=>{
      state.onlyNew = !state.onlyNew;
      $("btnOnlyNew").classList.toggle("primary", state.onlyNew);
      $("btnOnlyNew").textContent = state.onlyNew ? "Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„" : "ÙÙ‚Ø· Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©";
      applyFilters();
    });

    $("btnClear").addEventListener("click", ()=>{
      $("qSearch").value = "";
      $("fStatus").value = "";
      $("fBranch").value = "";
      $("fFrom").value = "";
      $("fTo").value = "";
      state.onlyNew = false;
      $("btnOnlyNew").classList.remove("primary");
      $("btnOnlyNew").textContent = "ÙÙ‚Ø· Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©";
      applyFilters();
    });

    $("btnReload").addEventListener("click", async ()=>{
      try{
        hideMsg("msgTop");
        await loadCorrections();
        setMsg("msgTop","ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« âœ…","ok");
      }catch(e){
        setMsg("msgTop", e?.message || "Ø®Ø·Ø£", "bad");
      }
    });

    $("btnExportExcel").addEventListener("click", exportExcel);

    $("mApply").addEventListener("click", ()=> runAction(selectedId, "apply"));
    $("mApproveApply").addEventListener("click", ()=> runAction(selectedId, "approve_apply"));
    $("mReject").addEventListener("click", ()=> runReject(selectedId));
    $("mRollback").addEventListener("click", ()=> runAction(selectedId, "rollback"));

    // ===== Auth =====
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href="./login.html"; return; }

      window.__romaUserText = (user.email || user.uid);
      try{
        window.dispatchEvent(new CustomEvent("roma:user", { detail:{ text: window.__romaUserText } }));
      }catch{}

      const ok = await requireAdmin(user);
      if(!ok){
        const admins = await getDocs(query(collection(db,"employees"), where("role","==","admin")));
        if(admins.size>0){ location.href="./staff.html"; return; }
        setMsg("msgTop","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Admin Ø¨Ø¹Ø¯. Ø¹ÙŠÙ‘Ù† Ø£ÙˆÙ„ Ø£Ø¯Ù…Ù† Ù…Ù† ØµÙØ­Ø© Dashboard (Ø§Ø¬Ø¹Ù„ Admin).","bad");
      }

      await loadBranchSelect();

      // Default: Ø¢Ø®Ø± 14 ÙŠÙˆÙ…
      const to = new Date();
      const from = new Date();
      from.setDate(from.getDate()-14);
      $("fTo").value = ymd(to);
      $("fFrom").value = ymd(from);

      await loadCorrections();
    });
  </script>
</body>
</html>
