<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Roma Schedule - Ø·Ù„Ø¨Ø§Øª ØªØµØ­ÙŠØ­ Ø§Ù„Ø­Ø¶ÙˆØ±</title>
  <link rel="icon" href="./assets/logo.webp">
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.04);
      --line:rgba(255,255,255,.14);
      --line2:rgba(255,255,255,.10);
      --txt:#e5e7eb;
      --muted:#9ca3af;
      --accent:#d4a019;
      --shadow:0 18px 60px rgba(0,0,0,.35);
      --ok:#16a34a;
      --bad:#ef4444;
      --warn:#f59e0b;
      --info:#60a5fa;
      --ease:cubic-bezier(.22,.61,.36,1);
    }

    *{box-sizing:border-box}
    body{
      margin:0;min-height:100vh;
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(212,160,25,.16), transparent 55%),
        radial-gradient(900px 500px at 90% 20%, rgba(59,130,246,.14), transparent 55%),
        var(--bg);
      color:var(--txt);
      font-family:system-ui,"Noto Sans Arabic",Tahoma,Arial,sans-serif
    }

    a.btn,button.btn{
      cursor:pointer;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--txt);
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      text-decoration:none;
      transition: transform .12s var(--ease), background .12s var(--ease), border-color .12s var(--ease);
      user-select:none;
      min-height:42px;
      white-space:nowrap;
    }
    .btn:hover{background:rgba(255,255,255,.10); transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.primary{border-color:rgba(212,160,25,.45);background:rgba(212,160,25,.14)}
    .btn.primary:hover{background:rgba(212,160,25,.22)}
    .btn.danger{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.12)}
    .btn.danger:hover{background:rgba(239,68,68,.18)}
    .btn.warn{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.10)}
    .btn.warn:hover{background:rgba(245,158,11,.16)}
    .btn:disabled{opacity:.45;cursor:not-allowed;transform:none!important}

    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px}

    .wrap{
      max-width:1600px;
      margin:0 auto;
      padding:14px;
      padding-top:14px!important;
    }

    .card{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      border-radius:18px;
      padding:12px;
      box-shadow:var(--shadow);
      margin-bottom:14px;
    }

    h2{margin:0 0 10px;font-size:18px}
    .mini{color:var(--muted);font-size:12px;line-height:1.7}

    .msg{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);display:none;white-space:pre-line}
    .msg.ok{display:block;border-color:rgba(22,163,74,.35);background:rgba(22,163,74,.12)}
    .msg.bad{display:block;border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.12)}

    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media (max-width:900px){.kpi{grid-template-columns:1fr 1fr}}
    .box{
      border:1px solid var(--line2);
      background:rgba(255,255,255,.05);
      border-radius:16px;
      padding:12px;
      min-width:0;
    }
    .box b{font-size:22px}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .split{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}

    .toolbar{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      padding:10px;border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);border-radius:16px;
      margin-top:8px;
      min-width:0;
    }
    .toolbar .left,.toolbar .right{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    input,select,textarea{
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      color:var(--txt);
      padding:11px 12px;
      border-radius:12px;
      outline:none;
      min-height:42px;
      transition:.15s var(--ease);
      min-width:0;
      max-width:100%;
    }
    textarea{min-height:90px; resize:vertical}
    input:focus,select:focus,textarea:focus{border-color:rgba(212,160,25,.70);box-shadow:0 0 0 4px rgba(212,160,25,.14)}
    select{min-width:220px}

    input[type="time"]{
      direction:ltr;
      unicode-bidi:embed;
      text-align:left;
      min-width:180px;
    }

    .tableWrap{
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      overflow-x:auto;
      overflow-y:hidden;
      background:rgba(0,0,0,.12);
      max-width:100%;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width:100%;
    }
    thead th{
      position:sticky;
      top:0;
      z-index:2;
      background:rgba(12,18,32,.92);
      backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(255,255,255,.12);
      color:var(--muted);
      font-weight:900;
      text-align:right;
    }
    th,td{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      text-align:right;
      font-size:13px;
      vertical-align:middle;
      white-space:nowrap;
    }
    tbody tr:nth-child(odd) td{background:rgba(255,255,255,.03)}
    tbody tr:hover td{background:rgba(212,160,25,.06)}
    .timeCell{direction:ltr;unicode-bidi:embed;text-align:left}

    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:7px 10px;border:1px solid var(--line);
      border-radius:999px;color:var(--muted);font-size:12px;white-space:nowrap;
      background:rgba(255,255,255,.03);
    }
    .badge.ok{border-color:rgba(22,163,74,.35);background:rgba(22,163,74,.12);color:#d1fae5}
    .badge.bad{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.12);color:#fee2e2}
    .badge.warn{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.10);color:#ffedd5}
    .badge.info{border-color:rgba(96,165,250,.35);background:rgba(96,165,250,.10);color:#dbeafe}

    td.actions{white-space:normal!important; width:170px}
    .actions{display:flex!important;flex-wrap:wrap!important;gap:8px!important;align-items:center!important;justify-content:flex-start!important}
    .actions .btn{flex:1 1 160px!important}

    tr.isPending td{
      background: linear-gradient(90deg, rgba(245,158,11,.12), rgba(212,160,25,.06)) !important;
      border-bottom-color: rgba(245,158,11,.20);
    }

    .top{display:none!important}
    @media (min-width:980px){
      .wrap{padding-right:330px;padding-left:14px}
      html[dir="ltr"] .wrap{padding-left:330px;padding-right:14px}
    }
    @media (max-width:979.98px){.wrap{padding-top:10px}}
    @media (min-width:980px){.wrap{padding-right:14px!important;padding-left:14px!important}}

    /* ===== Modal ===== */
    .modalBackdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:9999;
    }
    .modal{
      width:min(920px, 100%);
      border:1px solid rgba(255,255,255,.14);
      background:rgba(12,18,32,.92);
      backdrop-filter: blur(12px);
      border-radius:18px;
      box-shadow:0 26px 90px rgba(0,0,0,.55);
      overflow:hidden;
      max-height:90vh;
      overflow-y:auto;
    }
    .modalHead{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      position:sticky; top:0; z-index:5;
      background:rgba(12,18,32,.92);
      backdrop-filter: blur(12px);
    }
    .modalBody{padding:12px}
    .modalGrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    @media (max-width:800px){ .modalGrid{grid-template-columns:1fr} }
    .field label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    .modalFoot{
      padding:12px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
      position:sticky; bottom:0; z-index:5;
      background:rgba(12,18,32,.92);
      backdrop-filter: blur(12px);
    }
    .hint{font-size:12px;color:var(--muted)}
    .chip{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 10px;border:1px solid rgba(255,255,255,.12);
      border-radius:999px;background:rgba(255,255,255,.04); color:var(--txt);
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .chip b{color:var(--txt)}
    .chipsLine{display:flex;flex-wrap:wrap;gap:8px}

    @media (max-width:768px){
      th,td{font-size:12px;padding:8px}
      .actions .btn{flex:1 1 100%!important}
      select{min-width:160px}
      input[type="time"]{min-width:150px}
    }

    /* âœ… Fix dropdown options visibility */
    select{
      background: rgba(0,0,0,.45) !important;
      color: var(--txt) !important;
      border-color: var(--line) !important;
      appearance: none;
    }
    select:focus{ background: rgba(0,0,0,.55) !important; }
    select option, select optgroup{
      background-color: #0b1220 !important;
      color: #e5e7eb !important;
    }
    select option:checked{
      background-color: rgba(212,160,25,.25) !important;
      color: #fff !important;
    }
    select option:disabled{ color: rgba(229,231,235,.45) !important; }
  </style>
</head>

<body>

  <div id="navMount"></div>

  <script>
    (function(){
      const mount = document.getElementById("navMount");
      if(!mount) return;

      function loadScript(src){
        return new Promise((resolve,reject)=>{
          const s = document.createElement("script");
          s.src = src;
          s.onload = resolve;
          s.onerror = reject;
          document.body.appendChild(s);
        });
      }

      fetch("./nav.html", { cache:"no-store" })
        .then(r=> r.text())
        .then(async (html)=>{
          mount.innerHTML = html;
          await loadScript("./nav.js?v=" + Date.now());
          if(window.__romaUserText){
            try{ window.dispatchEvent(new CustomEvent("roma:user", { detail:{ text: window.__romaUserText } })); }catch{}
          }
          window.dispatchEvent(new CustomEvent("roma:nav:layout"));
        })
        .catch(()=>{});
    })();
  </script>

  <div class="wrap">

    <div class="card">
      <div class="split">
        <div>
          <h2 style="margin:0 0 6px">Ø·Ù„Ø¨Ø§Øª ØªØµØ­ÙŠØ­ Ø§Ù„Ø­Ø¶ÙˆØ±</h2>
          <div class="mini"></div>
        </div>
        <div class="row" style="justify-content:flex-end">
          <button class="btn" id="btnReloadFix">ØªØ­Ø¯ÙŠØ«</button>
          <button class="btn danger" id="btnOut">Ø®Ø±ÙˆØ¬</button>
        </div>
      </div>

      <div id="msgFixTop" class="msg"></div>
    </div>

    <div class="card">

      <div class="toolbar">
        <div class="left">
          <span class="chip">
            <input id="onlyPending" type="checkbox" style="min-height:auto; width:18px; height:18px; margin:0">
            <label for="onlyPending" style="cursor:pointer">Ø¹Ø±Ø¶ ÙÙ‚Ø· Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Pending)</label>
          </span>

          <label class="mini">Ø­Ø¬Ù… Ø§Ù„ØµÙØ­Ø©</label>
          <select id="pageSizeSel">
            <option value="15">15</option>
            <option value="25" selected>25</option>
            <option value="50">50</option>
          </select>

          <span class="badge info" id="pageInfo">ØµÙØ­Ø©: 1</span>
        </div>

        <div class="right">
          <button class="btn" id="btnPrev">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
          <button class="btn primary" id="btnNext">Ø§Ù„ØªØ§Ù„ÙŠ</button>
        </div>
      </div>

      <div class="kpi" style="margin-top:10px">
        <div class="box"><div class="mini">Ø¶Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©: Pending</div><b id="kPagePending">0</b></div>
        <div class="box"><div class="mini">Ø¶Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©: Approved</div><b id="kPageApproved">0</b></div>
        <div class="box"><div class="mini">Ø¶Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©: Rejected</div><b id="kPageRejected">0</b></div>
        <div class="box"><div class="mini">Top ÙØ±Ø¹ (Ø¢Ø®Ø± 500)</div><b id="kTopBranch">-</b></div>
      </div>

      <div id="branchesStats" class="mini" style="margin-top:10px"></div>
      <div id="msgFix" class="msg"></div>

      <div class="tableWrap" style="margin-top:12px">
        <table>
          <thead>
            <tr>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
              <th>Ø§Ù„ÙØ±Ø¹</th>
              <th class="timeCell">Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th style="width:170px">Ø¥Ø¬Ø±Ø§Ø¡</th>
            </tr>
          </thead>
          <tbody id="fixTbody"></tbody>
        </table>
      </div>

    </div>
  </div>

  <!-- Modal -->
  <div class="modalBackdrop" id="editModal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
      <div class="modalHead">
        <div>
          <b id="editTitle">ØªØ¹Ø¯ÙŠÙ„ Ø·Ù„Ø¨ ØªØµØ­ÙŠØ­ Ø§Ù„Ø­Ø¶ÙˆØ±</b>
          <div class="hint" id="editSub">â€”</div>
        </div>
        <button class="btn" id="btnCloseModal">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>

      <div class="modalBody">
        <div class="chipsLine" id="mSummary" style="margin-bottom:12px"></div>

        <div class="modalGrid">
          <div class="field">
            <label>Ù‚Ø±Ø§Ø± Ø§Ù„Ø£Ø¯Ù…Ù†: Ø§Ù„Ø­Ø§Ù„Ø©</label>
            <select id="mStatus">
              <option value="pending">Pending (Ø¬Ø¯ÙŠØ¯)</option>
              <option value="approved">Approved (Ù…ÙˆØ§ÙÙ‚Ø©)</option>
              <option value="rejected">Rejected (Ù…Ø±ÙÙˆØ¶)</option>
            </select>
          </div>

          <div class="field">
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</label>
            <input id="mDate" placeholder="YYYY-MM-DD">
          </div>

          <div class="field">
            <label>ÙˆÙ‚Øª Ø¯Ø®ÙˆÙ„ Ø¬Ø¯ÙŠØ¯</label>
            <input id="mNewInHM" type="time" step="60">
            <div class="hint"></div>
          </div>

          <div class="field">
            <label>ÙˆÙ‚Øª Ø®Ø±ÙˆØ¬ Ø¬Ø¯ÙŠØ¯</label>
            <input id="mNewOutHM" type="time" step="60">
            <div class="hint"></div>
          </div>

          <div class="field" style="grid-column:1/-1">
            <label>Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ù…ÙˆØ¸Ù (Ø³Ø¨Ø¨ Ø§Ù„ØªØµØ­ÙŠØ­)</label>
            <textarea id="mEmployeeNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø·Ù„Ø¨/Ø³Ø¨Ø¨ Ø§Ù„ØªØµØ­ÙŠØ­..."></textarea>
          </div>

          <div class="field" style="grid-column:1/-1">
            <label>Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø£Ø¯Ù…Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <textarea id="mAdminNote" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø© Ø¯Ø§Ø®Ù„ÙŠØ© Ù„Ù„Ø£Ø¯Ù…Ù†..."></textarea>
            <div class="hint"></div>
          </div>
        </div>

        <div class="hint" id="mHint" style="margin-top:10px"></div>
      </div>

      <div class="modalFoot">
        <button class="btn danger" id="btnRejectQuick">Ø±ÙØ¶</button>
        <button class="btn" id="btnSaveDraft">Ø­ÙØ¸</button>
        <button class="btn primary" id="btnSaveApply">Ù…ÙˆØ§ÙÙ‚Ø© + ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc,
      collection, getDocs, query, where,
      orderBy, limit, startAfter, endBefore, limitToLast,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN88FY9CJU8T8cm5lLYjcI-I8VmD46o40",
      authDomain: "roma-schedule.firebaseapp.com",
      projectId: "roma-schedule",
      storageBucket: "roma-schedule.firebasestorage.app",
      messagingSenderId: "685810932602",
      appId: "1:685810932602:web:f1ec506ea6ff5e919d94c3",
      measurementId: "G-5FY5S5TZLJ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id)=>document.getElementById(id);
    const setMsg = (id, text, type="ok")=>{
      const el = $(id);
      if(!el) return;
      el.className = "msg " + (type==="bad"?"bad":"ok");
      el.textContent = text;
      el.style.display = "block";
    };
    const hideMsg = (id)=>{ const el=$(id); if(el) el.style.display="none"; };

    async function requireAdmin(user){
      const snap = await getDoc(doc(db,"employees",user.uid));
      return snap.exists() && snap.data()?.role === "admin";
    }

    function timeToMin(t){
      const s = String(t||"").trim();
      const m = /^(\d{1,2}):(\d{2})$/.exec(s);
      if(!m) return null;
      const hh = Math.max(0, Math.min(23, Number(m[1])));
      const mm = Math.max(0, Math.min(59, Number(m[2])));
      return hh*60+mm;
    }

    function safeId(s){
      return String(s||"").replace(/[^a-zA-Z0-9_-]/g,"_").slice(0,240);
    }

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"]/g, (c)=>({
        "&":"&amp;",
        "<":"&lt;",
        ">":"&gt;",
        "\"":"&quot;"
      }[c]));
    }

    function fmtTime(ms){
      if(!ms) return "-";
      try{
        return new Date(ms).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
      }catch{ return "-"; }
    }

    function calcMinutesLateAndWorked(startStr, checkInMs, checkOutMs){
      const startMin = timeToMin(startStr);
      let minutesLate = null;
      if(startMin!=null && checkInMs){
        const d = new Date(checkInMs);
        const inMin = d.getHours()*60 + d.getMinutes();
        minutesLate = Math.max(0, inMin - startMin);
      }
      let workedMinutes = null;
      if(checkInMs && checkOutMs && Number(checkOutMs) > Number(checkInMs)){
        workedMinutes = Math.floor((Number(checkOutMs)-Number(checkInMs))/60000);
      }
      return { minutesLate, workedMinutes };
    }

    /* =========================================================
       âœ… NEW: Resolve employeeId from employees collection
       - Ø§Ù„Ù‡Ø¯Ù: Ù…Ø§ Ø¹Ø§Ø¯ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ employee_email
       - Ø¯Ø¹Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¯ÙŠÙ…Ø©: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ù„Ø¨ Ù‚Ø¯ÙŠÙ… ÙˆÙŠØ­Ù…Ù„ employeeEmail ÙÙ‚Ø·ØŒ
         Ù†Ø­Ø§ÙˆÙ„ Ù†Ù„Ø§Ù‚ÙŠ Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ù† employees(where email==...) Ø«Ù… Ù†ÙƒØªØ¨ employeeId Ø¯Ø§Ø®Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©.
       ========================================================= */
    async function resolveEmployeeIdSmart(correction){
      const direct = String(correction?.employeeId || "").trim();
      if(direct) return direct;

      const email = String(correction?.employeeEmail || "").trim().toLowerCase();
      if(!email) return null;

      // âš ï¸ Ù‡Ø°Ø§ ÙÙ‚Ø· Ù„ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Once). Ø¨Ø¹Ø¯ Ù‡ÙŠÙƒ Ø¨ÙŠØµÙŠØ± employeeId Ù…ÙˆØ¬ÙˆØ¯.
      const qs = await getDocs(query(collection(db,"employees"), where("email","==", email), limit(1)));
      if(qs.empty) return null;

      const empId = qs.docs[0].id;
      try{
        await updateDoc(doc(db,"attendance_corrections", correction.__id), {
          employeeId: empId,
          migratedFromEmail: true,
          migratedAt: serverTimestamp()
        });
      }catch{}
      return empId;
    }

    /* =========================================================
       âœ… SMART: find attendance docId without using email collection
       - queries by employeeId + date then filters by branch/shift/start
       ========================================================= */
    async function findAttendanceDocIdSmart({ employeeId, date, branchId, shiftName, start }){
      if(!employeeId || !date) return null;

      const q0 = query(
        collection(db,"attendance"),
        where("employeeId","==", String(employeeId)),
        where("date","==", String(date))
      );

      const snap = await getDocs(q0);
      let foundId = null;

      snap.forEach(d=>{
        const x = d.data() || {};
        if(String(x.branchId||"") !== String(branchId||"")) return;
        if(String(x.shiftName||"") !== String(shiftName||"")) return;
        if(String(x.start||"") !== String(start||"")) return;
        if(!foundId) foundId = d.id;
      });

      return foundId;
    }

    // âœ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµØ­ÙŠØ­
    async function applyCorrection(correctionId){
      const cRef = doc(db,"attendance_corrections", correctionId);
      const cSnap = await getDoc(cRef);
      if(!cSnap.exists()) throw new Error("Ø·Ù„Ø¨ Ø§Ù„ØªØµØ­ÙŠØ­ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");
      const c = { __id: correctionId, ...(cSnap.data()||{}) };

      // âœ… Ù„Ø§Ø²Ù… employeeId (Ù†Ø­Ù„Ù‘Ù‡ Ø°ÙƒÙŠÙ‹Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ù„Ø¨ Ù‚Ø¯ÙŠÙ… ÙˆÙŠØ­Ù…Ù„ email ÙÙ‚Ø·)
      const employeeId = await resolveEmployeeIdSmart(c);
      const date = c.date || c.shiftDate || "";
      const branchId = c.branchId || "";
      const shiftName = c.shiftName || c.shift || "";
      const start = c.start || c.shiftStart || "";
      const end = c.end || "";

      if(!employeeId || !date || !branchId || !shiftName || !start){
        throw new Error("Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø¨ Ø§Ù„ØªØµØ­ÙŠØ­ Ù†Ø§Ù‚ØµØ© (employeeId/date/branch/shift/start).");
      }

      const newIn  = c.newCheckInAtLocal ?? c.newCheckIn ?? c.checkInAtLocalNew ?? null;
      const newOut = c.newCheckOutAtLocal ?? c.newCheckOut ?? c.checkOutAtLocalNew ?? null;

      if(!newIn && !newOut){
        throw new Error("Ø§Ù„Ø·Ù„Ø¨ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ ÙˆÙ‚Øª Ø¯Ø®ÙˆÙ„/Ø®Ø±ÙˆØ¬ Ø¬Ø¯ÙŠØ¯.");
      }

      // âœ… Prefer stored appliedAttendanceId, else smart find, else deterministic id
      const existingId =
        (c.appliedAttendanceId ? String(c.appliedAttendanceId) : null)
        || (await findAttendanceDocIdSmart({ employeeId, date, branchId, shiftName, start }))
        || safeId(`${employeeId}__${date}__${branchId}__${shiftName}__${start}`);

      const aRef = doc(db,"attendance", existingId);
      const aSnap = await getDoc(aRef);
      const old = aSnap.exists() ? (aSnap.data()||{}) : {};

      // Save rollback snapshot once
      if(!c.rollbackData){
        await updateDoc(cRef, {
          rollbackData: {
            checkInAtLocal: old.checkInAtLocal ?? null,
            checkOutAtLocal: old.checkOutAtLocal ?? null,
            minutesLate: old.minutesLate ?? null,
            workedMinutes: old.workedMinutes ?? null,
            status: old.status ?? null,
            note: old.note ?? null
          }
        });
      }

      const inMs  = (newIn!=null ? Number(newIn) : (old.checkInAtLocal ?? null));
      const outMs = (newOut!=null ? Number(newOut) : (old.checkOutAtLocal ?? null));

      const { minutesLate, workedMinutes } = calcMinutesLateAndWorked(start || old.start || "", inMs, outMs);
      const status = (outMs ? "completed" : (inMs ? "present" : (old.status || "pending")));

      // âœ… IMPORTANT: no more employeeEmail dependency/storage
      await setDoc(aRef, {
        employeeId: employeeId,
        employeeName: c.employeeName || old.employeeName || "",
        date,
        branchId,
        branchName: c.branchName || old.branchName || "",
        shiftName,
        start,
        end: end || old.end || "",
        checkInAtLocal:  inMs,
        checkOutAtLocal: outMs,
        minutesLate,
        workedMinutes,
        status,
        note: c.note || old.note || "",
        updatedAt: serverTimestamp()
      }, { merge:true });

      await updateDoc(cRef, {
        appliedAt: serverTimestamp(),
        appliedBy: auth.currentUser?.uid || null,
        status: "approved",
        appliedAttendanceId: existingId,
        employeeId: employeeId // ØªØ«Ø¨ÙŠØª/ØªØ±Ø­ÙŠÙ„
      });

      return "ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© + Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ âœ…";
    }

    /* ===== UI logic ===== */
    const FIX = {
      page: 1,
      size: 25,
      onlyPending: false,
      lastDoc: null,
      firstDoc: null,
      rows: [],
      busy: false,
    };

    function badgeForStatus(row){
      const st = String(row?.status || "pending").toLowerCase();
      const isApplied = !!row?.appliedAt;

      if(st==="approved"){
        return isApplied
          ? `<span class="badge ok">ğŸŸ© Approved â€¢ ØªÙ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</span>`
          : `<span class="badge ok">âœ… Approved</span>`;
      }
      if(st==="rejected") return `<span class="badge bad">ğŸŸ¥ Rejected</span>`;
      return `<span class="badge warn">ğŸŸ§ Pending</span>`;
    }

    function updatePageInfo(){
      $("pageInfo").textContent = `ØµÙØ­Ø©: ${FIX.page} â€” ${FIX.size} / ØµÙØ­Ø©`;
      $("btnPrev").disabled = (FIX.page<=1 || FIX.busy);
      $("btnNext").disabled = FIX.busy;
    }

    async function loadBranchStatsLast500(){
      try{
        const q0 = query(collection(db,"attendance_corrections"), orderBy("createdAt","desc"), limit(500));
        const snap = await getDocs(q0);
        const counts = new Map();
        snap.forEach(d=>{
          const x = d.data() || {};
          const key = String(x.branchName || x.branchId || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯");
          counts.set(key, (counts.get(key)||0) + 1);
        });

        const arr = [...counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,6);
        if(!arr.length){
          $("kTopBranch").textContent = "-";
          $("branchesStats").textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØ±ÙˆØ¹.";
          return;
        }

        $("kTopBranch").textContent = `${arr[0][0]} (${arr[0][1]})`;

        const line = arr.map(([k,v],i)=> `${i+1}) ${k}: ${v}`).join("  â€¢  ");
        $("branchesStats").textContent = "Ø£ÙƒØ«Ø± Ø§Ù„ÙØ±ÙˆØ¹ Ø·Ù„Ø¨Ø§Ù‹ Ù„Ù„ØªØµØ­ÙŠØ­ (Ø¢Ø®Ø± 500): " + line;
      }catch(e){
        $("kTopBranch").textContent = "-";
        $("branchesStats").textContent = "ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØ±ÙˆØ¹ Ø­Ø§Ù„ÙŠØ§Ù‹.";
      }
    }

    function countPageKpis(rows){
      let pending=0, approved=0, rejected=0;
      for(const r of rows){
        const st = String(r.status||"pending").toLowerCase();
        if(st==="pending") pending++;
        else if(st==="approved") approved++;
        else if(st==="rejected") rejected++;
      }
      $("kPagePending").textContent = pending;
      $("kPageApproved").textContent = approved;
      $("kPageRejected").textContent = rejected;
    }

    function closeModal(){
      $("editModal").style.display = "none";
      window.__editingCorrection = null;
      $("mHint").textContent = "";
    }
    function openModal(){
      $("editModal").style.display = "flex";
      $("mHint").textContent = "";
    }

    function hmToMs(dateStr, hm){
      const m = /^(\d{1,2}):(\d{2})$/.exec(String(hm||"").trim());
      if(!m) return null;
      if(!/^\d{4}-\d{2}-\d{2}$/.test(String(dateStr||""))) return null;
      const hh = Math.max(0, Math.min(23, Number(m[1])));
      const mm = Math.max(0, Math.min(59, Number(m[2])));
      const dt = new Date(`${dateStr}T00:00:00`);
      dt.setHours(hh, mm, 0, 0);
      return dt.getTime();
    }

    function msToHM(ms){
      if(!ms) return "";
      try{
        const d=new Date(ms);
        const hh=String(d.getHours()).padStart(2,"0");
        const mm=String(d.getMinutes()).padStart(2,"0");
        return `${hh}:${mm}`;
      }catch{return "";}
    }

    function wantedCompact(r){
      const inMs  = (r.newCheckInAtLocal ?? r.newCheckIn ?? null);
      const outMs = (r.newCheckOutAtLocal ?? r.newCheckOut ?? null);
      const parts = [];
      if(inMs) parts.push(`Ø¯Ø®ÙˆÙ„ ${fmtTime(inMs)}`);
      if(outMs) parts.push(`Ø®Ø±ÙˆØ¬ ${fmtTime(outMs)}`);
      const line = parts.join(" â€¢ ");
      return line || (r.note ? String(r.note).slice(0,60) : "-");
    }

    function fillModal(r){
      window.__editingCorrection = r;

      const date = r.date || r.shiftDate || "-";
      const emp = r.employeeName || r.employeeId || "-";
      const br  = r.branchName || r.branchId || "-";
      const sh  = r.shiftName || r.shift || "-";
      const st  = (r.start || r.shiftStart || "");
      const en  = (r.end || "");
      const timeRange = (st && en) ? `${st}-${en}` : (st ? st : "-");

      $("editSub").textContent = `ID: ${r.__id}`;

      const rawStatus = String(r.status||"pending").toLowerCase();
      $("mStatus").value = (rawStatus==="approved" || rawStatus==="rejected" || rawStatus==="pending") ? rawStatus : "pending";

      $("mDate").value = (r.date || r.shiftDate || "");

      const inMs  = (r.newCheckInAtLocal ?? r.newCheckIn ?? null);
      const outMs = (r.newCheckOutAtLocal ?? r.newCheckOut ?? null);

      $("mNewInHM").value = inMs ? msToHM(inMs) : "";
      $("mNewOutHM").value = outMs ? msToHM(outMs) : "";

      $("mEmployeeNote").value = r.note || "";
      $("mAdminNote").value = r.adminNote || "";

      const summary = $("mSummary");
      summary.innerHTML = `
        <span class="chip"><span class="mini">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span> <b>${escapeHtml(date)}</b></span>
        <span class="chip"><span class="mini">Ø§Ù„Ù…ÙˆØ¸Ù:</span> <b>${escapeHtml(emp)}</b></span>
        <span class="chip"><span class="mini">Ø§Ù„ÙØ±Ø¹:</span> <b>${escapeHtml(br)}</b></span>
        <span class="chip"><span class="mini">Ø§Ù„Ø´ÙØª:</span> <b>${escapeHtml(sh)}</b></span>
        <span class="chip"><span class="mini">Ø§Ù„ÙˆÙ‚Øª:</span> <b>${escapeHtml(timeRange)}</b></span>
      `;
    }

    async function saveCorrectionEdits({ alsoApply=false, forceReject=false }={}){
      const r = window.__editingCorrection;
      if(!r) return;

      const id = r.__id;
      const ref = doc(db,"attendance_corrections", id);

      const dateStr = String($("mDate").value||"").trim();
      if(dateStr && !/^\d{4}-\d{2}-\d{2}$/.test(dateStr)){
        throw new Error("Ø§Ù„ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­. Ø§Ø³ØªØ®Ø¯Ù… YYYY-MM-DD.");
      }

      const newInHM = String($("mNewInHM").value||"").trim();
      const newOutHM = String($("mNewOutHM").value||"").trim();

      let status = forceReject ? "rejected" : String($("mStatus").value||"pending").toLowerCase();
      if(alsoApply) status = "approved";
      if(status!=="pending" && status!=="approved" && status!=="rejected") status = "pending";

      const baseDate = dateStr || (r.date||r.shiftDate||"");
      const inMs  = newInHM ? hmToMs(baseDate, newInHM) : null;
      const outMs = newOutHM ? hmToMs(baseDate, newOutHM) : null;

      if(newInHM && inMs==null) throw new Error("ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­.");
      if(newOutHM && outMs==null) throw new Error("ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬ ØºÙŠØ± ØµØ­ÙŠØ­.");

      const patch = {
        status,
        date: baseDate,
        updatedAt: serverTimestamp()
      };

      if(newInHM !== "") patch.newCheckInAtLocal = inMs;
      if(newOutHM !== "") patch.newCheckOutAtLocal = outMs;

      patch.note = String($("mEmployeeNote").value||"").trim();

      const adminNote = String($("mAdminNote").value||"").trim();
      if(adminNote) patch.adminNote = adminNote;

      // âœ… ØªØ«Ø¨ÙŠØª employeeId Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙÙ‚ÙˆØ¯ (ØªØ±Ø­ÙŠÙ„ Ù‚Ø¯ÙŠÙ…)
      const resolvedEmpId = await resolveEmployeeIdSmart({ ...r, __id:id });
      if(resolvedEmpId) patch.employeeId = resolvedEmpId;

      await updateDoc(ref, patch);

      if(alsoApply){
        const snap = await getDoc(ref);
        const fresh = snap.exists() ? ({ __id:id, ...(snap.data()||{}) }) : ({ __id:id, ...r });

        const hasNewIn = fresh.newCheckInAtLocal ?? fresh.newCheckIn ?? null;
        const hasNewOut = fresh.newCheckOutAtLocal ?? fresh.newCheckOut ?? null;

        if(!hasNewIn && !hasNewOut){
          throw new Error("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆÙ‚Øª Ø¯Ø®ÙˆÙ„/Ø®Ø±ÙˆØ¬ Ø¬Ø¯ÙŠØ¯ Ù„ØªØ·Ø¨ÙŠÙ‚Ù‡ Ø¹Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±.");
        }

        await applyCorrection(id);
      }

      setMsg("msgFixTop", alsoApply ? "ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ + Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ âœ…" : "ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ âœ…", "ok");
    }

    async function loadCorrectionsPage({ direction="first" }={}){
      if(FIX.busy) return;
      FIX.busy = true;
      updatePageInfo();
      hideMsg("msgFix");
      hideMsg("msgFixTop");

      try{
        const size = FIX.size;

        let q1 = null;

        if(direction==="next" && FIX.lastDoc){
          q1 = query(
            collection(db,"attendance_corrections"),
            orderBy("createdAt","desc"),
            startAfter(FIX.lastDoc),
            limit(size)
          );
        }else if(direction==="prev" && FIX.firstDoc){
          q1 = query(
            collection(db,"attendance_corrections"),
            orderBy("createdAt","desc"),
            endBefore(FIX.firstDoc),
            limitToLast(size)
          );
        }else{
          q1 = query(
            collection(db,"attendance_corrections"),
            orderBy("createdAt","desc"),
            limit(size)
          );
        }

        const snap = await getDocs(q1);

        const docs = snap.docs || [];
        let rows = docs.map(d=> ({ __id:d.id, ...(d.data()||{}) }));

        if(FIX.onlyPending){
          rows = rows.filter(r => String(r.status||"pending").toLowerCase() === "pending");
        }

        FIX.rows = rows;
        FIX.firstDoc = docs[0] || null;
        FIX.lastDoc = docs[docs.length-1] || null;

        countPageKpis(rows);

        const tb = $("fixTbody");
        tb.innerHTML = "";

        for(const r of rows){
          const st = String(r.status||"pending").toLowerCase();
          const tr = document.createElement("tr");
          if(st==="pending") tr.classList.add("isPending");

          const empId = r.employeeId || "-";
          const empName = r.employeeName || empId;

          tr.innerHTML = `
            <td>${escapeHtml(r.date||r.shiftDate||"-")}</td>
            <td title="${escapeHtml(empId)}">${escapeHtml(empName)}</td>
            <td title="${escapeHtml(r.branchId||"")}">${escapeHtml(r.branchName||r.branchId||"-")}</td>
            <td class="timeCell">${escapeHtml(wantedCompact(r))}</td>
            <td>${badgeForStatus(r)}</td>
            <td class="actions">
              <button class="btn primary" data-edit="${escapeHtml(r.__id)}">Ø¹Ø±Ø¶ / ØªØ¹Ø¯ÙŠÙ„</button>
            </td>
          `;
          tb.appendChild(tr);
        }

        tb.querySelectorAll("button[data-edit]").forEach(b=>{
          b.addEventListener("click", ()=>{
            const id = b.getAttribute("data-edit");
            const row = FIX.rows.find(x=>x.__id===id);
            if(!row) return;
            fillModal(row);
            openModal();
          });
        });

        setMsg("msgFix", `ØªÙ… ØªØ­Ù…ÙŠÙ„ ${rows.length} Ø·Ù„Ø¨ âœ…`, "ok");
      }catch(e){
        const msg = e?.message || "Ø®Ø·Ø£";
        setMsg("msgFix", msg + "\n\nØ¥Ø°Ø§ Ø¸Ù‡Ø± Ø±Ø§Ø¨Ø· Ø¥Ù†Ø´Ø§Ø¡ Index Ù…Ù† FirebaseØŒ Ø§ÙØªØ­Ù‡ ÙˆØ§Ø¹Ù…Ù„ Create.", "bad");
      }finally{
        FIX.busy = false;
        updatePageInfo();
      }
    }

    /* ===== Buttons wiring ===== */
    $("btnReloadFix").addEventListener("click", async ()=>{
      FIX.page = 1;
      FIX.firstDoc = null;
      FIX.lastDoc = null;
      await loadCorrectionsPage({ direction:"first" });
      await loadBranchStatsLast500();
    });

    $("onlyPending").addEventListener("change", async (e)=>{
      FIX.onlyPending = !!e.target.checked;
      FIX.page = 1;
      FIX.firstDoc = null;
      FIX.lastDoc = null;
      await loadCorrectionsPage({ direction:"first" });
    });

    $("pageSizeSel").addEventListener("change", async (e)=>{
      FIX.size = Number(e.target.value || 25);
      FIX.page = 1;
      FIX.firstDoc = null;
      FIX.lastDoc = null;
      await loadCorrectionsPage({ direction:"first" });
    });

    $("btnNext").addEventListener("click", async ()=>{
      if(FIX.busy) return;
      FIX.page++;
      await loadCorrectionsPage({ direction:"next" });
      updatePageInfo();
    });

    $("btnPrev").addEventListener("click", async ()=>{
      if(FIX.busy) return;
      if(FIX.page<=1) return;
      FIX.page--;
      await loadCorrectionsPage({ direction:"prev" });
      updatePageInfo();
    });

    $("btnCloseModal").addEventListener("click", closeModal);
    $("editModal").addEventListener("click", (e)=>{ if(e.target === $("editModal")) closeModal(); });
    window.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeModal(); });

    $("btnRejectQuick").addEventListener("click", async ()=>{
      try{
        await saveCorrectionEdits({ forceReject:true, alsoApply:false });
        closeModal();
        FIX.page = 1;
        FIX.firstDoc = null;
        FIX.lastDoc = null;
        await loadCorrectionsPage({ direction:"first" });
      }catch(e){
        $("mHint").textContent = e?.message || "Ø®Ø·Ø£";
      }
    });

    $("btnSaveDraft").addEventListener("click", async ()=>{
      try{
        await saveCorrectionEdits({ alsoApply:false });
        closeModal();
        FIX.page = 1;
        FIX.firstDoc = null;
        FIX.lastDoc = null;
        await loadCorrectionsPage({ direction:"first" });
      }catch(e){
        $("mHint").textContent = e?.message || "Ø®Ø·Ø£";
      }
    });

    $("btnSaveApply").addEventListener("click", async ()=>{
      try{
        await saveCorrectionEdits({ alsoApply:true });
        closeModal();
        FIX.page = 1;
        FIX.firstDoc = null;
        FIX.lastDoc = null;
        await loadCorrectionsPage({ direction:"first" });
      }catch(e){
        $("mHint").textContent = e?.message || "Ø®Ø·Ø£";
      }
    });

    async function doSignOut(){
      await signOut(auth);
      location.href="./login.html";
    }
    $("btnOut").addEventListener("click", doSignOut);

    // Auth gate
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href="./login.html"; return; }

      // âœ… Ù…Ø§ Ø¹Ø§Ø¯ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙƒÙ…ÙØªØ§Ø­ (ÙÙ‚Ø· Ø¹Ø±Ø¶)
      window.__romaUserText = (user.email || user.uid);
      try{ window.dispatchEvent(new CustomEvent("roma:user", { detail:{ text: window.__romaUserText } })); }catch{}

      const ok = await requireAdmin(user);
      if(!ok){
        const admins = await getDocs(query(collection(db,"employees"), where("role","==","admin")));
        if(admins.size>0){ location.href="./staff.html"; return; }
        setMsg("msgFixTop","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Admin Ø¨Ø¹Ø¯. Ø¹ÙŠÙ‘Ù† Ø£ÙˆÙ„ Ø£Ø¯Ù…Ù† Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ (Ø§Ø¬Ø¹Ù„ Admin).","bad");
      }

      await loadCorrectionsPage({ direction:"first" });
      await loadBranchStatsLast500();
      updatePageInfo();
    });
  </script>
</body>
</html>
