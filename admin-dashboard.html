<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Roma Schedule - Admin Dashboard</title>
  <link rel="icon" href="./assets/logo.webp">
  <!-- Excel export (same as admin-schedule / admin-saved-shifts) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
  <style>
    :root{--bg:#0b1220;--panel:rgba(255,255,255,.06);--line:rgba(255,255,255,.14);--txt:#e5e7eb;--muted:#9ca3af;--accent:#d4a019;--shadow:0 18px 60px rgba(0,0,0,.35);--ok:#16a34a;--bad:#ef4444;--warn:#f59e0b;}
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;background:radial-gradient(1200px 600px at 10% 10%, rgba(212,160,25,.16), transparent 55%),radial-gradient(900px 500px at 90% 20%, rgba(59,130,246,.14), transparent 55%),var(--bg);color:var(--txt);font-family:system-ui,"Noto Sans Arabic",Tahoma,Arial,sans-serif}
    .top{position:sticky;top:0;z-index:10;backdrop-filter:blur(10px);background:rgba(10,16,28,.55);border-bottom:1px solid var(--line)}
    .topin{max-width:1200px;margin:0 auto;padding:14px;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:10px;align-items:center}
    .brand img{width:34px;height:34px;object-fit:contain;border-radius:12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12)}
    .nav{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center}
    a.btn,button.btn{cursor:pointer;border:1px solid var(--line);background:rgba(255,255,255,.06);color:var(--txt);padding:10px 12px;border-radius:12px;font-weight:900;display:inline-flex;align-items:center;justify-content:center;gap:8px;text-decoration:none}
    .btn:hover{background:rgba(255,255,255,.09)}
    .btn.primary{border-color:rgba(212,160,25,.45);background:rgba(212,160,25,.14)}
    .btn.primary:hover{background:rgba(212,160,25,.20)}
    .btn.danger{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.12)}
    .btn.danger:hover{background:rgba(239,68,68,.16)}
    .btn.warn{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.10)}
    .btn.warn:hover{background:rgba(245,158,11,.15)}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px}
    .wrap{max-width:1200px;margin:0 auto;padding:14px}
    .card{border:1px solid var(--line);background:var(--panel);border-radius:18px;padding:12px;box-shadow:var(--shadow)}
    h2{margin:0 0 10px;font-size:18px}
    h3{margin:12px 0 8px;font-size:15px}
    .mini{color:var(--muted);font-size:12px;line-height:1.7}
    .msg{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);display:none}
    .msg.ok{display:block;border-color:rgba(22,163,74,.35);background:rgba(22,163,74,.12)}
    .msg.bad{display:block;border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.12)}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media (max-width:900px){.kpi{grid-template-columns:1fr 1fr}}
    .box{border:1px solid var(--line);background:rgba(255,255,255,.05);border-radius:16px;padding:12px}
    .box b{font-size:22px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select{
      border:1px solid var(--line); background:rgba(0,0,0,.18); color:var(--txt);
      padding:10px 12px; border-radius:12px; outline:none;
    }
    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px}
    th,td{padding:10px; border-bottom:1px solid rgba(255,255,255,.08); text-align:right; font-size:13px}
    th{color:var(--muted); font-weight:900; background:rgba(255,255,255,.04)}
    .badge{display:inline-block; padding:6px 10px; border:1px solid var(--line); border-radius:999px; color:var(--muted); font-size:12px}
    .badge.ok{border-color:rgba(22,163,74,.35); background:rgba(22,163,74,.12); color:#d1fae5}
    .badge.bad{border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.12); color:#fee2e2}
    .badge.warn{border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.10); color:#ffedd5}
    .actions{display:flex; gap:8px; flex-wrap:wrap}
    .sep{border:none;border-top:1px solid rgba(255,255,255,.12); margin:14px 0}
  </style>
</head>
<body>
  <div class="top">
    <div class="topin">
      <div class="brand">
        <img src="./assets/logo.webp" alt="Roma">
        <div>
          <b>Roma Schedule</b>
          <div class="pill" id="mePill">...</div>
        </div>
      </div>
      <div class="nav">
        <a class="btn" href="./admin-dashboard.html">Dashboard</a>
        <a class="btn" href="./admin-branches.html">Ø§Ù„ÙØ±ÙˆØ¹ + Ø§Ù„Ø¯ÙˆØ§Ù…</a>
        <a class="btn" href="./admin-employees.html">Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</a>
        <a class="btn" href="./admin-leaves.html">Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª</a>
        <a class="btn" href="./admin-schedule.html">ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„</a>
        <a class="btn" href="./admin-saved-shifts.html">Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¬Ø§Ù‡Ø²Ø©</a>
        <button class="btn primary" id="btnMakeAdmin" title="Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·">Ø§Ø¬Ø¹Ù„ Admin</button>
        <button class="btn danger" id="btnOut">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <h2>Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</h2>
      <div class="kpi">
        <div class="box"><div class="mini">Ø§Ù„ÙØ±ÙˆØ¹</div><b id="kBranches">0</b></div>
        <div class="box"><div class="mini">Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (employees)</div><b id="kEmployees">0</b></div>
        <div class="box"><div class="mini">Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (employees_email)</div><b id="kPresets">0</b></div>
        <div class="box"><div class="mini">Ø·Ù„Ø¨Ø§Øª Pending</div><b id="kLeaves">0</b></div>
      </div>
      <div id="msgDash" class="msg"></div>
      <div class="mini" style="margin-top:10px">
        â€¢ ÙƒÙ„ ÙØ±Ø¹ Ù„Ù‡ Ø´ÙØªØ§Øª 8 Ø³Ø§Ø¹Ø§Øª (end ÙŠÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§)<br>
        â€¢ Regular Ù„Ù‡ branchId Ø«Ø§Ø¨Øª<br>
        â€¢ Cover ÙŠØºØ·ÙŠ Ø§Ù„ÙƒÙ„ Ø£Ùˆ ÙØ±ÙˆØ¹ Ù…Ø­Ø¯Ø¯Ø©<br>
        â€¢ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ØªÙ†Ø­ÙØ¸ Ø¯Ø§Ø®Ù„: employees/{uid}/schedules Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù€ Index
      </div>
    </div>

    <div class="grid" style="margin-top:14px">
      <div class="card">
        <h2>Dashboard Ø§Ù„Ø­Ø¶ÙˆØ±</h2>
        <div class="row">
          <label class="mini">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
          <input type="date" id="fDate">
          <label class="mini">Ø§Ù„ÙØ±Ø¹</label>
          <select id="fBranch"></select>

          <button class="btn" id="btnReloadAtt">ØªØ­Ø¯ÙŠØ«</button>
          <button class="btn primary" id="btnExportExcel">ØªØµØ¯ÙŠØ± Excel</button>
          <button class="btn" id="btnExportPdf">ØªØµØ¯ÙŠØ± PDF</button>
        </div>

        <div class="kpi" style="margin-top:10px">
          <div class="box"><div class="mini">ğŸ‘¤ Ø­Ø¶Ø±</div><b id="kPresent">0</b></div>
          <div class="box"><div class="mini">â° Ù…ØªØ£Ø®Ø±</div><b id="kLate">0</b></div>
          <div class="box"><div class="mini">âŒ ØºØ§ÙŠØ¨</div><b id="kAbsent">0</b></div>
          <div class="box"><div class="mini">âœ… Ø¥Ø¬Ø§Ø²Ø©</div><b id="kLeaveDay">0</b></div>
        </div>

        <div id="msgAtt" class="msg"></div>

        <hr class="sep">

        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                <th>Ø§Ù„ÙØ±Ø¹</th>
                <th>Ø§Ù„Ø´ÙØª</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Check-In</th>
                <th>Check-Out</th>
                <th>Late</th>
                <th>Worked</th>
              </tr>
            </thead>
            <tbody id="attTbody"></tbody>
          </table>
        </div>

        <div class="mini" style="margin-top:10px">
          â€¢ Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡ Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† Ø§Ù„Ø´ÙØª Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ„Ù… ÙŠÙˆØ¬Ø¯ Check-In.<br>
          â€¢ Ø¥Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ø¥Ø¬Ø§Ø²Ø© Approved: Ù†Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø­Ø§Ù„Ø© Leave ÙˆÙ†Ù…Ù†Ø¹ Check-In.
        </div>
      </div>

      <div class="card">
        <h2>Ø·Ù„Ø¨Ø§Øª ØªØµØ­ÙŠØ­ Ø§Ù„Ø¯ÙˆØ§Ù…</h2>
        <div class="row">
          <button class="btn" id="btnReloadFix">ØªØ­Ø¯ÙŠØ«</button>
        </div>

        <div style="overflow:auto; margin-top:10px">
          <table>
            <thead>
              <tr>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                <th>Ø§Ù„ÙØ±Ø¹</th>
                <th>Ø§Ù„Ø´ÙØª</th>
                <th>Ø§Ù„Ø³Ø¨Ø¨</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
              </tr>
            </thead>
            <tbody id="fixTbody"></tbody>
          </table>
        </div>
        <div id="msgFix" class="msg"></div>

        <div class="mini" style="margin-top:10px">
          â€¢ Ø¹Ù†Ø¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©: ÙŠØªÙ… ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© Approved Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨ ÙÙ‚Ø· (ØªÙ‚Ø¯Ø± ØªÙˆØ³Ù‘Ø¹Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª ÙØ¹Ù„ÙŠØ§Ù‹).<br>
          â€¢ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„ØªØ·ÙˆÙŠØ± â€œØªØ¹Ø¯ÙŠÙ„ Ø¯Ø®ÙˆÙ„/Ø®Ø±ÙˆØ¬â€ Ø­Ø³Ø¨ Ù…Ø§ Ø¨Ø¯Ùƒ.
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc,
      collection, getDocs,
      query, where,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN88FY9CJU8T8cm5lLYjcI-I8VmD46o40",
      authDomain: "roma-schedule.firebaseapp.com",
      projectId: "roma-schedule",
      storageBucket: "roma-schedule.firebasestorage.app",
      messagingSenderId: "685810932602",
      appId: "1:685810932602:web:f1ec506ea6ff5e919d94c3",
      measurementId: "G-5FY5S5TZLJ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id)=>document.getElementById(id);
    const setMsg = (id, text, type="ok")=>{
      const el = $(id);
      el.className = "msg " + (type==="bad"?"bad":"ok");
      el.textContent = text;
    };

    async function requireAdmin(user){
      const snap = await getDoc(doc(db,"employees",user.uid));
      return snap.exists() && snap.data()?.role === "admin";
    }

    function ymd(d){
      const dt = new Date(d);
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,"0");
      const da = String(dt.getDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    }
    function timeToMin(t){
      const s = String(t||"").trim();
      const m = /^(\d{1,2}):(\d{2})$/.exec(s);
      if(!m) return null;
      const hh = Math.max(0, Math.min(23, Number(m[1])));
      const mm = Math.max(0, Math.min(59, Number(m[2])));
      return hh*60+mm;
    }
    function nowMin(){
      const d=new Date();
      return d.getHours()*60 + d.getMinutes();
    }
    function safeId(s){
      return String(s||"").replace(/[^a-zA-Z0-9_-]/g,"_").slice(0,240);
    }
    function fmtTime(ms){
      if(!ms) return "-";
      try{
        return new Date(ms).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
      }catch{ return "-"; }
    }
    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"]/g, (c)=>({
        "&":"&amp;",
        "<":"&lt;",
        ">":"&gt;",
        "\"":"&quot;"
      }[c]));
    }

    async function loadBranchSelect(){
      const snap = await getDocs(collection(db,"branches"));
      const rows = [];
      snap.forEach(d=> rows.push({ id:d.id, ...(d.data()||{}) }));
      rows.sort((a,b)=> (a.name||a.id||"").localeCompare(b.name||b.id||""));

      const sel = $("fBranch");
      sel.innerHTML =
        `<option value="">â€” ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹ â€”</option>` +
        rows.map(b=> `<option value="${escapeHtml(b.id)}">${escapeHtml(b.name||b.id)} (${escapeHtml(b.id)})</option>`).join("");

      return rows;
    }

    async function loadEmployees(){
      const snap = await getDocs(collection(db,"employees"));
      const out=[];
      snap.forEach(d=> out.push({ id:d.id, ...(d.data()||{}) }));
      return out;
    }

    async function loadLeavesApproved(){
      const snap = await getDocs(collection(db,"leaves"));
      const out=[];
      snap.forEach(d=>{
        const x = d.data() || {};
        if(String(x.status||"").toLowerCase() !== "approved") return;
        if(!x.employeeId || !x.from || !x.to) return;
        out.push({ ...x });
      });
      return out;
    }

    function isOnLeave(leaves, employeeId, dateStr){
      for(const l of leaves){
        if(l.employeeId !== employeeId) continue;
        if(dateStr >= l.from && dateStr <= l.to) return true;
      }
      return false;
    }

    async function markAutoAbsencesForDate(dateStr){
      const shiftsSnap = await getDocs(collection(db,"shifts"));
      const shifts = [];
      shiftsSnap.forEach(d=>{
        const x = d.data() || {};
        if(x.date !== dateStr) return;
        if(!x.employeeId) return;
        shifts.push({ id:d.id, ...x });
      });

      const leaves = await loadLeavesApproved();

      const attSnap = await getDocs(collection(db,"attendance"));
      const attByKey = new Map();
      attSnap.forEach(d=>{
        const x = d.data() || {};
        if(x.date !== dateStr) return;
        if(!x.employeeId) return;
        const k = `${x.employeeId}__${x.date}__${x.branchId||""}__${x.shiftName||""}__${x.start||""}`;
        attByKey.set(k, { id:d.id, ...x });
      });

      let checked = 0;
      let marked = 0;

      for(const s of shifts){
        checked++;

        const endMin = timeToMin(s.end);
        const ended = (endMin===null) ? false : (nowMin() >= endMin);
        if(!ended) continue;

        const k = `${s.employeeId}__${s.date}__${s.branchId||""}__${s.shiftName||""}__${s.start||""}`;
        const hasAttendance = attByKey.has(k);

        const onLeave = isOnLeave(leaves, s.employeeId, dateStr);
        const attId = safeId(k);

        if(onLeave){
          if(!hasAttendance){
            await setDoc(doc(db,"attendance", attId), {
              employeeId: s.employeeId,
              employeeName: s.employeeName || "",
              employeeEmail: s.employeeEmail || "",
              date: s.date,
              branchId: s.branchId || "",
              branchName: s.branchName || "",
              shiftName: s.shiftName || "",
              start: s.start || "",
              end: s.end || "",
              status: "leave",
              note: "On approved leave",
              updatedAt: serverTimestamp()
            }, { merge:true });
            marked++;
          }
          continue;
        }

        if(!hasAttendance){
          await setDoc(doc(db,"attendance", attId), {
            employeeId: s.employeeId,
            employeeName: s.employeeName || "",
            employeeEmail: s.employeeEmail || "",
            date: s.date,
            branchId: s.branchId || "",
            branchName: s.branchName || "",
            shiftName: s.shiftName || "",
            start: s.start || "",
            end: s.end || "",
            status: "absent",
            minutesLate: null,
            note: "Auto absent (shift ended, no check-in)",
            updatedAt: serverTimestamp()
          }, { merge:true });
          marked++;
        }
      }

      return { checked, marked };
    }

    async function loadAttendanceForDate(dateStr, branchId=""){
      const [attSnap, shiftsSnap, emps, leaves] = await Promise.all([
        getDocs(collection(db,"attendance")),
        getDocs(collection(db,"shifts")),
        loadEmployees(),
        loadLeavesApproved()
      ]);

      const rows = [];
      const attMap = new Map();

      attSnap.forEach(d=>{
        const x = d.data() || {};
        if(x.date !== dateStr) return;
        if(branchId && String(x.branchId||"") !== String(branchId)) return;
        const k = `${x.employeeId}__${x.date}__${x.branchId||""}__${x.shiftName||""}__${x.start||""}`;
        attMap.set(k, { __id: d.id, ...x });
      });

      const shifts = [];
      shiftsSnap.forEach(d=>{
        const x = d.data() || {};
        if(x.date !== dateStr) return;
        if(branchId && String(x.branchId||"") !== String(branchId)) return;
        if(!x.employeeId) return;
        shifts.push({ __id: d.id, ...x });
      });

      for(const s of shifts){
        const k = `${s.employeeId}__${s.date}__${s.branchId||""}__${s.shiftName||""}__${s.start||""}`;
        const a = attMap.get(k);

        if(a){
          rows.push({ ...a });
        }else{
          const onLeave = isOnLeave(leaves, s.employeeId, dateStr);
          rows.push({
            employeeId: s.employeeId,
            employeeName: s.employeeName || (emps.find(e=>e.id===s.employeeId)?.name || ""),
            employeeEmail: s.employeeEmail || (emps.find(e=>e.id===s.employeeId)?.email || ""),
            date: s.date,
            branchId: s.branchId || "",
            branchName: s.branchName || "",
            shiftName: s.shiftName || "",
            start: s.start || "",
            end: s.end || "",
            status: onLeave ? "leave" : "absent",
            note: onLeave ? "Leave (no attendance record)" : "Absent (no attendance record)"
          });
        }
      }

      rows.sort((a,b)=>{
        const an = (a.branchName||a.branchId||"");
        const bn = (b.branchName||b.branchId||"");
        if(an!==bn) return an.localeCompare(bn);
        const ae = (a.employeeName||a.employeeEmail||"");
        const be = (b.employeeName||b.employeeEmail||"");
        return ae.localeCompare(be);
      });

      let present=0, late=0, absent=0, leaveDay=0;
      for(const r of rows){
        const st = String(r.status||"").toLowerCase();
        if(st==="leave"){ leaveDay++; continue; }
        if(st==="absent"){ absent++; continue; }
        if(st==="completed" || st==="present"){
          present++;
          if(Number(r.minutesLate||0)>0) late++;
        }
      }

      $("kPresent").textContent = present;
      $("kLate").textContent = late;
      $("kAbsent").textContent = absent;
      $("kLeaveDay").textContent = leaveDay;

      const tb = $("attTbody");
      tb.innerHTML = "";
      for(const r of rows){
        const st = String(r.status||"").toLowerCase();
        const badge =
          st==="leave" ? `<span class="badge ok">Leave</span>` :
          st==="absent" ? `<span class="badge bad">Absent</span>` :
          (Number(r.minutesLate||0)>0 ? `<span class="badge warn">Late</span>` : `<span class="badge ok">Present</span>`);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(r.employeeName || r.employeeEmail || r.employeeId || "-")}</td>
          <td>${escapeHtml(r.branchName || r.branchId || "-")}</td>
          <td>${escapeHtml(r.shiftName || "-")} <span class="badge">${escapeHtml((r.start&&r.end)?(r.start+"-"+r.end):"")}</span></td>
          <td>${badge}</td>
          <td>${fmtTime(r.checkInAtLocal)}</td>
          <td>${fmtTime(r.checkOutAtLocal)}</td>
          <td>${r.minutesLate ? `${escapeHtml(r.minutesLate)}Ø¯` : "-"}</td>
          <td>${r.workedMinutes ? `${escapeHtml(r.workedMinutes)}Ø¯` : "-"}</td>
        `;
        tb.appendChild(tr);
      }

      window.__attRows = rows;
      window.__attDate = dateStr;
      window.__attBranchId = branchId || "";
    }

    async function exportAttendanceExcel(){
      const rows = window.__attRows || [];
      if(!rows.length) return setMsg("msgAtt","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±.","bad");
      const XLSX = window.XLSX;
      if(!XLSX) return setMsg("msgAtt","Ù…ÙƒØªØ¨Ø© Excel ØºÙŠØ± Ù…Ø­Ù…Ù‘Ù„Ø©.","bad");

      const headers = ["Ø§Ù„ØªØ§Ø±ÙŠØ®","Ø§Ù„Ù…ÙˆØ¸Ù","Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„","Ø§Ù„ÙØ±Ø¹","Ø§Ù„Ø´ÙØª","Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©","Ø§Ù„Ù†Ù‡Ø§ÙŠØ©","Ø§Ù„Ø­Ø§Ù„Ø©","CheckIn","CheckOut","Late(min)","Worked(min)","Ù…Ù„Ø§Ø­Ø¸Ø©"];
      const data = rows.map(r=>[
        r.date || "",
        r.employeeName || "",
        r.employeeEmail || "",
        r.branchName || r.branchId || "",
        r.shiftName || "",
        r.start || "",
        r.end || "",
        (r.status || ""),
        r.checkInAtLocal ? new Date(r.checkInAtLocal).toISOString() : "",
        r.checkOutAtLocal ? new Date(r.checkOutAtLocal).toISOString() : "",
        r.minutesLate || "",
        r.workedMinutes || "",
        r.note || ""
      ]);

      const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);

      for(let c=0; c<headers.length; c++){
        const addr = XLSX.utils.encode_cell({ r:0, c });
        if(ws[addr]) ws[addr].s = {
          font: { bold:true, color:{ rgb:"FFFFFFFF" } },
          fill: { patternType:"solid", fgColor:{ rgb:"FF111827" } },
          alignment: { horizontal:"center", vertical:"center" },
          border: {
            top:{style:"thin",color:{rgb:"FF374151"}},
            bottom:{style:"thin",color:{rgb:"FF374151"}},
            left:{style:"thin",color:{rgb:"FF374151"}},
            right:{style:"thin",color:{rgb:"FF374151"}},
          }
        };
      }

      ws["!cols"] = headers.map(()=>({ wch: 18 }));

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Attendance");

      const date = window.__attDate || "date";
      const br = window.__attBranchId || "all";
      XLSX.writeFile(wb, `attendance_${br}_${date}.xlsx`);
      setMsg("msgAtt","ØªÙ… ØªØµØ¯ÙŠØ± Excel âœ…","ok");
    }

    function exportAttendancePdf(){
      const rows = window.__attRows || [];
      if(!rows.length) return setMsg("msgAtt","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±.","bad");

      const date = window.__attDate || "";
      const br = window.__attBranchId || "";

      /* âœ… FIXED: no nested template literals */
      const title = "Attendance Report â€” " + date + (br ? " (" + br + ")" : "");

      const html = `
        <html lang="ar" dir="rtl">
        <head>
          <meta charset="utf-8"/>
          <title>${title}</title>
          <style>
            body{font-family:system-ui, Tahoma, Arial; padding:16px}
            h1{margin:0 0 12px; font-size:18px}
            table{width:100%; border-collapse:collapse}
            th,td{border:1px solid #ddd; padding:8px; font-size:12px; text-align:right}
            th{background:#f5f5f5}
          </style>
        </head>
        <body>
          <h1>${title}</h1>
          <table>
            <thead>
              <tr>
                <th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„ÙØ±Ø¹</th><th>Ø§Ù„Ø´ÙØª</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¯Ø®ÙˆÙ„</th><th>Ø®Ø±ÙˆØ¬</th><th>Late</th><th>Worked</th>
              </tr>
            </thead>
            <tbody>
              ${rows.map(r=>`
                <tr>
                  <td>${escapeHtml(r.employeeName||r.employeeEmail||r.employeeId||'')}</td>
                  <td>${escapeHtml(r.branchName||r.branchId||'')}</td>
                  <td>${escapeHtml(r.shiftName||'')} ${escapeHtml((r.start && r.end) ? ("(" + r.start + "-" + r.end + ")") : "")}</td>
                  <td>${escapeHtml(r.status||'')}</td>
                  <td>${escapeHtml(fmtTime(r.checkInAtLocal))}</td>
                  <td>${escapeHtml(fmtTime(r.checkOutAtLocal))}</td>
                  <td>${escapeHtml(r.minutesLate||'')}</td>
                  <td>${escapeHtml(r.workedMinutes||'')}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
       
        </body>
        </html>
      `;

      const w = window.open('', '_blank');
      if(!w) return setMsg("msgAtt","Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù†Ø¹ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©.","bad");
      w.document.open();
      w.document.write(html);
      w.document.close();
      setMsg("msgAtt","ØªÙ… ÙØªØ­ PDF Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© âœ… (Ø§Ø®ØªØ± Save as PDF)","ok");
    }

    async function loadCorrections(){
      const snap = await getDocs(collection(db,"attendance_corrections"));
      const rows=[];
      snap.forEach(d=>{
        const x=d.data()||{};
        rows.push({ __id:d.id, ...x });
      });
      rows.sort((a,b)=> (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));

      const tb = $("fixTbody");
      tb.innerHTML = "";
      for(const r of rows.slice(0,100)){
        const st = String(r.status||"pending").toLowerCase();
        const badge =
          st==="approved" ? `<span class="badge ok">Approved</span>` :
          st==="rejected" ? `<span class="badge bad">Rejected</span>` :
          `<span class="badge warn">Pending</span>`;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(r.date||"-")}</td>
          <td>${escapeHtml(r.employeeName||r.employeeEmail||r.employeeId||"-")}</td>
          <td>${escapeHtml(r.branchName||r.branchId||"-")}</td>
          <td>${escapeHtml(r.shiftName||"-")}</td>
          <td>${escapeHtml(r.note||"")}</td>
          <td>${badge}</td>
          <td class="actions">
            <button class="btn primary" data-approve="${escapeHtml(r.__id)}">Ù…ÙˆØ§ÙÙ‚Ø©</button>
            <button class="btn danger" data-reject="${escapeHtml(r.__id)}">Ø±ÙØ¶</button>
          </td>
        `;
        tb.appendChild(tr);
      }

      tb.querySelectorAll("button[data-approve]").forEach(b=>{
        b.addEventListener("click", async ()=>{
          const id = b.getAttribute("data-approve");
          await updateDoc(doc(db,"attendance_corrections", id), { status:"approved", updatedAt: serverTimestamp() });
          setMsg("msgFix","ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© âœ…","ok");
          await loadCorrections();
        });
      });
      tb.querySelectorAll("button[data-reject]").forEach(b=>{
        b.addEventListener("click", async ()=>{
          const id = b.getAttribute("data-reject");
          await updateDoc(doc(db,"attendance_corrections", id), { status:"rejected", updatedAt: serverTimestamp() });
          setMsg("msgFix","ØªÙ… Ø§Ù„Ø±ÙØ¶ âœ…","ok");
          await loadCorrections();
        });
      });
    }

    $("btnOut").addEventListener("click", async ()=>{ await signOut(auth); location.href="./login.html"; });

    $("btnMakeAdmin").addEventListener("click", async ()=>{
      const user = auth.currentUser;
      if(!user) return;
      await setDoc(doc(db,"employees",user.uid), {
        name: (user.email||"Admin").split("@")[0],
        email: user.email || "",
        role: "admin",
        type: "regular",
        department: "Admin",
        canCover: true,
        active: true,
        createdAt: serverTimestamp()
      }, { merge:true });

      setMsg("msgDash","ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø¯ÙˆØ±Ùƒ Admin âœ… Ø£Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.","ok");
    });

    $("btnReloadAtt").addEventListener("click", async ()=>{
      const date = $("fDate").value;
      const br = $("fBranch").value || "";
      await loadAttendanceForDate(date, br);
      setMsg("msgAtt","ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« âœ…","ok");
    });

    $("btnExportExcel").addEventListener("click", exportAttendanceExcel);
    $("btnExportPdf").addEventListener("click", exportAttendancePdf);

    $("btnReloadFix").addEventListener("click", async ()=>{
      await loadCorrections();
      setMsg("msgFix","ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« âœ…","ok");
    });

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href="./login.html"; return; }
      $("mePill").textContent = user.email || user.uid;

      const ok = await requireAdmin(user);
      if(!ok){
        const admins = await getDocs(query(collection(db,"employees"), where("role","==","admin")));
        if(admins.size>0){ location.href="./staff.html"; return; }
        setMsg("msgDash","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Admin Ø¨Ø¹Ø¯. Ø§Ø¶ØºØ· (Ø§Ø¬Ø¹Ù„ Admin) Ù„ØªØµØ¨Ø­ Ø£ÙˆÙ„ Ø£Ø¯Ù…Ù†.","bad");
      }

      const [bSnap, eSnap, pSnap, lSnap] = await Promise.all([
        getDocs(collection(db,"branches")),
        getDocs(collection(db,"employees")),
        getDocs(collection(db,"employees_email")),
        getDocs(query(collection(db,"leaves"), where("status","==","pending")))
      ]);

      $("kBranches").textContent = bSnap.size;
      $("kEmployees").textContent = eSnap.size;
      $("kPresets").textContent  = pSnap.size;
      $("kLeaves").textContent   = lSnap.size;

      await loadBranchSelect();

      $("fDate").value = ymd(new Date());

      try{
        const date = $("fDate").value;
        const res = await markAutoAbsencesForDate(date);
        if(res?.marked){
          setMsg("msgAtt", `ØªÙ… ØªØ³Ø¬ÙŠÙ„ ØºÙŠØ§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ: ${res.marked} (Ù…Ù† Ø£ØµÙ„ ${res.checked}) âœ…`, "ok");
        }
      }catch(e){
        console.warn(e);
      }

      await loadAttendanceForDate($("fDate").value, "");
      await loadCorrections();
    });
  </script>
</body>
</html>
