<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Roma Schedule - Admin Dashboard</title>
  <link rel="icon" href="./assets/logo.webp">
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.04);
      --line:rgba(255,255,255,.14);
      --line2:rgba(255,255,255,.10);
      --txt:#e5e7eb;
      --muted:#9ca3af;
      --accent:#d4a019;
      --shadow:0 18px 60px rgba(0,0,0,.35);
      --ok:#16a34a;
      --bad:#ef4444;
      --warn:#f59e0b;
      --info:#60a5fa;
      --ease:cubic-bezier(.22,.61,.36,1);
    }

    *{box-sizing:border-box}
    body{
      margin:0;min-height:100vh;
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(212,160,25,.16), transparent 55%),
        radial-gradient(900px 500px at 90% 20%, rgba(59,130,246,.14), transparent 55%),
        var(--bg);
      color:var(--txt);
      font-family:system-ui,"Noto Sans Arabic",Tahoma,Arial,sans-serif
    }

    a.btn,button.btn{
      cursor:pointer;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--txt);
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      text-decoration:none;
      transition: transform .12s var(--ease), background .12s var(--ease), border-color .12s var(--ease);
      user-select:none;
      min-height:42px;
      white-space:nowrap;
    }
    .btn:hover{background:rgba(255,255,255,.10); transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.primary{border-color:rgba(212,160,25,.45);background:rgba(212,160,25,.14)}
    .btn.primary:hover{background:rgba(212,160,25,.22)}
    .btn.danger{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.12)}
    .btn.danger:hover{background:rgba(239,68,68,.18)}
    .btn.warn{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.10)}
    .btn.warn:hover{background:rgba(245,158,11,.16)}
    .btn:disabled{opacity:.45;cursor:not-allowed;transform:none!important}

    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px}

    .wrap{
      max-width:1600px;
      margin:0 auto;
      padding:14px;
      padding-top:14px!important;
    }

    .card{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      border-radius:18px;
      padding:12px;
      box-shadow:var(--shadow);
    }

    h2{margin:0 0 10px;font-size:18px}
    .mini{color:var(--muted);font-size:12px;line-height:1.7}

    .msg{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);display:none;white-space:pre-line}
    .msg.ok{display:block;border-color:rgba(22,163,74,.35);background:rgba(22,163,74,.12)}
    .msg.bad{display:block;border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.12)}

    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media (max-width:900px){.kpi{grid-template-columns:1fr 1fr}}
    .box{
      border:1px solid var(--line2);
      background:rgba(255,255,255,.05);
      border-radius:16px;
      padding:12px;
      min-width:0;
    }
    .box b{font-size:22px}

    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:14px;
      margin-top:14px;
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .split{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}

    .toolbar{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      padding:10px;border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);border-radius:16px;
      margin-top:8px;
      min-width:0;
    }
    .toolbar .left,.toolbar .right{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    input,select,textarea{
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      color:var(--txt);
      padding:11px 12px;
      border-radius:12px;
      outline:none;
      min-height:42px;
      transition:.15s var(--ease);
      min-width:0;
      max-width:100%;
    }
    textarea{min-height:90px; resize:vertical}
    input:focus,select:focus,textarea:focus{border-color:rgba(212,160,25,.70);box-shadow:0 0 0 4px rgba(212,160,25,.14)}
    input[type="date"]{min-width:180px}
    select{min-width:220px}

    /* âœ… time picker look + LTR */
    input[type="time"]{
      direction:ltr;
      unicode-bidi:embed;
      text-align:left;
      min-width:180px;
    }

    .tableWrap{
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      overflow-x:auto;
      overflow-y:hidden;
      background:rgba(0,0,0,.12);
      max-width:100%;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width:100%;
    }
    thead th{
      position:sticky;
      top:0;
      z-index:2;
      background:rgba(12,18,32,.92);
      backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(255,255,255,.12);
      color:var(--muted);
      font-weight:900;
      text-align:right;
    }
    th,td{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      text-align:right;
      font-size:13px;
      vertical-align:middle;
      white-space:nowrap;
    }
    tbody tr:nth-child(odd) td{background:rgba(255,255,255,.03)}
    tbody tr:hover td{background:rgba(212,160,25,.06)}
    .timeCell{direction:ltr;unicode-bidi:embed;text-align:left}

    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:7px 10px;border:1px solid var(--line);
      border-radius:999px;color:var(--muted);font-size:12px;white-space:nowrap;
      background:rgba(255,255,255,.03);
    }
    .badge.ok{border-color:rgba(22,163,74,.35);background:rgba(22,163,74,.12);color:#d1fae5}
    .badge.bad{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.12);color:#fee2e2}
    .badge.warn{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.10);color:#ffedd5}
    .badge.info{border-color:rgba(96,165,250,.35);background:rgba(96,165,250,.10);color:#dbeafe}

    /* Actions */
    td.actions{white-space:normal!important; width:170px}
    .actions{display:flex!important;flex-wrap:wrap!important;gap:8px!important;align-items:center!important;justify-content:flex-start!important}
    .actions .btn{flex:1 1 160px!important}

    tr.isPending td{
      background: linear-gradient(90deg, rgba(245,158,11,.12), rgba(212,160,25,.06)) !important;
      border-bottom-color: rgba(245,158,11,.20);
    }

    .top{display:none!important}
    @media (min-width:980px){
      .wrap{padding-right:330px;padding-left:14px}
      html[dir="ltr"] .wrap{padding-left:330px;padding-right:14px}
    }
    @media (max-width:979.98px){.wrap{padding-top:10px}}
    @media (min-width:980px){.wrap{padding-right:14px!important;padding-left:14px!important}}

    /* ===== Modal ===== */
    .modalBackdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:9999;
    }
    .modal{
      width:min(920px, 100%);
      border:1px solid rgba(255,255,255,.14);
      background:rgba(12,18,32,.92);
      backdrop-filter: blur(12px);
      border-radius:18px;
      box-shadow:0 26px 90px rgba(0,0,0,.55);
      overflow:hidden;
      max-height:90vh;
      overflow-y:auto;
    }
    .modalHead{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      position:sticky; top:0; z-index:5;
      background:rgba(12,18,32,.92);
      backdrop-filter: blur(12px);
    }
    .modalBody{padding:12px}
    .modalGrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    @media (max-width:800px){ .modalGrid{grid-template-columns:1fr} }
    .field label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    .modalFoot{
      padding:12px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
      position:sticky; bottom:0; z-index:5;
      background:rgba(12,18,32,.92);
      backdrop-filter: blur(12px);
    }
    .hint{font-size:12px;color:var(--muted)}
    .chip{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 10px;border:1px solid rgba(255,255,255,.12);
      border-radius:999px;background:rgba(255,255,255,.04); color:var(--txt);
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .chip b{color:var(--txt)}
    .chipsLine{display:flex;flex-wrap:wrap;gap:8px}

    @media (max-width:768px){
      th,td{font-size:12px;padding:8px}
      .actions .btn{flex:1 1 100%!important}
      input[type="date"]{min-width:150px}
      select{min-width:160px}
      input[type="time"]{min-width:150px}
    }
  </style>
</head>

<body>

  <div id="navMount"></div>

  <script>
    (function(){
      const mount = document.getElementById("navMount");
      if(!mount) return;

      function loadScript(src){
        return new Promise((resolve,reject)=>{
          const s = document.createElement("script");
          s.src = src;
          s.onload = resolve;
          s.onerror = reject;
          document.body.appendChild(s);
        });
      }

      fetch("./nav.html", { cache:"no-store" })
        .then(r=> r.text())
        .then(async (html)=>{
          mount.innerHTML = html;
          await loadScript("./nav.js?v=" + Date.now());
          if(window.__romaUserText){
            try{ window.dispatchEvent(new CustomEvent("roma:user", { detail:{ text: window.__romaUserText } })); }catch{}
          }
          window.dispatchEvent(new CustomEvent("roma:nav:layout"));
        })
        .catch(()=>{});
    })();
  </script>

  <div class="wrap">

    <div class="card">
      <div class="split">
        <div>
          <h2 style="margin:0 0 6px">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
          <div class="mini"></div>
        </div>
        <div class="row" style="justify-content:flex-end">
          <button class="btn primary" id="btnMakeAdmin2" title="Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·">Ø§Ø¬Ø¹Ù„ Admin</button>
          <button class="btn danger" id="btnOut2">Ø®Ø±ÙˆØ¬</button>
        </div>
      </div>

      <div class="kpi" style="margin-top:10px">
        <div class="box"><div class="mini">Ø§Ù„ÙØ±ÙˆØ¹</div><b id="kBranches">0</b></div>
        <div class="box"><div class="mini">Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (employees)</div><b id="kEmployees">0</b></div>
        <div class="box"><div class="mini">Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (employees_email)</div><b id="kPresets">0</b></div>
        <div class="box"><div class="mini">Ø·Ù„Ø¨Ø§Øª Ø¥Ø¬Ø§Ø²Ø© Pending</div><b id="kLeaves">0</b></div>
      </div>

      <div id="msgDash" class="msg"></div>
    </div>

    <div class="grid">

      <!-- Attendance -->
      <div class="card">
        <div class="split">
          <div>
            <h2 style="margin:0 0 6px">Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</h2>
            <div class="mini"></div>
          </div>
          <div class="row" style="justify-content:flex-end">
            <button class="btn" id="btnReloadAtt">ØªØ­Ø¯ÙŠØ«</button>
            <button class="btn primary" id="btnExportExcel">ØªØµØ¯ÙŠØ± Excel</button>
            <button class="btn" id="btnExportPdf">ØªØµØ¯ÙŠØ± PDF</button>
          </div>
        </div>

        <div class="toolbar">
          <div class="left">
            <label class="mini">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
            <input type="date" id="fDate">
            <label class="mini">Ø§Ù„ÙØ±Ø¹</label>
            <select id="fBranch"></select>
          </div>
          <div class="right">
            <span class="badge ok">ğŸ‘¤ Ø­Ø¶Ø±: <b id="kPresent" style="margin-inline-start:6px">0</b></span>
            <span class="badge warn">â° Ù…ØªØ£Ø®Ø±: <b id="kLate" style="margin-inline-start:6px">0</b></span>
            <span class="badge bad">âŒ ØºØ§ÙŠØ¨: <b id="kAbsent" style="margin-inline-start:6px">0</b></span>
            <span class="badge ok">âœ… Ø¥Ø¬Ø§Ø²Ø©: <b id="kLeaveDay" style="margin-inline-start:6px">0</b></span>
          </div>
        </div>

        <div id="msgAtt" class="msg"></div>

        <div class="tableWrap" style="margin-top:12px">
          <table>
            <thead>
              <tr>
                <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                <th>Ø§Ù„ÙØ±Ø¹</th>
                <th>Ø§Ù„Ø´ÙØª</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th class="timeCell">Check-In</th>
                <th class="timeCell">Check-Out</th>
                <th>Late</th>
                <th>Worked</th>
              </tr>
            </thead>
            <tbody id="attTbody"></tbody>
          </table>
        </div>
      </div>

      <!-- Corrections -->
      <div class="card">
        <div class="split">
          <div>
            <h2 style="margin:0 0 6px">Ø·Ù„Ø¨Ø§Øª ØªØµØ­ÙŠØ­ Ø§Ù„Ø­Ø¶ÙˆØ±</h2>
            <div class="mini"></div>
          </div>
          <div class="row" style="justify-content:flex-end">
            <button class="btn" id="btnReloadFix">ØªØ­Ø¯ÙŠØ«</button>
          </div>
        </div>

        <div class="toolbar">
          <div class="left">
            <span class="chip">
              <input id="onlyPending" type="checkbox" style="min-height:auto; width:18px; height:18px; margin:0">
              <label for="onlyPending" style="cursor:pointer">Ø¹Ø±Ø¶ ÙÙ‚Ø· Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Pending)</label>
            </span>

            <label class="mini">Ø­Ø¬Ù… Ø§Ù„ØµÙØ­Ø©</label>
            <select id="pageSizeSel">
              <option value="15">15</option>
              <option value="25" selected>25</option>
              <option value="50">50</option>
            </select>

            <span class="badge info" id="pageInfo">ØµÙØ­Ø©: 1</span>
          </div>

          <div class="right">
            <button class="btn" id="btnPrev">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
            <button class="btn primary" id="btnNext">Ø§Ù„ØªØ§Ù„ÙŠ</button>
          </div>
        </div>

        <div class="kpi" style="margin-top:10px">
          <div class="box"><div class="mini">Ø¶Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©: Pending</div><b id="kPagePending">0</b></div>
          <div class="box"><div class="mini">Ø¶Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©: Approved</div><b id="kPageApplied">0</b></div>
          <div class="box"><div class="mini">Ø¶Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©: Rejected</div><b id="kPageRejected">0</b></div>
          <div class="box"><div class="mini">Top ÙØ±Ø¹ (Ø¢Ø®Ø± 500)</div><b id="kTopBranch">-</b></div>
        </div>

        <div id="branchesStats" class="mini" style="margin-top:10px"></div>
        <div id="msgFix" class="msg"></div>

        <div class="tableWrap" style="margin-top:12px">
          <table>
            <thead>
              <tr>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                <th>Ø§Ù„ÙØ±Ø¹</th>
                <th class="timeCell">Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th style="width:170px">Ø¥Ø¬Ø±Ø§Ø¡</th>
              </tr>
            </thead>
            <tbody id="fixTbody"></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <!-- Modal -->
  <div class="modalBackdrop" id="editModal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
      <div class="modalHead">
        <div>
          <b id="editTitle">ØªØ¹Ø¯ÙŠÙ„ Ø·Ù„Ø¨ ØªØµØ­ÙŠØ­ Ø§Ù„Ø­Ø¶ÙˆØ±</b>
          <div class="hint" id="editSub">â€”</div>
        </div>
        <button class="btn" id="btnCloseModal">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>

      <div class="modalBody">
        <div class="chipsLine" id="mSummary" style="margin-bottom:12px"></div>

        <div class="modalGrid">
          <div class="field">
            <label>Ù‚Ø±Ø§Ø± Ø§Ù„Ø£Ø¯Ù…Ù†: Ø§Ù„Ø­Ø§Ù„Ø©</label>
            <select id="mStatus">
              <option value="pending">Pending (Ø¬Ø¯ÙŠØ¯)</option>
              <option value="approved">Approved (Ù…ÙˆØ§ÙÙ‚Ø©)</option>
              <option value="rejected">Rejected (Ù…Ø±ÙÙˆØ¶)</option>
            </select>
          </div>

          <div class="field">
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</label>
            <input id="mDate" placeholder="YYYY-MM-DD">
          </div>

          <div class="field">
            <label>ÙˆÙ‚Øª Ø¯Ø®ÙˆÙ„ Ø¬Ø¯ÙŠØ¯</label>
            <input id="mNewInHM" type="time" step="60">
            <div class="hint"></div>
          </div>

          <div class="field">
            <label>ÙˆÙ‚Øª Ø®Ø±ÙˆØ¬ Ø¬Ø¯ÙŠØ¯</label>
            <input id="mNewOutHM" type="time" step="60">
            <div class="hint"></div>
          </div>

          <div class="field" style="grid-column:1/-1">
            <label>Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ù…ÙˆØ¸Ù (Ø³Ø¨Ø¨ Ø§Ù„ØªØµØ­ÙŠØ­)</label>
            <textarea id="mEmployeeNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø·Ù„Ø¨/Ø³Ø¨Ø¨ Ø§Ù„ØªØµØ­ÙŠØ­..."></textarea>
          </div>

          <div class="field" style="grid-column:1/-1">
            <label>Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø£Ø¯Ù…Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <textarea id="mAdminNote" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø© Ø¯Ø§Ø®Ù„ÙŠØ© Ù„Ù„Ø£Ø¯Ù…Ù†..."></textarea>
            <div class="hint"></div>
          </div>
        </div>

        <div class="hint" id="mHint" style="margin-top:10px"></div>
      </div>

      <div class="modalFoot">
        <button class="btn danger" id="btnRejectQuick">Ø±ÙØ¶</button>
        <button class="btn" id="btnSaveDraft">Ø­ÙØ¸</button>
        <button class="btn primary" id="btnSaveApply">Ù…ÙˆØ§ÙÙ‚Ø© + ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc,
      collection, getDocs, query, where,
      orderBy, limit, startAfter, endBefore, limitToLast,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN88FY9CJU8T8cm5lLYjcI-I8VmD46o40",
      authDomain: "roma-schedule.firebaseapp.com",
      projectId: "roma-schedule",
      storageBucket: "roma-schedule.firebasestorage.app",
      messagingSenderId: "685810932602",
      appId: "1:685810932602:web:f1ec506ea6ff5e919d94c3",
      measurementId: "G-5FY5S5TZLJ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id)=>document.getElementById(id);
    const setMsg = (id, text, type="ok")=>{
      const el = $(id);
      if(!el) return;
      el.className = "msg " + (type==="bad"?"bad":"ok");
      el.textContent = text;
      el.style.display = "block";
    };

    async function requireAdmin(user){
      const snap = await getDoc(doc(db,"employees",user.uid));
      return snap.exists() && snap.data()?.role === "admin";
    }

    function ymd(d){
      const dt = new Date(d);
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,"0");
      const da = String(dt.getDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    }

    function timeToMin(t){
      const s = String(t||"").trim();
      const m = /^(\d{1,2}):(\d{2})$/.exec(s);
      if(!m) return null;
      const hh = Math.max(0, Math.min(23, Number(m[1])));
      const mm = Math.max(0, Math.min(59, Number(m[2])));
      return hh*60+mm;
    }

    function safeId(s){
      return String(s||"").replace(/[^a-zA-Z0-9_-]/g,"_").slice(0,240);
    }

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"]/g, (c)=>({
        "&":"&amp;",
        "<":"&lt;",
        ">":"&gt;",
        "\"":"&quot;"
      }[c]));
    }

    function fmtTime(ms){
      if(!ms) return "-";
      try{
        return new Date(ms).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
      }catch{ return "-"; }
    }

    function normalizeEmailToPresetId(email){
      const e = String(email||"").trim().toLowerCase();
      if(!e) return null;
      return "preset:" + e.replace(/\./g,"(dot)");
    }

    function employeeKeyFromAny(employeeId, employeeEmail){
      const id = String(employeeId||"");
      if(id.startsWith("preset:")) return id;
      const byEmail = normalizeEmailToPresetId(employeeEmail);
      return byEmail || (id || "");
    }

    async function loadBranchSelect(){
      const snap = await getDocs(collection(db,"branches"));
      const rows = [];
      snap.forEach(d=> rows.push({ id:d.id, ...(d.data()||{}) }));
      rows.sort((a,b)=> (a.name||a.id||"").localeCompare(b.name||b.id||""));

      const sel = $("fBranch");
      sel.innerHTML =
        `<option value="">â€” ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹ â€”</option>` +
        rows.map(b=> `<option value="${escapeHtml(b.id)}">${escapeHtml(b.name||b.id)} (${escapeHtml(b.id)})</option>`).join("");

      return rows;
    }

    async function loadEmployees(){
      const snap = await getDocs(collection(db,"employees"));
      const out=[];
      snap.forEach(d=> out.push({ id:d.id, ...(d.data()||{}) }));
      return out;
    }

    async function loadLeavesApproved(){
      const snap = await getDocs(collection(db,"leaves"));
      const out=[];
      snap.forEach(d=>{
        const x = d.data() || {};
        if(String(x.status||"").toLowerCase() !== "approved") return;
        if(!x.employeeId) return;
        out.push({ __id:d.id, ...x });
      });
      return out;
    }

    function leaveDaysSet(leave){
      const mode = leave.leaveMode || "range";
      const set = new Set();
      if(mode==="scattered" && Array.isArray(leave.dates)){
        leave.dates.forEach(d=>{
          if(typeof d==="string" && /^\d{4}-\d{2}-\d{2}$/.test(d)) set.add(d);
        });
        return set;
      }
      if(leave.from && leave.to){
        const a=new Date(leave.from+"T12:00:00"), b=new Date(leave.to+"T12:00:00");
        for(let d=new Date(a); d<=b; d.setDate(d.getDate()+1)){
          set.add(ymd(d));
        }
      }
      return set;
    }

    function isOnLeave(leaves, employeeId, dateStr){
      for(const l of leaves){
        if(String(l.employeeId) !== String(employeeId)) continue;
        const days = leaveDaysSet(l);
        if(days.has(dateStr)) return true;
      }
      return false;
    }

    function nowMin(){
      const d=new Date();
      return d.getHours()*60 + d.getMinutes();
    }

    async function markAutoAbsencesForDate(dateStr){
      const shiftsSnap = await getDocs(collection(db,"shifts"));
      const shifts = [];
      shiftsSnap.forEach(d=>{
        const x = d.data() || {};
        if(x.date !== dateStr) return;
        if(!x.employeeId) return;
        shifts.push({ id:d.id, ...x });
      });

      const leaves = await loadLeavesApproved();

      const attSnap = await getDocs(collection(db,"attendance"));
      const attByKey = new Map();

      attSnap.forEach(d=>{
        const x = d.data() || {};
        if(x.date !== dateStr) return;

        const empKey = employeeKeyFromAny(x.employeeId, x.employeeEmail);
        if(!empKey) return;

        const k = `${empKey}__${x.date}__${x.branchId||""}__${x.shiftName||""}__${x.start||""}`;
        attByKey.set(k, { id:d.id, ...x });
      });

      let checked = 0;
      let marked = 0;

      for(const s of shifts){
        checked++;

        const endMin = timeToMin(s.end);
        const ended = (endMin===null) ? false : (nowMin() >= endMin);
        if(!ended) continue;

        const empKey = employeeKeyFromAny(s.employeeId, s.employeeEmail);
        const k = `${empKey}__${s.date}__${s.branchId||""}__${s.shiftName||""}__${s.start||""}`;
        const hasAttendance = attByKey.has(k);

        const onLeave = isOnLeave(leaves, empKey, dateStr);
        const attId = safeId(k);

        if(onLeave){
          if(!hasAttendance){
            await setDoc(doc(db,"attendance", attId), {
              employeeId: empKey,
              employeeName: s.employeeName || "",
              employeeEmail: s.employeeEmail || "",
              date: s.date,
              branchId: s.branchId || "",
              branchName: s.branchName || "",
              shiftName: s.shiftName || "",
              start: s.start || "",
              end: s.end || "",
              status: "leave",
              note: "On approved leave",
              updatedAt: serverTimestamp()
            }, { merge:true });
            marked++;
          }
          continue;
        }

        if(!hasAttendance){
          await setDoc(doc(db,"attendance", attId), {
            employeeId: empKey,
            employeeName: s.employeeName || "",
            employeeEmail: s.employeeEmail || "",
            date: s.date,
            branchId: s.branchId || "",
            branchName: s.branchName || "",
            shiftName: s.shiftName || "",
            start: s.start || "",
            end: s.end || "",
            status: "absent",
            minutesLate: null,
            note: "Auto absent (shift ended, no check-in)",
            updatedAt: serverTimestamp()
          }, { merge:true });
          marked++;
        }
      }

      return { checked, marked };
    }

    async function loadAttendanceForDate(dateStr, branchId=""){
      const [attSnap, shiftsSnap, emps, leaves] = await Promise.all([
        getDocs(collection(db,"attendance")),
        getDocs(collection(db,"shifts")),
        loadEmployees(),
        loadLeavesApproved()
      ]);

      const attMap = new Map();
      attSnap.forEach(d=>{
        const x = d.data() || {};
        if(x.date !== dateStr) return;
        if(branchId && String(x.branchId||"") !== String(branchId)) return;

        const empKey = employeeKeyFromAny(x.employeeId, x.employeeEmail);
        if(!empKey) return;

        const k = `${empKey}__${x.date}__${x.branchId||""}__${x.shiftName||""}__${x.start||""}`;
        attMap.set(k, { __id: d.id, ...x, __empKey: empKey });
      });

      const shifts = [];
      shiftsSnap.forEach(d=>{
        const x = d.data() || {};
        if(x.date !== dateStr) return;
        if(branchId && String(x.branchId||"") !== String(branchId)) return;
        if(!x.employeeId) return;
        shifts.push({ __id: d.id, ...x });
      });

      const rows = [];

      for(const s of shifts){
        const empKey = employeeKeyFromAny(s.employeeId, s.employeeEmail);
        const k = `${empKey}__${s.date}__${s.branchId||""}__${s.shiftName||""}__${s.start||""}`;
        const a = attMap.get(k);

        if(a){
          rows.push({ ...a });
        }else{
          const onLeave = isOnLeave(leaves, empKey, dateStr);
          const empNameFallback =
            s.employeeName ||
            (emps.find(e=> String(e.id)===String(s.employeeId))?.name || "");

          rows.push({
            employeeId: empKey,
            employeeName: empNameFallback || s.employeeName || "",
            employeeEmail: s.employeeEmail || "",
            date: s.date,
            branchId: s.branchId || "",
            branchName: s.branchName || "",
            shiftName: s.shiftName || "",
            start: s.start || "",
            end: s.end || "",
            status: onLeave ? "leave" : "absent",
            note: onLeave ? "Leave (no attendance record)" : "Absent (no attendance record)"
          });
        }
      }

      rows.sort((a,b)=>{
        const an = (a.branchName||a.branchId||"");
        const bn = (b.branchName||b.branchId||"");
        if(an!==bn) return an.localeCompare(bn);
        const ae = (a.employeeName||a.employeeEmail||"");
        const be = (b.employeeName||b.employeeEmail||"");
        return ae.localeCompare(be);
      });

      let present=0, late=0, absent=0, leaveDay=0;
      for(const r of rows){
        const st = String(r.status||"").toLowerCase();
        if(st==="leave"){ leaveDay++; continue; }
        if(st==="absent"){ absent++; continue; }
        if(st==="completed" || st==="present"){
          present++;
          if(Number(r.minutesLate||0)>0) late++;
        }
      }

      $("kPresent").textContent = present;
      $("kLate").textContent = late;
      $("kAbsent").textContent = absent;
      $("kLeaveDay").textContent = leaveDay;

      const tb = $("attTbody");
      tb.innerHTML = "";

      for(const r of rows){
        const st = String(r.status||"").toLowerCase();
        const badge =
          st==="leave" ? `<span class="badge ok">âœ… Ø¥Ø¬Ø§Ø²Ø©</span>` :
          st==="absent" ? `<span class="badge bad">âŒ ØºÙŠØ§Ø¨</span>` :
          (Number(r.minutesLate||0)>0 ? `<span class="badge warn">â° Ù…ØªØ£Ø®Ø±</span>` : `<span class="badge ok">ğŸ‘¤ Ø­Ø¶Ø±</span>`);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(r.employeeName || r.employeeEmail || r.employeeId || "-")}</td>
          <td>${escapeHtml(r.branchName || r.branchId || "-")}</td>
          <td>${escapeHtml(r.shiftName || "-")} <span class="badge">${escapeHtml((r.start&&r.end)?(r.start+"-"+r.end):"")}</span></td>
          <td>${badge}</td>
          <td class="timeCell">${fmtTime(r.checkInAtLocal)}</td>
          <td class="timeCell">${fmtTime(r.checkOutAtLocal)}</td>
          <td>${r.minutesLate!=null ? `${escapeHtml(r.minutesLate)}Ø¯` : "-"}</td>
          <td>${r.workedMinutes!=null ? `${escapeHtml(r.workedMinutes)}Ø¯` : "-"}</td>
        `;
        tb.appendChild(tr);
      }

      window.__attRows = rows;
      window.__attDate = dateStr;
      window.__attBranchId = branchId || "";
    }

    async function exportAttendanceExcel(){
      const rows = window.__attRows || [];
      if(!rows.length) return setMsg("msgAtt","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±.","bad");
      const XLSX = window.XLSX;
      if(!XLSX) return setMsg("msgAtt","Ù…ÙƒØªØ¨Ø© Excel ØºÙŠØ± Ù…Ø­Ù…Ù‘Ù„Ø©.","bad");

      const headers = ["Ø§Ù„ØªØ§Ø±ÙŠØ®","Ø§Ù„Ù…ÙˆØ¸Ù","Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„","Ø§Ù„ÙØ±Ø¹","Ø§Ù„Ø´ÙØª","Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©","Ø§Ù„Ù†Ù‡Ø§ÙŠØ©","Ø§Ù„Ø­Ø§Ù„Ø©","CheckIn(ms)","CheckOut(ms)","Late(min)","Worked(min)","Ù…Ù„Ø§Ø­Ø¸Ø©"];
      const data = rows.map(r=>[
        r.date || "",
        r.employeeName || "",
        r.employeeEmail || "",
        r.branchName || r.branchId || "",
        r.shiftName || "",
        r.start || "",
        r.end || "",
        (r.status || ""),
        r.checkInAtLocal || "",
        r.checkOutAtLocal || "",
        r.minutesLate || "",
        r.workedMinutes || "",
        r.note || ""
      ]);

      const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);

      for(let c=0; c<headers.length; c++){
        const addr = XLSX.utils.encode_cell({ r:0, c });
        if(ws[addr]) ws[addr].s = {
          font: { bold:true, color:{ rgb:"FFFFFFFF" } },
          fill: { patternType:"solid", fgColor:{ rgb:"FF111827" } },
          alignment: { horizontal:"center", vertical:"center" },
          border: {
            top:{style:"thin",color:{rgb:"FF374151"}},
            bottom:{style:"thin",color:{rgb:"FF374151"}},
            left:{style:"thin",color:{rgb:"FF374151"}},
            right:{style:"thin",color:{rgb:"FF374151"}},
          }
        };
      }

      ws["!cols"] = headers.map(()=>({ wch: 18 }));

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Attendance");

      const date = window.__attDate || "date";
      const br = window.__attBranchId || "all";
      XLSX.writeFile(wb, `attendance_${br}_${date}.xlsx`);
      setMsg("msgAtt","ØªÙ… ØªØµØ¯ÙŠØ± Excel âœ…","ok");
    }

    function exportAttendancePdf(){
      const rows = window.__attRows || [];
      if(!rows.length) return setMsg("msgAtt","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±.","bad");

      const date = window.__attDate || "";
      const br = window.__attBranchId || "";
      const title = "ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ± â€” " + date + (br ? " (" + br + ")" : "");

      const html = `
        <html lang="ar" dir="rtl">
        <head>
          <meta charset="utf-8"/>
          <title>${title}</title>
          <style>
            body{font-family:system-ui, Tahoma, Arial; padding:16px}
            h1{margin:0 0 12px; font-size:18px}
            table{width:100%; border-collapse:collapse}
            th,td{border:1px solid #ddd; padding:8px; font-size:12px; text-align:right}
            th{background:#f5f5f5}
          </style>
        </head>
        <body>
          <h1>${title}</h1>
          <table>
            <thead>
              <tr>
                <th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„ÙØ±Ø¹</th><th>Ø§Ù„Ø´ÙØª</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¯Ø®ÙˆÙ„</th><th>Ø®Ø±ÙˆØ¬</th><th>Late</th><th>Worked</th>
              </tr>
            </thead>
            <tbody>
              ${rows.map(r=>`
                <tr>
                  <td>${escapeHtml(r.employeeName||r.employeeEmail||r.employeeId||'')}</td>
                  <td>${escapeHtml(r.branchName||r.branchId||'')}</td>
                  <td>${escapeHtml(r.shiftName||'')} ${escapeHtml((r.start && r.end) ? ("(" + r.start + "-" + r.end + ")") : "")}</td>
                  <td>${escapeHtml(r.status||'')}</td>
                  <td>${escapeHtml(fmtTime(r.checkInAtLocal))}</td>
                  <td>${escapeHtml(fmtTime(r.checkOutAtLocal))}</td>
                  <td>${escapeHtml(r.minutesLate ?? '')}</td>
                  <td>${escapeHtml(r.workedMinutes ?? '')}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </body>
        </html>
      `;

      const w = window.open('', '_blank');
      if(!w) return setMsg("msgAtt","Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù†Ø¹ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©.","bad");
      w.document.open();
      w.document.write(html);
      w.document.close();
      setMsg("msgAtt","ØªÙ… ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© âœ… (Ø§Ø®ØªØ± Save as PDF)","ok");
    }

    function buildAttendanceDocIdFromCorrection(c){
      const empKey = employeeKeyFromAny(c.employeeId, c.employeeEmail);
      const date = c.date || c.shiftDate || "";
      const branchId = c.branchId || "";
      const shiftName = c.shiftName || c.shift || "";
      const start = c.start || c.shiftStart || "";
      if(!empKey || !date || !branchId || !shiftName || !start) return null;
      return safeId(`${empKey}__${date}__${branchId}__${shiftName}__${start}`);
    }

    function calcMinutesLateAndWorked(startStr, checkInMs, checkOutMs){
      const startMin = timeToMin(startStr);
      let minutesLate = null;
      if(startMin!=null && checkInMs){
        const d = new Date(checkInMs);
        const inMin = d.getHours()*60 + d.getMinutes();
        minutesLate = Math.max(0, inMin - startMin);
      }
      let workedMinutes = null;
      if(checkInMs && checkOutMs && Number(checkOutMs) > Number(checkInMs)){
        workedMinutes = Math.floor((Number(checkOutMs)-Number(checkInMs))/60000);
      }
      return { minutesLate, workedMinutes };
    }

    /* =========================================================
       âœ… FIX: find the REAL attendance docId (even if auto-id)
       ========================================================= */
    async function findAttendanceDocIdSmart({ empKey, date, branchId, shiftName, start }){
      const snap = await getDocs(collection(db,"attendance"));
      let foundId = null;

      snap.forEach(d=>{
        const x = d.data() || {};
        if(String(x.date||"") !== String(date||"")) return;

        const kEmp = employeeKeyFromAny(x.employeeId, x.employeeEmail);
        if(String(kEmp||"") !== String(empKey||"")) return;

        if(String(x.branchId||"") !== String(branchId||"")) return;
        if(String(x.shiftName||"") !== String(shiftName||"")) return;
        if(String(x.start||"") !== String(start||"")) return;

        if(!foundId) foundId = d.id;
      });

      return foundId;
    }

    // âœ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµØ­ÙŠØ­ (Ù…ÙØµÙ„Ø­: ÙŠØ¹Ø¯Ù‘Ù„ Ù†ÙØ³ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ)
    async function applyCorrection(correctionId, mode){
      const cRef = doc(db,"attendance_corrections", correctionId);
      const cSnap = await getDoc(cRef);
      if(!cSnap.exists()) throw new Error("Ø·Ù„Ø¨ Ø§Ù„ØªØµØ­ÙŠØ­ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");
      const c = { __id: correctionId, ...(cSnap.data()||{}) };

      const empKey = employeeKeyFromAny(c.employeeId, c.employeeEmail);
      const date = c.date || c.shiftDate || "";
      const branchId = c.branchId || "";
      const shiftName = c.shiftName || c.shift || "";
      const start = c.start || c.shiftStart || "";
      const end = c.end || "";

      if(!empKey || !date || !branchId || !shiftName || !start){
        throw new Error("Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø¨ Ø§Ù„ØªØµØ­ÙŠØ­ Ù†Ø§Ù‚ØµØ© (employee/date/branch/shift/start).");
      }

      if(mode === "rollback"){
        const rb = c.rollbackData || null;
        if(!rb) throw new Error("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Rollback Ù…Ø®Ø²Ù‘Ù†Ø© (Ù„Ù… ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚Ù‡ Ø³Ø§Ø¨Ù‚Ø§Ù‹).");

        const existingId = await findAttendanceDocIdSmart({ empKey, date, branchId, shiftName, start });
        const attId = existingId || safeId(`${empKey}__${date}__${branchId}__${shiftName}__${start}`);
        const aRef = doc(db,"attendance", attId);

        await setDoc(aRef, { ...rb, updatedAt: serverTimestamp() }, { merge:true });

        await updateDoc(cRef, {
          status: "approved",
          rolledBackAt: serverTimestamp(),
          rolledBackBy: auth.currentUser?.uid || null,
          appliedAttendanceId: attId
        });
        return "ØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹ (Rollback) âœ…";
      }

      const newIn  = c.newCheckInAtLocal ?? c.newCheckIn ?? c.checkInAtLocalNew ?? null;
      const newOut = c.newCheckOutAtLocal ?? c.newCheckOut ?? c.checkOutAtLocalNew ?? null;

      if(!newIn && !newOut){
        throw new Error("Ø§Ù„Ø·Ù„Ø¨ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ ÙˆÙ‚Øª Ø¯Ø®ÙˆÙ„/Ø®Ø±ÙˆØ¬ Ø¬Ø¯ÙŠØ¯.");
      }

      const existingId = await findAttendanceDocIdSmart({ empKey, date, branchId, shiftName, start });
      const attId = existingId || safeId(`${empKey}__${date}__${branchId}__${shiftName}__${start}`);
      const aRef = doc(db,"attendance", attId);

      const aSnap = await getDoc(aRef);
      const old = aSnap.exists() ? (aSnap.data()||{}) : {};

      const alreadySnap = !!c.rollbackData;
      if(!alreadySnap){
        await updateDoc(cRef, {
          rollbackData: {
            checkInAtLocal: old.checkInAtLocal ?? null,
            checkOutAtLocal: old.checkOutAtLocal ?? null,
            minutesLate: old.minutesLate ?? null,
            workedMinutes: old.workedMinutes ?? null,
            status: old.status ?? null,
            note: old.note ?? null
          }
        });
      }

      const inMs  = newIn  ?? old.checkInAtLocal  ?? null;
      const outMs = newOut ?? old.checkOutAtLocal ?? null;

      const { minutesLate, workedMinutes } = calcMinutesLateAndWorked(start || old.start || "", inMs, outMs);
      const status = (outMs ? "completed" : (inMs ? "present" : (old.status || "pending")));

      await setDoc(aRef, {
        employeeId: empKey,
        employeeName: c.employeeName || old.employeeName || "",
        employeeEmail: c.employeeEmail || old.employeeEmail || "",
        date,
        branchId,
        branchName: c.branchName || old.branchName || "",
        shiftName,
        start,
        end: end || old.end || "",
        checkInAtLocal:  (newIn!=null ? Number(newIn) : old.checkInAtLocal ?? null),
        checkOutAtLocal: (newOut!=null ? Number(newOut) : old.checkOutAtLocal ?? null),
        minutesLate,
        workedMinutes,
        status,
        note: c.note || old.note || "",
        updatedAt: serverTimestamp()
      }, { merge:true });

      await updateDoc(cRef, {
        appliedAt: serverTimestamp(),
        appliedBy: auth.currentUser?.uid || null,
        status: "approved",
        appliedAttendanceId: attId
      });

      return "ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© + Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ âœ…";
    }

    const FIX = {
      page: 1,
      size: 25,
      onlyPending: false,
      lastDoc: null,
      firstDoc: null,
      rows: [],
      busy: false,
    };

    function badgeForStatus(row){
      const st = String(row?.status || "pending").toLowerCase();
      const isApplied = !!row?.appliedAt;

      if(st==="approved"){
        return isApplied
          ? `<span class="badge ok">ğŸŸ© Approved â€¢ ØªÙ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</span>`
          : `<span class="badge ok">âœ… Approved</span>`;
      }
      if(st==="rejected") return `<span class="badge bad">ğŸŸ¥ Rejected</span>`;
      return `<span class="badge warn">ğŸŸ§ Pending</span>`;
    }

    function updatePageInfo(){
      $("pageInfo").textContent = `ØµÙØ­Ø©: ${FIX.page} â€” ${FIX.size} / ØµÙØ­Ø©`;
      $("btnPrev").disabled = (FIX.page<=1 || FIX.busy);
      $("btnNext").disabled = FIX.busy;
    }

    async function loadBranchStatsLast500(){
      try{
        const q0 = query(collection(db,"attendance_corrections"), orderBy("createdAt","desc"), limit(500));
        const snap = await getDocs(q0);
        const counts = new Map();
        snap.forEach(d=>{
          const x = d.data() || {};
          const key = String(x.branchName || x.branchId || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯");
          counts.set(key, (counts.get(key)||0) + 1);
        });

        const arr = [...counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,6);
        if(!arr.length){
          $("kTopBranch").textContent = "-";
          $("branchesStats").textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØ±ÙˆØ¹.";
          return;
        }

        $("kTopBranch").textContent = `${arr[0][0]} (${arr[0][1]})`;

        const line = arr.map(([k,v],i)=> `${i+1}) ${k}: ${v}`).join("  â€¢  ");
        $("branchesStats").textContent = "Ø£ÙƒØ«Ø± Ø§Ù„ÙØ±ÙˆØ¹ Ø·Ù„Ø¨Ø§Ù‹ Ù„Ù„ØªØµØ­ÙŠØ­ (Ø¢Ø®Ø± 500): " + line;
      }catch(e){
        $("kTopBranch").textContent = "-";
        $("branchesStats").textContent = "ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØ±ÙˆØ¹ Ø­Ø§Ù„ÙŠØ§Ù‹.";
      }
    }

    function countPageKpis(rows){
      let pending=0, approved=0, rejected=0;
      for(const r of rows){
        const st = String(r.status||"pending").toLowerCase();
        if(st==="pending") pending++;
        else if(st==="approved") approved++;
        else if(st==="rejected") rejected++;
      }
      $("kPagePending").textContent = pending;
      $("kPageApplied").textContent = approved;
      $("kPageRejected").textContent = rejected;
    }

    function closeModal(){
      $("editModal").style.display = "none";
      window.__editingCorrection = null;
    }
    function openModal(){
      $("editModal").style.display = "flex";
      $("mHint").textContent = "";
    }

    function hmToMs(dateStr, hm){
      const m = /^(\d{1,2}):(\d{2})$/.exec(String(hm||"").trim());
      if(!m) return null;
      if(!/^\d{4}-\d{2}-\d{2}$/.test(String(dateStr||""))) return null;
      const hh = Math.max(0, Math.min(23, Number(m[1])));
      const mm = Math.max(0, Math.min(59, Number(m[2])));
      const dt = new Date(`${dateStr}T00:00:00`);
      dt.setHours(hh, mm, 0, 0);
      return dt.getTime();
    }

    function msToHM(ms){
      if(!ms) return "";
      try{
        const d=new Date(ms);
        const hh=String(d.getHours()).padStart(2,"0");
        const mm=String(d.getMinutes()).padStart(2,"0");
        return `${hh}:${mm}`;
      }catch{return "";}
    }

    function fillModal(r){
      window.__editingCorrection = r;

      const date = r.date || r.shiftDate || "-";
      const emp = r.employeeName || r.employeeEmail || r.employeeId || "-";
      const br  = r.branchName || r.branchId || "-";
      const sh  = r.shiftName || r.shift || "-";
      const st  = (r.start || r.shiftStart || "");
      const en  = (r.end || "");
      const timeRange = (st && en) ? `${st}-${en}` : (st ? st : "-");

      $("editSub").textContent = `ID: ${r.__id}`;

      const rawStatus = String(r.status||"pending").toLowerCase();
      const uiStatus = (rawStatus==="applied" || rawStatus==="rolled_back") ? "approved" : rawStatus;
      $("mStatus").value = (uiStatus==="approved" || uiStatus==="rejected" || uiStatus==="pending") ? uiStatus : "pending";

      $("mDate").value = (r.date || r.shiftDate || "");

      const inMs  = (r.newCheckInAtLocal ?? r.newCheckIn ?? null);
      const outMs = (r.newCheckOutAtLocal ?? r.newCheckOut ?? null);

      $("mNewInHM").value = inMs ? msToHM(inMs) : "";
      $("mNewOutHM").value = outMs ? msToHM(outMs) : "";

      $("mEmployeeNote").value = r.note || "";
      $("mAdminNote").value = r.adminNote || "";

      const summary = $("mSummary");
      summary.innerHTML = `
        <span class="chip"><span class="mini">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span> <b>${escapeHtml(date)}</b></span>
        <span class="chip"><span class="mini">Ø§Ù„Ù…ÙˆØ¸Ù:</span> <b>${escapeHtml(emp)}</b></span>
        <span class="chip"><span class="mini">Ø§Ù„ÙØ±Ø¹:</span> <b>${escapeHtml(br)}</b></span>
        <span class="chip"><span class="mini">Ø§Ù„Ø´ÙØª:</span> <b>${escapeHtml(sh)}</b></span>
        <span class="chip"><span class="mini">Ø§Ù„ÙˆÙ‚Øª:</span> <b>${escapeHtml(timeRange)}</b></span>
      `;
    }

    async function saveCorrectionEdits({ alsoApply=false, forceReject=false }={}){
      const r = window.__editingCorrection;
      if(!r) return;

      const id = r.__id;
      const ref = doc(db,"attendance_corrections", id);

      const dateStr = String($("mDate").value||"").trim();
      if(dateStr && !/^\d{4}-\d{2}-\d{2}$/.test(dateStr)){
        throw new Error("Ø§Ù„ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­. Ø§Ø³ØªØ®Ø¯Ù… YYYY-MM-DD.");
      }

      const newInHM = String($("mNewInHM").value||"").trim();
      const newOutHM = String($("mNewOutHM").value||"").trim();

      let status = forceReject ? "rejected" : String($("mStatus").value||"pending").toLowerCase();
      if(alsoApply) status = "approved";
      if(status!=="pending" && status!=="approved" && status!=="rejected") status = "pending";

      const baseDate = dateStr || (r.date||r.shiftDate||"");
      const inMs  = newInHM ? hmToMs(baseDate, newInHM) : null;
      const outMs = newOutHM ? hmToMs(baseDate, newOutHM) : null;

      if(newInHM && inMs==null) throw new Error("ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­.");
      if(newOutHM && outMs==null) throw new Error("ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬ ØºÙŠØ± ØµØ­ÙŠØ­.");

      const patch = {
        status,
        date: baseDate,
        updatedAt: serverTimestamp()
      };

      if(newInHM !== "") patch.newCheckInAtLocal = inMs;
      if(newOutHM !== "") patch.newCheckOutAtLocal = outMs;

      patch.note = String($("mEmployeeNote").value||"").trim();

      const adminNote = String($("mAdminNote").value||"").trim();
      if(adminNote) patch.adminNote = adminNote;

      await updateDoc(ref, patch);

      if(alsoApply){
        const snap = await getDoc(ref);
        const fresh = snap.exists() ? ({ __id:id, ...(snap.data()||{}) }) : ({ __id:id, ...r });

        const hasNewIn = fresh.newCheckInAtLocal ?? fresh.newCheckIn ?? null;
        const hasNewOut = fresh.newCheckOutAtLocal ?? fresh.newCheckOut ?? null;

        if(!hasNewIn && !hasNewOut){
          throw new Error("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆÙ‚Øª Ø¯Ø®ÙˆÙ„/Ø®Ø±ÙˆØ¬ Ø¬Ø¯ÙŠØ¯ Ù„ØªØ·Ø¨ÙŠÙ‚Ù‡ Ø¹Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±.");
        }

        await applyCorrection(id, "approve_apply");
      }

      setMsg("msgFix", alsoApply ? "ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ + Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ âœ…" : "ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ âœ…", "ok");
    }

    function wantedCompact(r){
      const inMs  = (r.newCheckInAtLocal ?? r.newCheckIn ?? null);
      const outMs = (r.newCheckOutAtLocal ?? r.newCheckOut ?? null);
      const parts = [];
      if(inMs) parts.push(`Ø¯Ø®ÙˆÙ„ ${fmtTime(inMs)}`);
      if(outMs) parts.push(`Ø®Ø±ÙˆØ¬ ${fmtTime(outMs)}`);
      const line = parts.join(" â€¢ ");
      return line || (r.note ? String(r.note).slice(0,60) : "-");
    }

    async function loadCorrectionsPage({ direction="first" }={}){
      if(FIX.busy) return;
      FIX.busy = true;
      updatePageInfo();

      try{
        const size = FIX.size;

        let q1 = null;

        if(direction==="next" && FIX.lastDoc){
          q1 = query(
            collection(db,"attendance_corrections"),
            orderBy("createdAt","desc"),
            startAfter(FIX.lastDoc),
            limit(size)
          );
        }else if(direction==="prev" && FIX.firstDoc){
          q1 = query(
            collection(db,"attendance_corrections"),
            orderBy("createdAt","desc"),
            endBefore(FIX.firstDoc),
            limitToLast(size)
          );
        }else{
          q1 = query(
            collection(db,"attendance_corrections"),
            orderBy("createdAt","desc"),
            limit(size)
          );
        }

        const snap = await getDocs(q1);

        const docs = snap.docs || [];
        let rows = docs.map(d=> ({ __id:d.id, ...(d.data()||{}) }));

        if(FIX.onlyPending){
          rows = rows.filter(r => String(r.status||"pending").toLowerCase() === "pending");
        }

        FIX.rows = rows;
        FIX.firstDoc = docs[0] || null;
        FIX.lastDoc = docs[docs.length-1] || null;

        countPageKpis(rows);

        const tb = $("fixTbody");
        tb.innerHTML = "";

        for(const r of rows){
          const st = String(r.status||"pending").toLowerCase();
          const tr = document.createElement("tr");
          if(st==="pending") tr.classList.add("isPending");

          tr.innerHTML = `
            <td>${escapeHtml(r.date||r.shiftDate||"-")}</td>
            <td title="${escapeHtml(r.employeeEmail||r.employeeId||"")}">${escapeHtml(r.employeeName||r.employeeEmail||r.employeeId||"-")}</td>
            <td title="${escapeHtml(r.branchId||"")}">${escapeHtml(r.branchName||r.branchId||"-")}</td>
            <td class="timeCell">${escapeHtml(wantedCompact(r))}</td>
            <td>${badgeForStatus(r)}</td>
            <td class="actions">
              <button class="btn primary" data-edit="${escapeHtml(r.__id)}">Ø¹Ø±Ø¶ / ØªØ¹Ø¯ÙŠÙ„</button>
            </td>
          `;
          tb.appendChild(tr);
        }

        tb.querySelectorAll("button[data-edit]").forEach(b=>{
          b.addEventListener("click", ()=>{
            const id = b.getAttribute("data-edit");
            const row = FIX.rows.find(x=>x.__id===id);
            if(!row) return;
            fillModal(row);
            openModal();
          });
        });

        setMsg("msgFix", `ØªÙ… ØªØ­Ù…ÙŠÙ„ ${rows.length} Ø·Ù„Ø¨ âœ…`, "ok");
      }catch(e){
        const msg = e?.message || "Ø®Ø·Ø£";
        setMsg("msgFix", msg + "\n\nØ¥Ø°Ø§ Ø¸Ù‡Ø± Ø±Ø§Ø¨Ø· Ø¥Ù†Ø´Ø§Ø¡ Index Ù…Ù† FirebaseØŒ Ø§ÙØªØ­Ù‡ ÙˆØ§Ø¹Ù…Ù„ Create.", "bad");
      }finally{
        FIX.busy = false;
        updatePageInfo();
      }
    }

    $("btnReloadFix").addEventListener("click", async ()=>{
      FIX.page = 1;
      FIX.firstDoc = null;
      FIX.lastDoc = null;
      await loadCorrectionsPage({ direction:"first" });
      await loadBranchStatsLast500();
    });

    $("onlyPending").addEventListener("change", async (e)=>{
      FIX.onlyPending = !!e.target.checked;
      FIX.page = 1;
      FIX.firstDoc = null;
      FIX.lastDoc = null;
      await loadCorrectionsPage({ direction:"first" });
    });

    $("pageSizeSel").addEventListener("change", async (e)=>{
      FIX.size = Number(e.target.value || 25);
      FIX.page = 1;
      FIX.firstDoc = null;
      FIX.lastDoc = null;
      await loadCorrectionsPage({ direction:"first" });
    });

    $("btnNext").addEventListener("click", async ()=>{
      if(FIX.busy) return;
      FIX.page++;
      await loadCorrectionsPage({ direction:"next" });
      updatePageInfo();
    });

    $("btnPrev").addEventListener("click", async ()=>{
      if(FIX.busy) return;
      if(FIX.page<=1) return;
      FIX.page--;
      await loadCorrectionsPage({ direction:"prev" });
      updatePageInfo();
    });

    $("btnCloseModal").addEventListener("click", closeModal);
    $("editModal").addEventListener("click", (e)=>{
      if(e.target === $("editModal")) closeModal();
    });
    window.addEventListener("keydown", (e)=>{
      if(e.key === "Escape") closeModal();
    });

    $("btnRejectQuick").addEventListener("click", async ()=>{
      try{
        await saveCorrectionEdits({ forceReject:true, alsoApply:false });
        closeModal();
        await loadCorrectionsPage({ direction:"first" });
      }catch(e){
        $("mHint").textContent = e?.message || "Ø®Ø·Ø£";
      }
    });

    $("btnSaveDraft").addEventListener("click", async ()=>{
      try{
        await saveCorrectionEdits({ alsoApply:false });
        closeModal();
        await loadCorrectionsPage({ direction:"first" });
      }catch(e){
        $("mHint").textContent = e?.message || "Ø®Ø·Ø£";
      }
    });

    $("btnSaveApply").addEventListener("click", async ()=>{
      try{
        await saveCorrectionEdits({ alsoApply:true });
        closeModal();
        await loadAttendanceForDate($("fDate").value, $("fBranch").value || "");
        await loadCorrectionsPage({ direction:"first" });
      }catch(e){
        $("mHint").textContent = e?.message || "Ø®Ø·Ø£";
      }
    });

    async function doSignOut(){
      await signOut(auth);
      location.href="./login.html";
    }
    $("btnOut2").addEventListener("click", doSignOut);

    async function doMakeAdmin(){
      const user = auth.currentUser;
      if(!user) return;
      await setDoc(doc(db,"employees",user.uid), {
        name: (user.email||"Admin").split("@")[0],
        email: user.email || "",
        role: "admin",
        type: "regular",
        department: "Admin",
        canCover: true,
        active: true,
        createdAt: serverTimestamp()
      }, { merge:true });

      setMsg("msgDash","ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø¯ÙˆØ±Ùƒ Admin âœ… Ø£Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.","ok");
    }
    $("btnMakeAdmin2").addEventListener("click", doMakeAdmin);

    $("btnReloadAtt").addEventListener("click", async ()=>{
      try{
        const date = $("fDate").value;
        const br = $("fBranch").value || "";
        await loadAttendanceForDate(date, br);
        setMsg("msgAtt","ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« âœ…","ok");
      }catch(e){
        setMsg("msgAtt", e?.message || "Ø®Ø·Ø£", "bad");
      }
    });
    $("btnExportExcel").addEventListener("click", exportAttendanceExcel);
    $("btnExportPdf").addEventListener("click", exportAttendancePdf);

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href="./login.html"; return; }

      window.__romaUserText = (user.email || user.uid);
      try{ window.dispatchEvent(new CustomEvent("roma:user", { detail:{ text: window.__romaUserText } })); }catch{}

      const ok = await requireAdmin(user);
      if(!ok){
        const admins = await getDocs(query(collection(db,"employees"), where("role","==","admin")));
        if(admins.size>0){ location.href="./staff.html"; return; }
        setMsg("msgDash","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Admin Ø¨Ø¹Ø¯. Ø§Ø¶ØºØ· (Ø§Ø¬Ø¹Ù„ Admin) Ù„ØªØµØ¨Ø­ Ø£ÙˆÙ„ Ø£Ø¯Ù…Ù†.","bad");
      }

      const [bSnap, eSnap, pSnap, lSnap] = await Promise.all([
        getDocs(collection(db,"branches")),
        getDocs(collection(db,"employees")),
        getDocs(collection(db,"employees_email")),
        getDocs(query(collection(db,"leaves"), where("status","==","pending")))
      ]);

      $("kBranches").textContent = bSnap.size;
      $("kEmployees").textContent = eSnap.size;
      $("kPresets").textContent  = pSnap.size;
      $("kLeaves").textContent   = lSnap.size;

      await loadBranchSelect();
      $("fDate").value = ymd(new Date());

      try{
        const date = $("fDate").value;
        const res = await markAutoAbsencesForDate(date);
        if(res?.marked){
          setMsg("msgAtt", `ØªÙ… ØªØ³Ø¬ÙŠÙ„ ØºÙŠØ§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ: ${res.marked} (Ù…Ù† Ø£ØµÙ„ ${res.checked}) âœ…`, "ok");
        }
      }catch{}

      await loadAttendanceForDate($("fDate").value, "");
      await loadCorrectionsPage({ direction:"first" });
      await loadBranchStatsLast500();
      updatePageInfo();
    });
  </script>
</body>
</html>
